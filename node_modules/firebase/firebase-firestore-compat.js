!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("@firebase/app-compat"),require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app-compat","@firebase/app"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).firebase,e.firebase.INTERNAL.modularAPIs)}(this,function(Em,Tm){"use strict";try{!(function(){function e(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var l,t=e(Em);function n(t){const n=[];let r=0;for(let s=0;s<t.length;s++){let e=t.charCodeAt(s);e<128?n[r++]=e:(e<2048?n[r++]=e>>6|192:(55296==(64512&e)&&s+1<t.length&&56320==(64512&t.charCodeAt(s+1))?(e=65536+((1023&e)<<10)+(1023&t.charCodeAt(++s)),n[r++]=e>>18|240,n[r++]=e>>12&63|128):n[r++]=e>>12|224,n[r++]=e>>6&63|128),n[r++]=63&e|128)}return n}const r={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(n,e){if(!Array.isArray(n))throw Error("encodeByteArray takes an array as a parameter");this.init_();var r=e?this.byteToCharMapWebSafe_:this.byteToCharMap_;const s=[];for(let h=0;h<n.length;h+=3){var i=n[h],a=h+1<n.length,o=a?n[h+1]:0,u=h+2<n.length,c=u?n[h+2]:0;let e=(15&o)<<2|c>>6,t=63&c;u||(t=64,a||(e=64)),s.push(r[i>>2],r[(3&i)<<4|o>>4],r[e],r[t])}return s.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(n(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){const t=[];let n=0,r=0;for(;n<e.length;){var s,i,a=e[n++];a<128?t[r++]=String.fromCharCode(a):191<a&&a<224?(s=e[n++],t[r++]=String.fromCharCode((31&a)<<6|63&s)):239<a&&a<365?(i=((7&a)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536,t[r++]=String.fromCharCode(55296+(i>>10)),t[r++]=String.fromCharCode(56320+(1023&i))):(s=e[n++],i=e[n++],t[r++]=String.fromCharCode((15&a)<<12|(63&s)<<6|63&i))}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();var n=t?this.charToByteMapWebSafe_:this.charToByteMap_;const r=[];for(let u=0;u<e.length;){var s=n[e.charAt(u++)],i=u<e.length?n[e.charAt(u)]:0;++u;var a=u<e.length?n[e.charAt(u)]:64;++u;var o=u<e.length?n[e.charAt(u)]:64;if(++u,null==s||null==i||null==a||null==o)throw new c;r.push(s<<2|i>>4),64!==a&&(r.push(i<<4&240|a>>2),64!==o&&r.push(a<<6&192|o))}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}};class c extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const a=function(e){return e=e,t=n(e),r.encodeByteArray(t,!0).replace(/\./g,"");var t};const s=()=>function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__,i=()=>{if("undefined"!=typeof document){let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(e){return}var t=e&&function(e){try{return r.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null}(e[1]);return t&&JSON.parse(t)}},o=()=>{try{return s()||(()=>{if("undefined"!=typeof process&&void 0!==process.env){var e=process.env.__FIREBASE_DEFAULTS__;return e?JSON.parse(e):void 0}})()||i()}catch(e){return void console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${e}`)}};function u(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function h(){return!function(){var e=null===(e=o())||void 0===e?void 0:e.forceEnvironment;if("node"===e)return 1;if("browser"!==e)try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(e){return}}()&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}class d extends Error{constructor(e,t,n){super(t),this.code=e,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,d.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,f.prototype.create)}}class f{constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e,...t){var r,n=t[0]||{},s=`${this.service}/${e}`,i=this.errors[e],i=i?(r=n,i.replace(m,(e,t)=>{var n=r[t];return null!=n?String(n):`<${t}?>`})):"Error",i=`${this.serviceName}: ${i} (${s}).`;return new d(s,i,n)}}const m=/\{\$([^}]+)}/g;function g(e){return e&&e._delegate?e._delegate:e}class p{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}(Ed=l=l||{})[Ed.DEBUG=0]="DEBUG",Ed[Ed.VERBOSE=1]="VERBOSE",Ed[Ed.INFO=2]="INFO",Ed[Ed.WARN=3]="WARN",Ed[Ed.ERROR=4]="ERROR",Ed[Ed.SILENT=5]="SILENT";const y={debug:l.DEBUG,verbose:l.VERBOSE,info:l.INFO,warn:l.WARN,error:l.ERROR,silent:l.SILENT},v=l.INFO,w={[l.DEBUG]:"log",[l.VERBOSE]:"log",[l.INFO]:"info",[l.WARN]:"warn",[l.ERROR]:"error"},I=(e,t,...n)=>{if(!(t<e.logLevel)){var r=(new Date).toISOString(),s=w[t];if(!s)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[s](`[${r}]  ${e.name}:`,...n)}};var b,E="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},T={},_=E||self;function S(){}function x(e){var t=typeof e;return"array"==(t="object"!=t?t:e?Array.isArray(e)?"array":t:"null")||"object"==t&&"number"==typeof e.length}function D(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}var C="closure_uid_"+(1e9*Math.random()>>>0),A=0;function N(e,t,n){return e.call.apply(e.bind,arguments)}function k(t,n,e){if(!t)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var e=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(e,r),t.apply(n,e)}}return function(){return t.apply(n,arguments)}}function R(e,t,n){return(R=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?N:k).apply(null,arguments)}function L(t){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function M(e,i){function t(){}t.prototype=i.prototype,e.X=i.prototype,e.prototype=new t,(e.prototype.constructor=e).Wb=function(e,t,n){for(var r=Array(arguments.length-2),s=2;s<arguments.length;s++)r[s-2]=arguments[s];return i.prototype[t].apply(e,r)}}function O(){this.s=this.s,this.o=this.o}O.prototype.s=!1,O.prototype.na=function(){var e;!this.s&&(this.s=!0,this.M(),0)&&(e=this,Object.prototype.hasOwnProperty.call(e,C)&&e[C]||(e[C]=++A))},O.prototype.M=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const F=Array.prototype.indexOf?function(e,t){return Array.prototype.indexOf.call(e,t,void 0)}:function(e,t){if("string"==typeof e)return"string"!=typeof t||1!=t.length?-1:e.indexOf(t,0);for(let n=0;n<e.length;n++)if(n in e&&e[n]===t)return n;return-1};function V(t){var n=t.length;if(0<n){const r=Array(n);for(let e=0;e<n;e++)r[e]=t[e];return r}return[]}function P(t){for(let e=1;e<arguments.length;e++){var n=arguments[e];if(x(n)){var r=t.length||0,s=n.length||0;t.length=r+s;for(let e=0;e<s;e++)t[r+e]=n[e]}else t.push(n)}}function B(e,t){this.type=e,this.g=this.target=t,this.defaultPrevented=!1}B.prototype.h=function(){this.defaultPrevented=!0};var q=function(){if(!_.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{_.addEventListener("test",S,t),_.removeEventListener("test",S,t)}catch(e){}return e}();function U(e){return/^[\s\xa0]*$/.test(e)}var G=String.prototype.trim?function(e){return e.trim()}:function(e){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(e)[1]};function j(e,t){return e<t?-1:t<e?1:0}function K(){var e=_.navigator;return(e=e&&e.userAgent)?e:""}function $(e){return-1!=K().indexOf(e)}function z(e){return z[" "](e),e}z[" "]=S;var Q,W=$("Opera"),H=$("Trident")||$("MSIE"),Y=$("Edge"),X=Y||H,J=$("Gecko")&&!(-1!=K().toLowerCase().indexOf("webkit")&&!$("Edge"))&&!($("Trident")||$("MSIE"))&&!$("Edge"),Z=-1!=K().toLowerCase().indexOf("webkit")&&!$("Edge");function ee(){var e=_.document;return e?e.documentMode:void 0}e:{var te="",ne=(ne=K(),J?/rv:([^\);]+)(\)|;)/.exec(ne):Y?/Edge\/([\d\.]+)/.exec(ne):H?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(ne):Z?/WebKit\/(\S+)/.exec(ne):W?/(?:Version)[ \/]?(\S+)/.exec(ne):void 0);if(ne&&(te=ne?ne[1]:""),H){ne=ee();if(null!=ne&&ne>parseFloat(te)){Q=String(ne);break e}}Q=te}var re={};function se(){return e=function(){let e=0;var t=G(String(Q)).split("."),n=G("9").split("."),r=Math.max(t.length,n.length);for(let a=0;0==e&&a<r;a++)for(var s=t[a]||"",i=n[a]||"";s=/(\d*)(\D*)(.*)/.exec(s)||["","","",""],i=/(\d*)(\D*)(.*)/.exec(i)||["","","",""],(0!=s[0].length||0!=i[0].length)&&(e=j(0==s[1].length?0:parseInt(s[1],10),0==i[1].length?0:parseInt(i[1],10))||j(0==s[2].length,0==i[2].length)||j(s[2],i[2]),s=s[3],i=i[3],0==e););return 0<=e},t=re,Object.prototype.hasOwnProperty.call(t,9)?t[9]:t[9]=e(9);var e,t}var ie=_.document&&H&&(ee()||parseInt(Q,10))||void 0;function ae(e,t){if(B.call(this,e?e.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,e){var n=this.type=e.type,r=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.g=t,t=e.relatedTarget){if(J){e:{try{z(t.nodeName);var s=!0;break e}catch(e){}s=!1}s||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType="string"==typeof e.pointerType?e.pointerType:oe[e.pointerType]||"",this.state=e.state,(this.i=e).defaultPrevented&&ae.X.h.call(this)}}M(ae,B);var oe={2:"touch",3:"pen",4:"mouse"};ae.prototype.h=function(){ae.X.h.call(this);var e=this.i;e.preventDefault?e.preventDefault():e.returnValue=!1};var ue="closure_listenable_"+(1e6*Math.random()|0),ce=0;function he(e,t,n,r,s){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.ha=s,this.key=++ce,this.ba=this.ea=!1}function le(e){e.ba=!0,e.listener=null,e.proxy=null,e.src=null,e.ha=null}function de(e,t,n){for(const r in e)t.call(n,e[r],r,e)}function fe(e){const t={};for(const n in e)t[n]=e[n];return t}const me="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function ge(t){let n,r;for(let s=1;s<arguments.length;s++){for(n in r=arguments[s])t[n]=r[n];for(let e=0;e<me.length;e++)n=me[e],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function pe(e){this.src=e,this.g={},this.h=0}function ye(e,t){var n,r,s,i=t.type;i in e.g&&(n=e.g[i],(s=0<=(r=F(n,t)))&&Array.prototype.splice.call(n,r,1),s&&(le(t),0==e.g[i].length&&(delete e.g[i],e.h--)))}function ve(e,t,n,r){for(var s=0;s<e.length;++s){var i=e[s];if(!i.ba&&i.listener==t&&i.capture==!!n&&i.ha==r)return s}return-1}pe.prototype.add=function(e,t,n,r,s){var i=e.toString();(e=this.g[i])||(e=this.g[i]=[],this.h++);var a=ve(e,t,r,s);return-1<a?(t=e[a],n||(t.ea=!1)):((t=new he(t,this.src,i,!!r,s)).ea=n,e.push(t)),t};var we="closure_lm_"+(1e6*Math.random()|0),Ie={};function be(e,t,n,r,s){if(r&&r.once)return function e(t,n,r,s,i){if(Array.isArray(n)){for(var a=0;a<n.length;a++)e(t,n[a],r,s,i);return null}r=Ce(r);return t&&t[ue]?t.O(n,r,D(s)?!!s.capture:!!s,i):Ee(t,n,r,!0,s,i)}(e,t,n,r,s);if(Array.isArray(t)){for(var i=0;i<t.length;i++)be(e,t[i],n,r,s);return null}return n=Ce(n),e&&e[ue]?e.N(t,n,D(r)?!!r.capture:!!r,s):Ee(e,t,n,!1,r,s)}function Ee(e,t,n,r,s,i){if(!t)throw Error("Invalid event type");var a=D(s)?!!s.capture:!!s,o=xe(e);if(o||(e[we]=o=new pe(e)),(n=o.add(t,n,r,a,i)).proxy)return n;if(r=function(){const n=Se;return function e(t){return n.call(e.src,e.listener,t)}}(),(n.proxy=r).src=e,r.listener=n,e.addEventListener)void 0===(s=!q?a:s)&&(s=!1),e.addEventListener(t.toString(),r,s);else if(e.attachEvent)e.attachEvent(_e(t.toString()),r);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(r)}return n}function Te(e){var t,n,r;"number"!=typeof e&&e&&!e.ba&&((t=e.src)&&t[ue]?ye(t.i,e):(n=e.type,r=e.proxy,t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(_e(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=xe(t))?(ye(n,e),0==n.h&&(n.src=null,t[we]=null)):le(e)))}function _e(e){return e in Ie?Ie[e]:Ie[e]="on"+e}function Se(e,t){var n,r;return e=!!e.ba||(t=new ae(t,this),n=e.listener,r=e.ha||e.src,e.ea&&Te(e),n.call(r,t))}function xe(e){return(e=e[we])instanceof pe?e:null}var De="__closure_events_fn_"+(1e9*Math.random()>>>0);function Ce(t){return"function"==typeof t?t:(t[De]||(t[De]=function(e){return t.handleEvent(e)}),t[De])}function Ae(){O.call(this),this.i=new pe(this),(this.P=this).I=null}function Ne(e,t){var n,r=e.I;if(r)for(n=[];r;r=r.I)n.push(r);if(e=e.P,r=t.type||t,"string"==typeof t?t=new B(t,e):t instanceof B?t.target=t.target||e:(a=t,ge(t=new B(r,e),a)),a=!0,n)for(var s=n.length-1;0<=s;s--)var i=t.g=n[s],a=ke(i,r,!0,t)&&a;if(a=ke(i=t.g=e,r,!0,t)&&a,a=ke(i,r,!1,t)&&a,n)for(s=0;s<n.length;s++)a=ke(i=t.g=n[s],r,!1,t)&&a}function ke(e,t,n,r){if(!(t=e.i.g[String(t)]))return!0;t=t.concat();for(var s=!0,i=0;i<t.length;++i){var a,o,u=t[i];u&&!u.ba&&u.capture==n&&(a=u.listener,o=u.ha||u.src,u.ea&&ye(e.i,u),s=!1!==a.call(o,r)&&s)}return s&&!r.defaultPrevented}M(Ae,O),Ae.prototype[ue]=!0,Ae.prototype.removeEventListener=function(e,t,n,r){!function e(t,n,r,s,i){if(Array.isArray(n))for(var a=0;a<n.length;a++)e(t,n[a],r,s,i);else s=D(s)?!!s.capture:!!s,r=Ce(r),t&&t[ue]?(t=t.i,(n=String(n).toString())in t.g&&-1<(r=ve(a=t.g[n],r,s,i))&&(le(a[r]),Array.prototype.splice.call(a,r,1),0==a.length&&(delete t.g[n],t.h--))):(t=t&&xe(t))&&(n=t.g[n.toString()],(r=(t=-1)<(t=n?ve(n,r,s,i):t)?n[t]:null)&&Te(r))}(this,e,t,n,r)},Ae.prototype.M=function(){if(Ae.X.M.call(this),this.i){var e,t=this.i;for(e in t.g){for(var n=t.g[e],r=0;r<n.length;r++)le(n[r]);delete t.g[e],t.h--}}this.I=null},Ae.prototype.N=function(e,t,n,r){return this.i.add(String(e),t,!1,n,r)},Ae.prototype.O=function(e,t,n,r){return this.i.add(String(e),t,!0,n,r)};var Re=_.JSON.stringify;var Le,Me=new class{constructor(e,t){this.i=e,this.j=t,this.h=0,this.g=null}get(){let e;return 0<this.h?(this.h--,e=this.g,this.g=e.next,e.next=null):e=this.i(),e}}(()=>new Oe,e=>e.reset());class Oe{constructor(){this.next=this.g=this.h=null}set(e,t){this.h=e,this.g=t,this.next=null}reset(){this.next=this.g=this.h=null}}function Fe(e,t){var n;Le||(n=_.Promise.resolve(void 0),Le=function(){n.then(Be)}),Ve||(Le(),Ve=!0),Pe.add(e,t)}var Ve=!1,Pe=new class{constructor(){this.h=this.g=null}add(e,t){const n=Me.get();n.set(e,t),this.h?this.h.next=n:this.g=n,this.h=n}};function Be(){for(var e;e=function(){var e=Pe;let t=null;return e.g&&(t=e.g,e.g=e.g.next,e.g||(e.h=null),t.next=null),t}();){try{e.h.call(e.g)}catch(e){!function(e){_.setTimeout(()=>{throw e},0)}(e)}var t=Me;t.j(e),t.h<100&&(t.h++,e.next=t.g,t.g=e)}Ve=!1}function qe(e,t){Ae.call(this),this.h=e||1,this.g=t||_,this.j=R(this.lb,this),this.l=Date.now()}function Ue(e){e.ca=!1,e.R&&(e.g.clearTimeout(e.R),e.R=null)}function Ge(e,t,n){if("function"==typeof e)n&&(e=R(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=R(e.handleEvent,e)}return 2147483647<Number(t)?-1:_.setTimeout(e,t||0)}M(qe,Ae),(b=qe.prototype).ca=!1,b.R=null,b.lb=function(){var e;this.ca&&(0<(e=Date.now()-this.l)&&e<.8*this.h?this.R=this.g.setTimeout(this.j,this.h-e):(this.R&&(this.g.clearTimeout(this.R),this.R=null),Ne(this,"tick"),this.ca&&(Ue(this),this.start())))},b.start=function(){this.ca=!0,this.R||(this.R=this.g.setTimeout(this.j,this.h),this.l=Date.now())},b.M=function(){qe.X.M.call(this),Ue(this),delete this.g};class je extends O{constructor(e,t){super(),this.m=e,this.j=t,this.h=null,this.i=!1,this.g=null}l(e){this.h=arguments,this.g?this.i=!0:function e(t){t.g=Ge(()=>{t.g=null,t.i&&(t.i=!1,e(t))},t.j);var n=t.h;t.h=null,t.m.apply(null,n)}(this)}M(){super.M(),this.g&&(_.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Ke(e){O.call(this),this.h=e,this.g={}}M(Ke,O);var $e=[];function ze(e,t,n,r){Array.isArray(n)||(n&&($e[0]=n.toString()),n=$e);for(var s=0;s<n.length;s++){var i=be(t,n[s],r||e.handleEvent,!1,e.h||e);if(!i)break;e.g[i.key]=i}}function Qe(e){de(e.g,function(e,t){this.g.hasOwnProperty(t)&&Te(e)},e),e.g={}}function We(){this.g=!0}function He(e,t,n,r){e.info(function(){return"XMLHTTP TEXT ("+t+"): "+function(e,t){if(!e.g)return t;if(!t)return null;try{var n=JSON.parse(t);if(n)for(e=0;e<n.length;e++)if(Array.isArray(n[e])){var r=n[e];if(!(r.length<2)){var s=r[1];if(Array.isArray(s)&&!(s.length<1)){var i=s[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var a=1;a<s.length;a++)s[a]=""}}}return Re(n)}catch(e){return t}}(e,n)+(r?" "+r:"")})}Ke.prototype.M=function(){Ke.X.M.call(this),Qe(this)},Ke.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},We.prototype.Aa=function(){this.g=!1},We.prototype.info=function(){};var Ye={},Xe=null;function Je(){return Xe=Xe||new Ae}function Ze(e){B.call(this,Ye.Pa,e)}function et(){var e=Je();Ne(e,new Ze(e))}function tt(e,t){B.call(this,Ye.STAT_EVENT,e),this.stat=t}function nt(e){var t=Je();Ne(t,new tt(t,e))}function rt(e,t){B.call(this,Ye.Qa,e),this.size=t}function st(e,t){if("function"!=typeof e)throw Error("Fn must not be null and must be a function");return _.setTimeout(function(){e()},t)}Ye.Pa="serverreachability",M(Ze,B),Ye.STAT_EVENT="statevent",M(tt,B),Ye.Qa="timingevent",M(rt,B);var it={NO_ERROR:0,mb:1,zb:2,yb:3,tb:4,xb:5,Ab:6,Ma:7,TIMEOUT:8,Db:9},at={rb:"complete",Nb:"success",Na:"error",Ma:"abort",Fb:"ready",Gb:"readystatechange",TIMEOUT:"timeout",Bb:"incrementaldata",Eb:"progress",ub:"downloadprogress",Vb:"uploadprogress"};function ot(){}function ut(e){return e.h||(e.h=e.i())}function ct(){}ot.prototype.h=null;E={OPEN:"a",qb:"b",Na:"c",Cb:"d"};function ht(){B.call(this,"d")}function lt(){B.call(this,"c")}function dt(){}function ft(e,t,n,r){this.l=e,this.j=t,this.m=n,this.U=r||1,this.S=new Ke(this),this.O=pt,this.T=new qe(e=X?125:void 0),this.H=null,this.i=!1,this.s=this.A=this.v=this.K=this.F=this.V=this.B=null,this.D=[],this.g=null,this.C=0,this.o=this.u=null,this.Y=-1,this.I=!1,this.N=0,this.L=null,this.$=this.J=this.Z=this.P=!1,this.h=new mt}function mt(){this.i=null,this.g="",this.h=!1}M(ht,B),M(lt,B),M(dt,ot),dt.prototype.g=function(){return new XMLHttpRequest},dt.prototype.i=function(){return{}};var gt=new dt,pt=45e3,yt={},vt={};function wt(e,t,n){e.K=1,e.v=Vt(Rt(t)),e.s=n,e.P=!0,It(e,null)}function It(e,t){e.F=Date.now(),Tt(e),e.A=Rt(e.v);var a,o,u,c,h,l,n=e.A,r=e.U;Array.isArray(r)||(r=[String(r)]),Yt(n.i,"t",r),e.C=0,n=e.l.H,e.h=new mt,e.g=Yn(e.l,n?t:null,!e.s),0<e.N&&(e.L=new je(R(e.La,e,e.g),e.N)),ze(e.S,e.g,"readystatechange",e.ib),t=e.H?fe(e.H):{},e.s?(e.u||(e.u="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.g.da(e.A,e.u,e.s,t)):(e.u="GET",e.g.da(e.A,e.u,null,t)),et(),a=e.j,o=e.u,u=e.A,c=e.m,h=e.U,l=e.s,a.info(function(){if(a.g)if(l)for(var e="",t=l.split("&"),n=0;n<t.length;n++){var r,s,i=t[n].split("=");1<i.length&&(r=i[0],i=i[1],e=2<=(s=r.split("_")).length&&"type"==s[1]?e+(r+"=")+i+"&":e+(r+"=redacted&"))}else e=null;else e=l;return"XMLHTTP REQ ("+c+") [attempt "+h+"]: "+o+"\n"+u+"\n"+e})}function bt(e){return e.g&&("GET"==e.u&&2!=e.K&&e.l.Da)}function Et(e,t,n){let r=!0,s;for(;!e.I&&e.C<n.length;){if(s=(a=n,u=o=void 0,o=(i=e).C,-1==(u=a.indexOf("\n",o))?vt:(o=Number(a.substring(o,u)),isNaN(o)?yt:(u+=1)+o>a.length?vt:(a=a.substr(u,o),i.C=u+o,a))),s==vt){4==t&&(e.o=4,nt(14),r=!1),He(e.j,e.m,null,"[Incomplete Response]");break}if(s==yt){e.o=4,nt(15),He(e.j,e.m,n,"[Invalid Chunk]"),r=!1;break}He(e.j,e.m,s,null),Ct(e,s)}var i,a,o,u;bt(e)&&s!=vt&&s!=yt&&(e.h.g="",e.C=0),4!=t||0!=n.length||e.h.h||(e.o=1,nt(16),r=!1),e.i=e.i&&r,r?0<n.length&&!e.$&&(e.$=!0,(t=e.l).g==e&&t.$&&!t.K&&(t.j.info("Great, no buffering proxy detected. Bytes received: "+n.length),Gn(t),t.K=!0,nt(11))):(He(e.j,e.m,n,"[Invalid Chunked Response]"),Dt(e),xt(e))}function Tt(e){e.V=Date.now()+e.O,_t(e,e.O)}function _t(e,t){if(null!=e.B)throw Error("WatchDog timer not null");e.B=st(R(e.gb,e),t)}function St(e){e.B&&(_.clearTimeout(e.B),e.B=null)}function xt(e){0==e.l.G||e.I||$n(e.l,e)}function Dt(e){St(e);var t=e.L;t&&"function"==typeof t.na&&t.na(),e.L=null,Ue(e.T),Qe(e.S),e.g&&(t=e.g,e.g=null,t.abort(),t.na())}function Ct(e,t){try{var n=e.l;if(0!=n.G&&(n.g==e||rn(n.h,e)))if(!e.J&&rn(n.h,e)&&3==n.G){try{var r=n.Fa.g.parse(t)}catch(e){r=null}if(Array.isArray(r)&&3==r.length){var s=r;if(0==s[0]){e:if(!n.u){if(n.g){if(!(n.g.F+3e3<e.F))break e;Kn(n),Mn(n)}Un(n),nt(18)}}else n.Ba=s[1],0<n.Ba-n.T&&s[2]<37500&&n.L&&0==n.A&&!n.v&&(n.v=st(R(n.cb,n),6e3));if(nn(n.h)<=1&&n.ja){try{n.ja()}catch(e){}n.ja=void 0}}else Qn(n,11)}else if(!e.J&&n.g!=e||Kn(n),!U(t))for(s=n.Fa.g.parse(t),t=0;t<s.length;t++){var i=s[t];if(n.T=i[0],i=i[1],2==n.G)if("c"==i[0]){n.I=i[1],n.ka=i[2];var a=i[3];null!=a&&(n.ma=a,n.j.info("VER="+n.ma));var o=i[4];null!=o&&(n.Ca=o,n.j.info("SVER="+n.Ca));var u,c,h=i[5];null!=h&&"number"==typeof h&&0<h&&(r=1.5*h,n.J=r,n.j.info("backChannelRequestTimeoutMs_="+r)),r=n;const m=e.g;if(m){const g=m.g?m.g.getResponseHeader("X-Client-Wire-Protocol"):null;g&&((u=r.h).g||-1==g.indexOf("spdy")&&-1==g.indexOf("quic")&&-1==g.indexOf("h2")||(u.j=u.l,u.g=new Set,u.h&&(sn(u,u.h),u.h=null))),!r.D||(c=m.g?m.g.getResponseHeader("X-HTTP-Session-Id"):null)&&(r.za=c,Ft(r.F,r.D,c))}n.G=3,n.l&&n.l.xa(),n.$&&(n.P=Date.now()-e.F,n.j.info("Handshake RTT: "+n.P+"ms"));var l,d,f=e;(r=n).sa=Hn(r,r.H?r.ka:null,r.V),f.J?(an(r.h,f),l=f,(d=r.J)&&l.setTimeout(d),l.B&&(St(l),Tt(l)),r.g=f):qn(r),0<n.i.length&&Fn(n)}else"stop"!=i[0]&&"close"!=i[0]||Qn(n,7);else 3==n.G&&("stop"==i[0]||"close"==i[0]?"stop"==i[0]?Qn(n,7):Ln(n):"noop"!=i[0]&&n.l&&n.l.wa(i),n.A=0)}et()}catch(e){}}function At(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(x(e)||"string"==typeof e)Array.prototype.forEach.call(e,t,void 0);else for(var n=function(e){if(e.oa&&"function"==typeof e.oa)return e.oa();if(!e.W||"function"!=typeof e.W){if("undefined"!=typeof Map&&e instanceof Map)return Array.from(e.keys());if(!("undefined"!=typeof Set&&e instanceof Set)){if(x(e)||"string"==typeof e){var t=[];e=e.length;for(var n=0;n<e;n++)t.push(n);return t}t=[],n=0;for(const r in e)t[n++]=r;return t}}}(e),r=function(e){if(e.W&&"function"==typeof e.W)return e.W();if("undefined"!=typeof Map&&e instanceof Map||"undefined"!=typeof Set&&e instanceof Set)return Array.from(e.values());if("string"==typeof e)return e.split("");if(x(e)){for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);return t}for(r in t=[],n=0,e)t[n++]=e[r];return t}(e),s=r.length,i=0;i<s;i++)t.call(void 0,r[i],n&&n[i],e)}(b=ft.prototype).setTimeout=function(e){this.O=e},b.ib=function(e){e=e.target;const t=this.L;t&&3==Dn(e)?t.l():this.La(e)},b.La=function(e){try{if(e==this.g)e:{var t=Dn(this.g),n=this.g.Ea();this.g.aa();if(!(t<3)&&(3!=t||X||this.g&&(this.h.h||this.g.fa()||Cn(this.g)))){this.I||4!=t||7==n||et(),St(this);var r=this.g.aa();this.Y=r;t:if(bt(this)){var s=Cn(this.g);e="";var i=s.length,a=4==Dn(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){Dt(this),xt(this);var o="";break t}this.h.i=new _.TextDecoder}for(n=0;n<i;n++)this.h.h=!0,e+=this.h.i.decode(s[n],{stream:a&&n==i-1});s.splice(0,i),this.h.g+=e,this.C=0,o=this.h.g}else o=this.g.fa();if(this.i=200==r,l=this.j,d=this.u,f=this.A,m=this.m,g=this.U,p=t,y=r,l.info(function(){return"XMLHTTP RESP ("+m+") [ attempt "+g+"]: "+d+"\n"+f+"\n"+p+" "+y}),this.i){if(this.Z&&!this.J){t:{if(this.g){var u,c=this.g;if((u=c.g?c.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!U(u)){var h=u;break t}}h=null}if(!(r=h)){this.i=!1,this.o=3,nt(12),Dt(this),xt(this);break e}He(this.j,this.m,r,"Initial handshake response via X-HTTP-Initial-Response"),this.J=!0,Ct(this,r)}this.P?(Et(this,t,o),X&&this.i&&3==t&&(ze(this.S,this.T,"tick",this.hb),this.T.start())):(He(this.j,this.m,o,null),Ct(this,o)),4==t&&Dt(this),this.i&&!this.I&&(4==t?$n(this.l,this):(this.i=!1,Tt(this)))}else 400==r&&0<o.indexOf("Unknown SID")?(this.o=3,nt(12)):(this.o=0,nt(13)),Dt(this),xt(this)}}}catch(e){}var l,d,f,m,g,p,y},b.hb=function(){var e,t;this.g&&(e=Dn(this.g),t=this.g.fa(),this.C<t.length&&(St(this),Et(this,e,t),this.i&&4!=e&&Tt(this)))},b.cancel=function(){this.I=!0,Dt(this)},b.gb=function(){this.B=null;var e,t,n=Date.now();0<=n-this.V?(e=this.j,t=this.A,e.info(function(){return"TIMEOUT: "+t}),2!=this.K&&(et(),nt(17)),Dt(this),this.o=2,xt(this)):_t(this,this.V-n)};var Nt=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function kt(e,t){var n;this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,e instanceof kt?(this.h=void 0!==t?t:e.h,Lt(this,e.j),this.s=e.s,this.g=e.g,Mt(this,e.m),this.l=e.l,t=e.i,(n=new zt).i=t.i,t.g&&(n.g=new Map(t.g),n.h=t.h),Ot(this,n),this.o=e.o):e&&(n=String(e).match(Nt))?(this.h=!!t,Lt(this,n[1]||"",!0),this.s=Pt(n[2]||""),this.g=Pt(n[3]||"",!0),Mt(this,n[4]),this.l=Pt(n[5]||"",!0),Ot(this,n[6]||"",!0),this.o=Pt(n[7]||"")):(this.h=!!t,this.i=new zt(null,this.h))}function Rt(e){return new kt(e)}function Lt(e,t,n){e.j=n?Pt(t,!0):t,e.j&&(e.j=e.j.replace(/:$/,""))}function Mt(e,t){if(t){if(t=Number(t),isNaN(t)||t<0)throw Error("Bad port number "+t);e.m=t}else e.m=null}function Ot(e,t,n){var r,s;t instanceof zt?(e.i=t,r=e.i,(s=e.h)&&!r.j&&(Qt(r),r.i=null,r.g.forEach(function(e,t){var n=t.toLowerCase();t!=n&&(Wt(this,t),Yt(this,n,e))},r)),r.j=s):(n||(t=Bt(t,Kt)),e.i=new zt(t,e.h))}function Ft(e,t,n){e.i.set(t,n)}function Vt(e){return Ft(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),e}function Pt(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function Bt(e,t,n){return"string"==typeof e?(e=encodeURI(e).replace(t,qt),e=n?e.replace(/%25([0-9a-fA-F]{2})/g,"%$1"):e):null}function qt(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}kt.prototype.toString=function(){var e=[],t=this.j;t&&e.push(Bt(t,Ut,!0),":");var n=this.g;return!n&&"file"!=t||(e.push("//"),(t=this.s)&&e.push(Bt(t,Ut,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&e.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&e.push("/"),e.push(Bt(n,"/"==n.charAt(0)?jt:Gt,!0))),(n=this.i.toString())&&e.push("?",n),(n=this.o)&&e.push("#",Bt(n,$t)),e.join("")};var Ut=/[#\/\?@]/g,Gt=/[#\?:]/g,jt=/[#\?]/g,Kt=/[#\?@]/g,$t=/#/g;function zt(e,t){this.h=this.g=null,this.i=e||null,this.j=!!t}function Qt(n){n.g||(n.g=new Map,n.h=0,n.i&&function(e,t){if(e){e=e.split("&");for(var n=0;n<e.length;n++){var r,s=e[n].indexOf("="),i=null;0<=s?(r=e[n].substring(0,s),i=e[n].substring(s+1)):r=e[n],t(r,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}(n.i,function(e,t){n.add(decodeURIComponent(e.replace(/\+/g," ")),t)}))}function Wt(e,t){Qt(e),t=Xt(e,t),e.g.has(t)&&(e.i=null,e.h-=e.g.get(t).length,e.g.delete(t))}function Ht(e,t){return Qt(e),t=Xt(e,t),e.g.has(t)}function Yt(e,t,n){Wt(e,t),0<n.length&&(e.i=null,e.g.set(Xt(e,t),V(n)),e.h+=n.length)}function Xt(e,t){return t=String(t),t=e.j?t.toLowerCase():t}(b=zt.prototype).add=function(e,t){Qt(this),this.i=null,e=Xt(this,e);var n=this.g.get(e);return n||this.g.set(e,n=[]),n.push(t),this.h+=1,this},b.forEach=function(n,r){Qt(this),this.g.forEach(function(e,t){e.forEach(function(e){n.call(r,e,t,this)},this)},this)},b.oa=function(){Qt(this);const t=Array.from(this.g.values()),n=Array.from(this.g.keys()),r=[];for(let i=0;i<n.length;i++){var s=t[i];for(let e=0;e<s.length;e++)r.push(n[i])}return r},b.W=function(t){Qt(this);let n=[];if("string"==typeof t)Ht(this,t)&&(n=n.concat(this.g.get(Xt(this,t))));else{t=Array.from(this.g.values());for(let e=0;e<t.length;e++)n=n.concat(t[e])}return n},b.set=function(e,t){return Qt(this),this.i=null,Ht(this,e=Xt(this,e))&&(this.h-=this.g.get(e).length),this.g.set(e,[t]),this.h+=1,this},b.get=function(e,t){return e&&0<(e=this.W(e)).length?String(e[0]):t},b.toString=function(){if(this.i)return this.i;if(!this.g)return"";const e=[],t=Array.from(this.g.keys());for(var n=0;n<t.length;n++)for(var r=t[n],s=encodeURIComponent(String(r)),i=this.W(r),r=0;r<i.length;r++){var a=s;""!==i[r]&&(a+="="+encodeURIComponent(String(i[r]))),e.push(a)}return this.i=e.join("&")};var Jt=class{constructor(e,t){this.h=e,this.g=t}};function Zt(e){this.l=e||10,e=_.PerformanceNavigationTiming?0<(e=_.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):!!(_.g&&_.g.Ga&&_.g.Ga()&&_.g.Ga().$b),this.j=e?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}var en;function tn(e){return e.h||e.g&&e.g.size>=e.j}function nn(e){return e.h?1:e.g?e.g.size:0}function rn(e,t){return e.h?e.h==t:e.g&&e.g.has(t)}function sn(e,t){e.g?e.g.add(t):e.h=t}function an(e,t){e.h&&e.h==t?e.h=null:e.g&&e.g.has(t)&&e.g.delete(t)}function on(t){if(null!=t.h)return t.i.concat(t.h.D);if(null==t.g||0===t.g.size)return V(t.i);{let e=t.i;for(const n of t.g.values())e=e.concat(n.D);return e}}function un(){}function cn(){this.g=new un}function hn(e,t,n,r,s){try{t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,s(r)}catch(e){}}function ln(e){this.l=e.ac||null,this.j=e.jb||!1}function dn(e,t){Ae.call(this),this.D=e,this.u=t,this.m=void 0,this.readyState=fn,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}Zt.prototype.cancel=function(){if(this.i=on(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const e of this.g.values())e.cancel();this.g.clear()}},un.prototype.stringify=function(e){return _.JSON.stringify(e,void 0)},un.prototype.parse=function(e){return _.JSON.parse(e,void 0)},M(ln,ot),ln.prototype.g=function(){return new dn(this.l,this.j)},ln.prototype.i=(en={},function(){return en}),M(dn,Ae);var fn=0;function mn(e){e.j.read().then(e.Ta.bind(e)).catch(e.ga.bind(e))}function gn(e){e.readyState=4,e.l=null,e.j=null,e.A=null,pn(e)}function pn(e){e.onreadystatechange&&e.onreadystatechange.call(e)}(b=dn.prototype).open=function(e,t){if(this.readyState!=fn)throw this.abort(),Error("Error reopening a connection");this.C=e,this.B=t,this.readyState=1,pn(this)},b.send=function(e){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const t={headers:this.v,method:this.C,credentials:this.m,cache:void 0};e&&(t.body=e),(this.D||_).fetch(new Request(this.B,t)).then(this.Wa.bind(this),this.ga.bind(this))},b.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,gn(this)),this.readyState=fn},b.Wa=function(e){if(this.g&&(this.l=e,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=e.headers,this.readyState=2,pn(this)),this.g&&(this.readyState=3,pn(this),this.g)))if("arraybuffer"===this.responseType)e.arrayBuffer().then(this.Ua.bind(this),this.ga.bind(this));else if(void 0!==_.ReadableStream&&"body"in e){if(this.j=e.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;mn(this)}else e.text().then(this.Va.bind(this),this.ga.bind(this))},b.Ta=function(e){var t;this.g&&(this.u&&e.value?this.response.push(e.value):this.u||(t=e.value||new Uint8Array(0),(t=this.A.decode(t,{stream:!e.done}))&&(this.response=this.responseText+=t)),(e.done?gn:pn)(this),3==this.readyState&&mn(this))},b.Va=function(e){this.g&&(this.response=this.responseText=e,gn(this))},b.Ua=function(e){this.g&&(this.response=e,gn(this))},b.ga=function(){this.g&&gn(this)},b.setRequestHeader=function(e,t){this.v.append(e,t)},b.getResponseHeader=function(e){return this.h&&this.h.get(e.toLowerCase())||""},b.getAllResponseHeaders=function(){if(!this.h)return"";const e=[],t=this.h.entries();for(var n=t.next();!n.done;)n=n.value,e.push(n[0]+": "+n[1]),n=t.next();return e.join("\r\n")},Object.defineProperty(dn.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(e){this.m=e?"include":"same-origin"}});var yn=_.JSON.parse;function vn(e){Ae.call(this),this.headers=new Map,this.u=e||null,this.h=!1,this.C=this.g=null,this.H="",this.m=0,this.j="",this.l=this.F=this.v=this.D=!1,this.B=0,this.A=null,this.J=wn,this.K=this.L=!1}M(vn,Ae);var wn="",In=/^https?$/i,bn=["POST","PUT"];function En(e,t){e.h=!1,e.g&&(e.l=!0,e.g.abort(),e.l=!1),e.j=t,e.m=5,Tn(e),Sn(e)}function Tn(e){e.D||(e.D=!0,Ne(e,"complete"),Ne(e,"error"))}function _n(e){if(e.h&&void 0!==T&&(!e.C[1]||4!=Dn(e)||2!=e.aa()))if(e.v&&4==Dn(e))Ge(e.Ha,0,e);else if(Ne(e,"readystatechange"),4==Dn(e)){e.h=!1;try{var t,n,r,s,i=e.aa();e:switch(i){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var a=!0;break e;default:a=!1}if((t=a)||((n=0===i)&&(!(s=String(e.H).match(Nt)[1]||null)&&_.self&&_.self.location&&(s=(r=_.self.location.protocol).substr(0,r.length-1)),n=!In.test(s?s.toLowerCase():"")),t=n),t)Ne(e,"complete"),Ne(e,"success");else{e.m=6;try{var o=2<Dn(e)?e.g.statusText:""}catch(e){o=""}e.j=o+" ["+e.aa()+"]",Tn(e)}}finally{Sn(e)}}}function Sn(e,t){if(e.g){xn(e);const n=e.g,r=e.C[0]?S:null;e.g=null,e.C=null,t||Ne(e,"ready");try{n.onreadystatechange=r}catch(e){}}}function xn(e){e.g&&e.K&&(e.g.ontimeout=null),e.A&&(_.clearTimeout(e.A),e.A=null)}function Dn(e){return e.g?e.g.readyState:0}function Cn(e){try{if(!e.g)return null;if("response"in e.g)return e.g.response;switch(e.J){case wn:case"text":return e.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in e.g)return e.g.mozResponseArrayBuffer}return null}catch(e){return null}}function An(e){let n="";return de(e,function(e,t){n+=t,n+=":",n+=e,n+="\r\n"}),n}function Nn(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}r||(n=An(n),"string"==typeof e?null!=n&&encodeURIComponent(String(n)):Ft(e,t,n))}function kn(e,t,n){return n&&n.internalChannelParams&&n.internalChannelParams[e]||t}function Rn(e){this.Ca=0,this.i=[],this.j=new We,this.ka=this.sa=this.F=this.V=this.g=this.za=this.D=this.ia=this.o=this.S=this.s=null,this.ab=this.U=0,this.Za=kn("failFast",!1,e),this.L=this.v=this.u=this.m=this.l=null,this.Y=!0,this.pa=this.Ba=this.T=-1,this.Z=this.A=this.C=0,this.Xa=kn("baseRetryDelayMs",5e3,e),this.bb=kn("retryDelaySeedMs",1e4,e),this.$a=kn("forwardChannelMaxRetries",2,e),this.ta=kn("forwardChannelRequestTimeoutMs",2e4,e),this.ra=e&&e.xmlHttpFactory||void 0,this.Da=e&&e.Zb||!1,this.J=void 0,this.H=e&&e.supportsCrossDomainXhr||!1,this.I="",this.h=new Zt(e&&e.concurrentRequestLimit),this.Fa=new cn,this.O=e&&e.fastHandshake||!1,this.N=e&&e.encodeInitMessageHeaders||!1,this.O&&this.N&&(this.N=!1),this.Ya=e&&e.Xb||!1,e&&e.Aa&&this.j.Aa(),e&&e.forceLongPolling&&(this.Y=!1),this.$=!this.O&&this.Y&&e&&e.detectBufferingProxy||!1,this.ja=void 0,this.P=0,this.K=!1,this.la=this.B=null}function Ln(e){var t,n;On(e),3==e.G&&(t=e.U++,Ft(n=Rt(e.F),"SID",e.I),Ft(n,"RID",t),Ft(n,"TYPE","terminate"),Pn(e,n),(t=new ft(e,e.j,t,void 0)).K=2,t.v=Vt(Rt(n)),n=!1,!(n=_.navigator&&_.navigator.sendBeacon?_.navigator.sendBeacon(t.v.toString(),""):n)&&_.Image&&((new Image).src=t.v,n=!0),n||(t.g=Yn(t.l,null),t.g.da(t.v)),t.F=Date.now(),Tt(t)),Wn(e)}function Mn(e){e.g&&(Gn(e),e.g.cancel(),e.g=null)}function On(e){Mn(e),e.u&&(_.clearTimeout(e.u),e.u=null),Kn(e),e.h.cancel(),e.m&&("number"==typeof e.m&&_.clearTimeout(e.m),e.m=null)}function Fn(e){tn(e.h)||e.m||(e.m=!0,Fe(e.Ja,e),e.C=0)}function Vn(e,t){var n=t?t.m:e.U++,r=Rt(e.F);Ft(r,"SID",e.I),Ft(r,"RID",n),Ft(r,"AID",e.T),Pn(e,r),e.o&&e.s&&Nn(r,e.o,e.s),n=new ft(e,e.j,n,e.C+1),null===e.o&&(n.H=e.s),t&&(e.i=t.D.concat(e.i)),t=Bn(e,n,1e3),n.setTimeout(Math.round(.5*e.ta)+Math.round(.5*e.ta*Math.random())),sn(e.h,n),wt(n,r,t)}function Pn(e,n){e.ia&&de(e.ia,function(e,t){Ft(n,t,e)}),e.l&&At({},function(e,t){Ft(n,t,e)})}function Bn(e,t,r){r=Math.min(e.i.length,r);var s=e.l?R(e.l.Ra,e.l,e):null;e:{var i=e.i;let n=-1;for(;;){const u=["count="+r];-1==n?0<r?(n=i[0].h,u.push("ofs="+n)):n=0:u.push("ofs="+n);let e=!0;for(let t=0;t<r;t++){var a=i[t].h,o=i[t].g;if((a-=n)<0)n=Math.max(0,i[t].h-100),e=!1;else try{!function(e,r,t){const s=t||"";try{At(e,function(e,t){let n=e;D(e)&&(n=Re(e)),r.push(s+t+"="+encodeURIComponent(n))})}catch(e){throw r.push(s+"type="+encodeURIComponent("_badmap")),e}}(o,u,"req"+a+"_")}catch(e){s&&s(o)}}if(e){s=u.join("&");break e}}}return e=e.i.splice(0,r),t.D=e,s}function qn(e){e.g||e.u||(e.Z=1,Fe(e.Ia,e),e.A=0)}function Un(e){return!(e.g||e.u||3<=e.A)&&(e.Z++,e.u=st(R(e.Ia,e),zn(e,e.A)),e.A++,1)}function Gn(e){null!=e.B&&(_.clearTimeout(e.B),e.B=null)}function jn(e){e.g=new ft(e,e.j,"rpc",e.Z),null===e.o&&(e.g.H=e.s),e.g.N=0;var t=Rt(e.sa);Ft(t,"RID","rpc"),Ft(t,"SID",e.I),Ft(t,"CI",e.L?"0":"1"),Ft(t,"AID",e.T),Ft(t,"TYPE","xmlhttp"),Pn(e,t),e.o&&e.s&&Nn(t,e.o,e.s),e.J&&e.g.setTimeout(e.J);var n=e.g;e=e.ka,n.K=1,n.v=Vt(Rt(t)),n.s=null,n.P=!0,It(n,e)}function Kn(e){null!=e.v&&(_.clearTimeout(e.v),e.v=null)}function $n(e,t){var n,r,s,i=null;if(e.g==t){Kn(e),Gn(e),e.g=null;var a=2}else{if(!rn(e.h,t))return;i=t.D,an(e.h,t),a=1}if(0!=e.G)if(e.pa=t.Y,t.i)1==a?(i=t.s?t.s.length:0,t=Date.now()-t.F,n=e.C,Ne(a=Je(),new rt(a,i)),Fn(e)):qn(e);else if(3==(n=t.o)||0==n&&0<e.pa||(1!=a||(s=t,nn((r=e).h)>=r.h.j-(r.m?1:0)||(r.m?(r.i=s.D.concat(r.i),0):1==r.G||2==r.G||r.C>=(r.Za?0:r.$a)||(r.m=st(R(r.Ja,r,s),zn(r,r.C)),r.C++,0))))&&(2!=a||!Un(e)))switch(i&&0<i.length&&(t=e.h,t.i=t.i.concat(i)),n){case 1:Qn(e,5);break;case 4:Qn(e,10);break;case 3:Qn(e,6);break;default:Qn(e,2)}}function zn(e,t){let n=e.Xa+Math.floor(Math.random()*e.bb);return e.l||(n*=2),n*t}function Qn(e,t){var n,r;e.j.info("Error code "+t),2==t?(n=null,e.l&&(n=null),r=R(e.kb,e),n||(n=new kt("//www.google.com/images/cleardot.gif"),_.location&&"http"==_.location.protocol||Lt(n,"https"),Vt(n)),function(e,t){var n=new We;if(_.Image){const r=new Image;r.onload=L(hn,n,r,"TestLoadImage: loaded",!0,t),r.onerror=L(hn,n,r,"TestLoadImage: error",!1,t),r.onabort=L(hn,n,r,"TestLoadImage: abort",!1,t),r.ontimeout=L(hn,n,r,"TestLoadImage: timeout",!1,t),_.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=e}else t(!1)}(n.toString(),r)):nt(2),e.G=0,e.l&&e.l.va(t),Wn(e),On(e)}function Wn(e){var t;e.G=0,e.la=[],e.l&&(0==(t=on(e.h)).length&&0==e.i.length||(P(e.la,t),P(e.la,e.i),e.h.i.length=0,V(e.i),e.i.length=0),e.l.ua())}function Hn(e,t,n){var r,s,i=n instanceof kt?Rt(n):new kt(n,void 0);return""!=i.g?(t&&(i.g=t+"."+i.g),Mt(i,i.m)):(i=(r=_.location).protocol,t=t?t+"."+r.hostname:r.hostname,r=+r.port,s=new kt(null,void 0),i&&Lt(s,i),t&&(s.g=t),r&&Mt(s,r),n&&(s.l=n),i=s),n=e.D,t=e.za,n&&t&&Ft(i,n,t),Ft(i,"VER",e.ma),Pn(e,i),i}function Yn(e,t,n){if(t&&!e.H)throw Error("Can't create secondary domain capable XhrIo object.");return(t=n&&e.Da&&!e.ra?new vn(new ln({jb:!0})):new vn(e.ra)).Ka(e.H),t}function Xn(){}function Jn(){if(H&&!(10<=Number(ie)))throw Error("Environmental error: no available transport.")}function Zn(e,t){Ae.call(this),this.g=new Rn(t),this.l=e,this.h=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.g.s=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.ya&&(e?e["X-WebChannel-Client-Profile"]=t.ya:e={"X-WebChannel-Client-Profile":t.ya}),this.g.S=e,(e=t&&t.Yb)&&!U(e)&&(this.g.o=e),this.A=t&&t.supportsCrossDomainXhr||!1,this.v=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!U(t)&&(this.g.D=t,null!==(e=this.h)&&t in e&&(t in(e=this.h)&&delete e[t])),this.j=new nr(this)}function er(e){ht.call(this);var t=e.__sm__;if(t){e:{for(const n in t){e=n;break e}e=void 0}(this.i=e)&&(e=this.i,t=null!==t&&e in t?t[e]:void 0),this.data=t}else this.data=e}function tr(){lt.call(this),this.status=1}function nr(e){this.g=e}(b=vn.prototype).Ka=function(e){this.L=e},b.da=function(e,t,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.H+"; newUri="+e);t=t?t.toUpperCase():"GET",this.H=e,this.j="",this.m=0,this.D=!1,this.h=!0,this.g=(this.u||gt).g(),this.C=this.u?ut(this.u):ut(gt),this.g.onreadystatechange=R(this.Ha,this);try{this.F=!0,this.g.open(t,String(e),!0),this.F=!1}catch(e){return void En(this,e)}if(e=n||"",n=new Map(this.headers),r)if(Object.getPrototypeOf(r)===Object.prototype)for(var s in r)n.set(s,r[s]);else{if("function"!=typeof r.keys||"function"!=typeof r.get)throw Error("Unknown input type for opt_headers: "+String(r));for(const u of r.keys())n.set(u,r.get(u))}r=Array.from(n.keys()).find(e=>"content-type"==e.toLowerCase()),s=_.FormData&&e instanceof _.FormData,0<=F(bn,t)&&!r&&!s&&n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(var[i,a]of n)this.g.setRequestHeader(i,a);this.J&&(this.g.responseType=this.J),"withCredentials"in this.g&&this.g.withCredentials!==this.L&&(this.g.withCredentials=this.L);try{xn(this),0<this.B&&((this.K=(o=this.g,H&&se()&&"number"==typeof o.timeout&&void 0!==o.ontimeout))?(this.g.timeout=this.B,this.g.ontimeout=R(this.qa,this)):this.A=Ge(this.qa,this.B,this)),this.v=!0,this.g.send(e),this.v=!1}catch(e){En(this,e)}var o},b.qa=function(){void 0!==T&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,Ne(this,"timeout"),this.abort(8))},b.abort=function(e){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=e||7,Ne(this,"complete"),Ne(this,"abort"),Sn(this))},b.M=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),Sn(this,!0)),vn.X.M.call(this)},b.Ha=function(){this.s||(this.F||this.v||this.l?_n(this):this.fb())},b.fb=function(){_n(this)},b.aa=function(){try{return 2<Dn(this)?this.g.status:-1}catch(e){return-1}},b.fa=function(){try{return this.g?this.g.responseText:""}catch(e){return""}},b.Sa=function(e){if(this.g){var t=this.g.responseText;return e&&0==t.indexOf(e)&&(t=t.substring(e.length)),yn(t)}},b.Ea=function(){return this.m},b.Oa=function(){return"string"==typeof this.j?this.j:String(this.j)},(b=Rn.prototype).ma=8,b.G=1,b.Ja=function(t){if(this.m)if(this.m=null,1==this.G){if(!t){this.U=Math.floor(1e5*Math.random()),t=this.U++;const i=new ft(this,this.j,t,void 0);let e=this.s;if(this.S&&(e?(e=fe(e),ge(e,this.S)):e=this.S),null!==this.o||this.N||(i.H=e,e=null),this.O)e:{for(var n=0,r=0;r<this.i.length;r++){var s=this.i[r];if("__data__"in s.g&&"string"==typeof(s=s.g.__data__)?s=s.length:s=void 0,void 0===s)break;if(4096<(n+=s)){n=r;break e}if(4096===n||r===this.i.length-1){n=r+1;break e}}n=1e3}else n=1e3;n=Bn(this,i,n),Ft(r=Rt(this.F),"RID",t),Ft(r,"CVER",22),this.D&&Ft(r,"X-HTTP-Session-Id",this.D),Pn(this,r),e&&(this.N?n="headers="+encodeURIComponent(String(An(e)))+"&"+n:this.o&&Nn(r,this.o,e)),sn(this.h,i),this.Ya&&Ft(r,"TYPE","init"),this.O?(Ft(r,"$req",n),Ft(r,"SID","null"),i.Z=!0,wt(i,r,null)):wt(i,r,n),this.G=2}}else 3==this.G&&(t?Vn(this,t):0==this.i.length||tn(this.h)||Vn(this))},b.Ia=function(){var e;this.u=null,jn(this),this.$&&!(this.K||null==this.g||this.P<=0)&&(e=2*this.P,this.j.info("BP detection timer enabled: "+e),this.B=st(R(this.eb,this),e))},b.eb=function(){this.B&&(this.B=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.L=!1,this.K=!0,nt(10),Mn(this),jn(this))},b.cb=function(){null!=this.v&&(this.v=null,Mn(this),Un(this),nt(19))},b.kb=function(e){e?(this.j.info("Successfully pinged google.com"),nt(2)):(this.j.info("Failed to ping google.com"),nt(1))},(b=Xn.prototype).xa=function(){},b.wa=function(){},b.va=function(){},b.ua=function(){},b.Ra=function(){},Jn.prototype.g=function(e,t){return new Zn(e,t)},M(Zn,Ae),Zn.prototype.m=function(){this.g.l=this.j,this.A&&(this.g.H=!0);var e=this.g,t=this.l,n=this.h||void 0;nt(0),e.V=t,e.ia=n||{},e.L=e.Y,e.F=Hn(e,null,e.V),Fn(e)},Zn.prototype.close=function(){Ln(this.g)},Zn.prototype.u=function(e){var t,n=this.g;"string"==typeof e?((t={}).__data__=e,e=t):this.v&&((t={}).__data__=Re(e),e=t),n.i.push(new Jt(n.ab++,e)),3==n.G&&Fn(n)},Zn.prototype.M=function(){this.g.l=null,delete this.j,Ln(this.g),delete this.g,Zn.X.M.call(this)},M(er,ht),M(tr,lt),M(nr,Xn),nr.prototype.xa=function(){Ne(this.g,"a")},nr.prototype.wa=function(e){Ne(this.g,new er(e))},nr.prototype.va=function(e){Ne(this.g,new tr)},nr.prototype.ua=function(){Ne(this.g,"b")},Jn.prototype.createWebChannel=Jn.prototype.g,Zn.prototype.send=Zn.prototype.u,Zn.prototype.open=Zn.prototype.m,it.NO_ERROR=0,it.TIMEOUT=8,it.HTTP_ERROR=6,at.COMPLETE="complete",(ct.EventType=E).OPEN="a",E.CLOSE="b",E.ERROR="c",E.MESSAGE="d",Ae.prototype.listen=Ae.prototype.N,vn.prototype.listenOnce=vn.prototype.O,vn.prototype.getLastError=vn.prototype.Oa,vn.prototype.getLastErrorCode=vn.prototype.Ea,vn.prototype.getStatus=vn.prototype.aa,vn.prototype.getResponseJson=vn.prototype.Sa,vn.prototype.getResponseText=vn.prototype.fa,vn.prototype.send=vn.prototype.da,vn.prototype.setWithCredentials=vn.prototype.Ka;var rr,sr=Je,ir=it,ar=at,or=Ye,ur=10,cr=11,hr=ln,lr=ct,dr=vn;const fr="@firebase/firestore";class mr{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}mr.UNAUTHENTICATED=new mr(null),mr.GOOGLE_CREDENTIALS=new mr("google-credentials-uid"),mr.FIRST_PARTY=new mr("first-party-uid"),mr.MOCK_USER=new mr("mock-user");let gr="9.20.0";const pr=new class{constructor(e){this.name=e,this._logLevel=v,this._logHandler=I,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in l))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?y[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,l.DEBUG,...e),this._logHandler(this,l.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,l.VERBOSE,...e),this._logHandler(this,l.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,l.INFO,...e),this._logHandler(this,l.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,l.WARN,...e),this._logHandler(this,l.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,l.ERROR,...e),this._logHandler(this,l.ERROR,...e)}}("@firebase/firestore");function yr(){return pr.logLevel}function vr(e,...t){var n;pr.logLevel<=l.DEBUG&&(n=t.map(br),pr.debug(`Firestore (${gr}): ${e}`,...n))}function wr(e,...t){var n;pr.logLevel<=l.ERROR&&(n=t.map(br),pr.error(`Firestore (${gr}): ${e}`,...n))}function Ir(e,...t){var n;pr.logLevel<=l.WARN&&(n=t.map(br),pr.warn(`Firestore (${gr}): ${e}`,...n))}function br(t){if("string"==typeof t)return t;try{return JSON.stringify(t)}catch(e){return t}}function Er(e="Unexpected state"){var t=`FIRESTORE (${gr}) INTERNAL ASSERTION FAILED: `+e;throw wr(t),new Error(t)}function Tr(e){e||Er()}const _r={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class Sr extends d{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class xr{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class Dr{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class Cr{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(mr.UNAUTHENTICATED))}shutdown(){}}class Ar{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class Nr{constructor(e){this.t=e,this.currentUser=mr.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,n){let r=this.i;const s=e=>this.i!==r?(r=this.i,n(e)):Promise.resolve();let i=new xr;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new xr,t.enqueueRetryable(()=>s(this.currentUser))};const a=()=>{const e=i;t.enqueueRetryable(async()=>{await e.promise,await s(this.currentUser)})},o=e=>{vr("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),a()};this.t.onInit(e=>o(e)),setTimeout(()=>{var e;this.auth||((e=this.t.getImmediate({optional:!0}))?o(e):(vr("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new xr))},0),a()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(e=>this.i!==t?(vr("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(Tr("string"==typeof e.accessToken),new Dr(e.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){var e=this.auth&&this.auth.getUid();return Tr(null===e||"string"==typeof e),new mr(e)}}class kr{constructor(e,t,n){this.h=e,this.l=t,this.m=n,this.type="FirstParty",this.user=mr.FIRST_PARTY,this.g=new Map}p(){return this.m?this.m():null}get headers(){this.g.set("X-Goog-AuthUser",this.h);var e=this.p();return e&&this.g.set("Authorization",e),this.l&&this.g.set("X-Goog-Iam-Authorization-Token",this.l),this.g}}class Rr{constructor(e,t,n){this.h=e,this.l=t,this.m=n}getToken(){return Promise.resolve(new kr(this.h,this.l,this.m))}start(e,t){e.enqueueRetryable(()=>t(mr.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class Lr{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&0<e.length&&this.headers.set("x-firebase-appcheck",this.value)}}class Mr{constructor(e){this.I=e,this.forceRefresh=!1,this.appCheck=null,this.T=null}start(t,n){const r=e=>{null!=e.error&&vr("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);var t=e.token!==this.T;return this.T=e.token,vr("FirebaseAppCheckTokenProvider",`Received ${t?"new":"existing"} token.`),t?n(e.token):Promise.resolve()};this.o=e=>{t.enqueueRetryable(()=>r(e))};const s=e=>{vr("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.I.onInit(e=>s(e)),setTimeout(()=>{var e;this.appCheck||((e=this.I.getImmediate({optional:!0}))?s(e):vr("FirebaseAppCheckTokenProvider","AppCheck not yet detected"))},0)}getToken(){var e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?(Tr("string"==typeof e.token),this.T=e.token,new Lr(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class Or{static A(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=Math.floor(256/t.length)*t.length;let r="";for(;r.length<20;){var s=function(t){const n="undefined"!=typeof self&&(self.crypto||self.msCrypto),r=new Uint8Array(t);if(n&&"function"==typeof n.getRandomValues)n.getRandomValues(r);else for(let e=0;e<t;e++)r[e]=Math.floor(256*Math.random());return r}(40);for(let e=0;e<s.length;++e)r.length<20&&s[e]<n&&(r+=t.charAt(s[e]%t.length))}return r}}function Fr(e,t){return e<t?-1:t<e?1:0}function Vr(e,n,r){return e.length===n.length&&e.every((e,t)=>r(e,n[t]))}function Pr(e){return e+"\0"}class Br{constructor(e,t){if(this.seconds=e,(this.nanoseconds=t)<0)throw new Sr(_r.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(1e9<=t)throw new Sr(_r.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new Sr(_r.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(253402300800<=e)throw new Sr(_r.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return Br.fromMillis(Date.now())}static fromDate(e){return Br.fromMillis(e.getTime())}static fromMillis(e){var t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new Br(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?Fr(this.nanoseconds,e.nanoseconds):Fr(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){var e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class qr{constructor(e){this.timestamp=e}static fromTimestamp(e){return new qr(e)}static min(){return new qr(new Br(0,0))}static max(){return new qr(new Br(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class Ur{constructor(e,t,n){void 0===t?t=0:t>e.length&&Er(),void 0===n?n=e.length-t:n>e.length-t&&Er(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===Ur.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof Ur?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return this.construct(this.segments,this.offset+(e=void 0===e?1:e),this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),s=t.get(r);if(n<s)return-1;if(n>s)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class Gr extends Ur{construct(e,t,n){return new Gr(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(0<=n.indexOf("//"))throw new Sr(_r.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>0<e.length))}return new Gr(t)}static emptyPath(){return new Gr([])}}const jr=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class Kr extends Ur{construct(e,t,n){return new Kr(e,t,n)}static isValidIdentifier(e){return jr.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),e=!Kr.isValidIdentifier(e)?"`"+e+"`":e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new Kr(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;var s=()=>{if(0===n.length)throw new Sr(_r.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new Sr(_r.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new Sr(_r.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?i=!i:"."!==t||i?n+=t:s(),r++}if(s(),i)throw new Sr(_r.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new Kr(t)}static emptyPath(){return new Kr([])}}class $r{constructor(e){this.path=e}static fromPath(e){return new $r(Gr.fromString(e))}static fromName(e){return new $r(Gr.fromString(e).popFirst(5))}static empty(){return new $r(Gr.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return 2<=this.path.length&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===Gr.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return Gr.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new $r(new Gr(e.slice()))}}class zr{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function Qr(e){return e.fields.find(e=>2===e.kind)}function Wr(e){return e.fields.filter(e=>2!==e.kind)}zr.UNKNOWN_ID=-1;class Hr{constructor(e,t){this.fieldPath=e,this.kind=t}}class Yr{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new Yr(0,Zr.min())}}function Xr(e,t){var n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1,r=qr.fromTimestamp(1e9===r?new Br(n+1,0):new Br(n,r));return new Zr(r,$r.empty(),t)}function Jr(e){return new Zr(e.readTime,e.key,-1)}class Zr{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new Zr(qr.min(),$r.empty(),-1)}static max(){return new Zr(qr.max(),$r.empty(),-1)}}function es(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=$r.comparator(e.documentKey,t.documentKey),0!==n?n:Fr(e.largestBatchId,t.largestBatchId))}const ts="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class ns{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function rs(e){if(e.code!==_r.FAILED_PRECONDITION||e.message!==ts)throw e;vr("LocalStore","Unexpectedly lost primary lease")}class ss{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(r,s){return this.callbackAttached&&Er(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(s,this.error):this.wrapSuccess(r,this.result):new ss((t,n)=>{this.nextCallback=e=>{this.wrapSuccess(r,e).next(t,n)},this.catchCallback=e=>{this.wrapFailure(s,e).next(t,n)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{var t=e();return t instanceof ss?t:ss.resolve(t)}catch(e){return ss.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):ss.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):ss.reject(t)}static resolve(n){return new ss((e,t)=>{e(n)})}static reject(n){return new ss((e,t)=>{t(n)})}static waitFor(e){return new ss((t,n)=>{let r=0,s=0,i=!1;e.forEach(e=>{++r,e.next(()=>{++s,i&&s===r&&t()},e=>n(e))}),i=!0,s===r&&t()})}static or(e){let t=ss.resolve(!1);for(const n of e)t=t.next(e=>e?ss.resolve(e):n());return t}static forEach(e,n){const r=[];return e.forEach((e,t)=>{r.push(n.call(this,e,t))}),this.waitFor(r)}static mapArray(o,u){return new ss((t,n)=>{const r=o.length,s=new Array(r);let i=0;for(let e=0;e<r;e++){const a=e;u(o[a]).next(e=>{s[a]=e,++i,i===r&&t(s)},e=>n(e))}})}static doWhile(r,s){return new ss((e,t)=>{const n=()=>{!0===r()?s().next(()=>{n()},t):e()};n()})}}class is{constructor(n,e){this.action=n,this.transaction=e,this.aborted=!1,this.R=new xr,this.transaction.oncomplete=()=>{this.R.resolve()},this.transaction.onabort=()=>{e.error?this.R.reject(new us(n,e.error)):this.R.resolve()},this.transaction.onerror=e=>{var t=fs(e.target.error);this.R.reject(new us(n,t))}}static open(e,t,n,r){try{return new is(t,e.transaction(r,n))}catch(e){throw new us(t,e)}}get v(){return this.R.promise}abort(e){e&&this.R.reject(e),this.aborted||(vr("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}P(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){var t=this.transaction.objectStore(e);return new hs(t)}}class as{constructor(e,t,n){this.name=e,this.version=t,this.V=n,12.2===as.S(u())&&wr("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return vr("SimpleDb","Removing database:",e),ls(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!function(){try{return"object"==typeof indexedDB}catch(e){return}}())return!1;if(as.C())return!0;const e=u(),t=as.S(e),n=0<t&&t<10,r=as.N(e),s=0<r&&r<4.5;return!(0<e.indexOf("MSIE ")||0<e.indexOf("Trident/")||0<e.indexOf("Edge/")||n||s)}static C(){var e;return"undefined"!=typeof process&&"YES"===(null===(e=process.env)||void 0===e?void 0:e.k)}static O(e,t){return e.store(t)}static S(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static N(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async $(i){return this.db||(vr("SimpleDb","Opening database:",this.name),this.db=await new Promise((n,r)=>{const s=indexedDB.open(this.name,this.version);s.onsuccess=e=>{var t=e.target.result;n(t)},s.onblocked=()=>{r(new us(i,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},s.onerror=e=>{var t=e.target.error;"VersionError"===t.name?r(new Sr(_r.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===t.name?r(new Sr(_r.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+t)):r(new us(i,t))},s.onupgradeneeded=e=>{vr("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);var t=e.target.result;this.V.M(t,s.transaction,e.oldVersion,this.version).next(()=>{vr("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.F&&(this.db.onversionchange=e=>this.F(e)),this.db}B(t){this.F=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(e,t,n,r){var s="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.$(e);const t=is.open(this.db,e,s?"readonly":"readwrite",n),i=r(t).next(e=>(t.P(),e)).catch(e=>(t.abort(e),ss.reject(e))).toPromise();return i.catch(()=>{}),await t.v,i}catch(e){const t=e,n="FirebaseError"!==t.name&&i<3;if(vr("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class os{constructor(e){this.L=e,this.q=!1,this.U=null}get isDone(){return this.q}get K(){return this.U}set cursor(e){this.L=e}done(){this.q=!0}G(e){this.U=e}delete(){return ls(this.L.delete())}}class us extends Sr{constructor(e,t){super(_r.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function cs(e){return"IndexedDbTransactionError"===e.name}class hs{constructor(e){this.store=e}put(e,t){let n;return n=void 0!==t?(vr("SimpleDb","PUT",this.store.name,e,t),this.store.put(t,e)):(vr("SimpleDb","PUT",this.store.name,"<auto-key>",e),this.store.put(e)),ls(n)}add(e){return vr("SimpleDb","ADD",this.store.name,e,e),ls(this.store.add(e))}get(t){return ls(this.store.get(t)).next(e=>(vr("SimpleDb","GET",this.store.name,t,e=void 0===e?null:e),e))}delete(e){return vr("SimpleDb","DELETE",this.store.name,e),ls(this.store.delete(e))}count(){return vr("SimpleDb","COUNT",this.store.name),ls(this.store.count())}j(e,n){var t=this.options(e,n);if(t.index||"function"!=typeof this.store.getAll){const e=this.cursor(t),n=[];return this.W(e,(e,t)=>{n.push(t)}).next(()=>n)}{const e=this.store.getAll(t.range);return new ss((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}}H(e,t){const r=this.store.getAll(e,null===t?void 0:t);return new ss((t,n)=>{r.onerror=e=>{n(e.target.error)},r.onsuccess=e=>{t(e.target.result)}})}J(e,t){vr("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.Y=!1;var r=this.cursor(n);return this.W(r,(e,t,n)=>n.delete())}Z(e,t){let n;t?n=e:(n={},t=e);var r=this.cursor(n);return this.W(r,t)}X(s){const e=this.cursor({});return new ss((n,r)=>{e.onerror=e=>{var t=fs(e.target.error);r(t)},e.onsuccess=e=>{const t=e.target.result;t?s(t.primaryKey,t.value).next(e=>{e?t.continue():n()}):n()}})}W(e,i){const a=[];return new ss((s,t)=>{e.onerror=e=>{t(e.target.error)},e.onsuccess=e=>{const t=e.target.result;if(t){const n=new os(t),r=i(t.primaryKey,t.value,n);if(r instanceof ss){const e=r.catch(e=>(n.done(),ss.reject(e)));a.push(e)}n.isDone?s():null===n.K?t.continue():t.continue(n.K)}else s()}}).next(()=>ss.waitFor(a))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.Y?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function ls(e){return new ss((n,r)=>{e.onsuccess=e=>{var t=e.target.result;n(t)},e.onerror=e=>{var t=fs(e.target.error);r(t)}})}let ds=!1;function fs(e){const t=as.S(u());if(12.2<=t&&t<13){const t="An internal error was encountered in the Indexed Database server";if(0<=e.message.indexOf(t)){const e=new Sr("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return ds||(ds=!0,setTimeout(()=>{throw e},0)),e}}return e}class ms{constructor(e,t){this.asyncQueue=e,this.tt=t,this.task=null}start(){this.et(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}et(e){vr("IndexBackiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{vr("IndexBackiller",`Documents written: ${await this.tt.nt()}`)}catch(e){cs(e)?vr("IndexBackiller","Ignoring IndexedDB error during index backfill: ",e):await rs(e)}await this.et(6e4)})}}class gs{constructor(e,t){this.localStore=e,this.persistence=t}async nt(t=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",e=>this.st(e,t))}st(e,t){const n=new Set;let r=t,s=!0;return ss.doWhile(()=>!0===s&&0<r,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>null===t||n.has(t)?void(s=!1):(vr("IndexBackiller",`Processing collection: ${t}`),this.it(e,t,r).next(e=>{r-=e,n.add(t)})))).next(()=>t-r)}it(r,s,e){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(r,s).next(n=>this.localStore.localDocuments.getNextDocuments(r,s,n,e).next(e=>{const t=e.changes;return this.localStore.indexManager.updateIndexEntries(r,t).next(()=>this.rt(n,e)).next(e=>(vr("IndexBackiller",`Updating offset: ${e}`),this.localStore.indexManager.updateCollectionGroup(r,s,e))).next(()=>t.size)}))}rt(e,t){let r=e;return t.changes.forEach((e,t)=>{var n=Jr(t);0<es(n,r)&&(r=n)}),new Zr(r.readTime,r.documentKey,Math.max(t.batchId,e.largestBatchId))}}class ps{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ot(e),this.ut=e=>t.writeSequenceNumber(e))}ot(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){var e=++this.previousValue;return this.ut&&this.ut(e),e}}function ys(e){return null==e}function vs(e){return 0===e&&1/e==-1/0}function ws(e){return"number"==typeof e&&Number.isInteger(e)&&!vs(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function Is(e){let t="";for(let n=0;n<e.length;n++)0<t.length&&(t=bs(t)),t=function(e,t){let n=t;const r=e.length;for(let s=0;s<r;s++){const r=e.charAt(s);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}(e.get(n),t);return bs(t)}function bs(e){return e+""}function Es(t){const n=t.length;if(Tr(2<=n),2===n)return Tr(""===t.charAt(0)&&""===t.charAt(1)),Gr.emptyPath();const __PRIVATE_lastReasonableEscapeIndex=n-2,r=[];let s="";for(let a=0;a<n;){const n=t.indexOf("",a);switch((n<0||n>__PRIVATE_lastReasonableEscapeIndex)&&Er(),t.charAt(n+1)){case"":var i=t.substring(a,n);let e;0===s.length?e=i:(s+=i,e=s,s=""),r.push(e);break;case"":s+=t.substring(a,n),s+="\0";break;case"":s+=t.substring(a,n+1);break;default:Er()}a=n+2}return new Gr(r)}ps.ct=-1;const Ts=["userId","batchId"];function _s(e,t){return[e,Is(t)]}function Ss(e,t,n){return[e,Is(t),n]}const xs={},Ds=["prefixPath","collectionGroup","readTime","documentId"],Cs=["prefixPath","collectionGroup","documentId"],As=["collectionGroup","readTime","prefixPath","documentId"],Ns=["canonicalId","targetId"],ks=["targetId","path"],Rs=["path","targetId"],Ls=["collectionId","parent"],Ms=["indexId","uid"],Os=["uid","sequenceNumber"],Fs=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],Vs=["indexId","uid","orderedDocumentKey"],Ps=["userId","collectionPath","documentId"],Bs=["userId","collectionPath","largestBatchId"],qs=["userId","collectionGroup","largestBatchId"],Us=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],Gs=[...Us,"documentOverlays"],js=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],Ks=js,$s=[...Ks,"indexConfiguration","indexState","indexEntries"];class zs extends ns{constructor(e,t){super(),this.at=e,this.currentSequenceNumber=t}}function Qs(e,t){var n=e;return as.O(n.at,t)}function Ws(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function Hs(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function Ys(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class Xs{constructor(e,t){this.comparator=e,this.root=t||Zs.EMPTY}insert(e,t){return new Xs(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,Zs.BLACK,null,null))}remove(e){return new Xs(this.comparator,this.root.remove(e,this.comparator).copy(null,null,Zs.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){var n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:0<n&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){var r=this.comparator(e,n.key);if(0===r)return t+n.left.size;n=r<0?n.left:(t+=n.left.size+1,n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(n){this.inorderTraversal((e,t)=>(n(e,t),!1))}toString(){const n=[];return this.inorderTraversal((e,t)=>(n.push(`${e}:${t}`),!1)),`{${n.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new Js(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new Js(this.root,e,this.comparator,!1)}getReverseIterator(){return new Js(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new Js(this.root,e,this.comparator,!0)}}class Js{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?n(e.key,t):1,t&&r&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();var t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return 0<this.nodeStack.length}peek(){if(0===this.nodeStack.length)return null;var e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class Zs{constructor(e,t,n,r,s){this.key=e,this.value=t,this.color=null!=n?n:Zs.RED,this.left=null!=r?r:Zs.EMPTY,this.right=null!=s?s:Zs.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,s){return new Zs(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;var s=n(e,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===s?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return Zs.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return Zs.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){var e=this.copy(null,null,Zs.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){var e=this.copy(null,null,Zs.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){var e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){var e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Er();if(this.right.isRed())throw Er();var e=this.left.check();if(e!==this.right.check())throw Er();return e+(this.isRed()?0:1)}}Zs.EMPTY=null,Zs.RED=!0,Zs.BLACK=!1,Zs.EMPTY=new class{constructor(){this.size=0}get key(){throw Er()}get value(){throw Er()}get color(){throw Er()}get left(){throw Er()}get right(){throw Er()}copy(e,t,n,r,s){return this}insert(e,t,n){return new Zs(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class ei{constructor(e){this.comparator=e,this.data=new Xs(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(n){this.data.inorderTraversal((e,t)=>(n(e),!1))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,e[1]))return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new ti(this.data.getIterator())}getIteratorFrom(e){return new ti(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof ei))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const t=[];return this.forEach(e=>{t.push(e)}),t}toString(){const t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(e){const t=new ei(this.comparator);return t.data=e,t}}class ti{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function ni(e){return e.hasNext()?e.getNext():void 0}class ri{constructor(e){(this.fields=e).sort(Kr.comparator)}static empty(){return new ri([])}unionWith(e){let t=new ei(Kr.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new ri(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return Vr(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class si extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class ii{constructor(e){this.binaryString=e}static fromBase64String(e){var t=function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new si("Invalid base64 string: "+e):e}}(e);return new ii(t)}static fromUint8Array(e){var t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new ii(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return Fr(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}ii.EMPTY_BYTE_STRING=new ii("");const ai=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function oi(t){if(Tr(!!t),"string"!=typeof t)return{seconds:ui(t.seconds),nanos:ui(t.nanos)};{let e=0;var n=ai.exec(t);Tr(!!n),n[1]&&(n=((n=n[1])+"000000000").substr(0,9),e=Number(n));const r=new Date(t);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}}function ui(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function ci(e){return"string"==typeof e?ii.fromBase64String(e):ii.fromUint8Array(e)}function hi(e){var t;return"server_timestamp"===(null===(t=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===t?void 0:t.stringValue)}function li(e){var t=oi(e.mapValue.fields.__local_write_time__.timestampValue);return new Br(t.seconds,t.nanos)}class di{constructor(e,t,n,r,s,i,a,o){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=a,this.useFetchStreams=o}}class fi{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new fi("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof fi&&e.projectId===this.projectId&&e.database===this.database}}const mi={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},gi={nullValue:"NULL_VALUE"};function pi(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?hi(e)?4:Ai(e)?9007199254740991:10:Er()}function yi(r,s){if(r===s)return!0;var e,t,n=pi(r);if(n!==pi(s))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return r.booleanValue===s.booleanValue;case 4:return li(r).isEqual(li(s));case 3:return function(e){if("string"==typeof r.timestampValue&&"string"==typeof e.timestampValue&&r.timestampValue.length===e.timestampValue.length)return r.timestampValue===e.timestampValue;var t=oi(r.timestampValue),n=oi(e.timestampValue);return t.seconds===n.seconds&&t.nanos===n.nanos}(s);case 5:return r.stringValue===s.stringValue;case 6:return t=s,ci(r.bytesValue).isEqual(ci(t.bytesValue));case 7:return r.referenceValue===s.referenceValue;case 8:return e=s,ui((t=r).geoPointValue.latitude)===ui(e.geoPointValue.latitude)&&ui(t.geoPointValue.longitude)===ui(e.geoPointValue.longitude);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return ui(e.integerValue)===ui(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){var n=ui(e.doubleValue),r=ui(t.doubleValue);return n===r?vs(n)===vs(r):isNaN(n)&&isNaN(r)}return!1}(r,s);case 9:return Vr(r.arrayValue.values||[],s.arrayValue.values||[],yi);case 10:return function(e){const t=e.mapValue.fields||{},n=s.mapValue.fields||{};if(Ws(t)!==Ws(n))return!1;for(const e in t)if(t.hasOwnProperty(e)&&(void 0===n[e]||!yi(t[e],n[e])))return!1;return!0}(r);default:return Er()}}function vi(e,t){return void 0!==(e.values||[]).find(e=>yi(e,t))}function wi(e,t){if(e===t)return 0;var n,r,s,i,a=pi(e),o=pi(t);if(a!==o)return Fr(a,o);switch(a){case 0:case 9007199254740991:return 0;case 1:return Fr(e.booleanValue,t.booleanValue);case 2:return r=t,s=ui(e.integerValue||e.doubleValue),i=ui(r.integerValue||r.doubleValue),s<i?-1:i<s?1:s===i?0:isNaN(s)?isNaN(i)?0:-1:1;case 3:return Ii(e.timestampValue,t.timestampValue);case 4:return Ii(li(e),li(t));case 5:return Fr(e.stringValue,t.stringValue);case 6:return function(e,t){const n=ci(e),r=ci(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){var n=e.split("/"),r=t.split("/");for(let s=0;s<n.length&&s<r.length;s++){const t=Fr(n[s],r[s]);if(0!==t)return t}return Fr(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return n=e.geoPointValue,r=t.geoPointValue,0!==(i=Fr(ui(n.latitude),ui(r.latitude)))?i:Fr(ui(n.longitude),ui(r.longitude));case 9:return function(e,t){var n=e.values||[],r=t.values||[];for(let s=0;s<n.length&&s<r.length;++s){const t=wi(n[s],r[s]);if(t)return t}return Fr(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){if(e===mi.mapValue&&t===mi.mapValue)return 0;if(e===mi.mapValue)return 1;if(t===mi.mapValue)return-1;const n=e.fields||{},r=Object.keys(n),s=t.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let o=0;o<r.length&&o<i.length;++o){const t=Fr(r[o],i[o]);if(0!==t)return t;var a=wi(n[r[o]],s[i[o]]);if(0!==a)return a}return Fr(r.length,i.length)}(e.mapValue,t.mapValue);default:throw Er()}}function Ii(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return Fr(e,t);var n=oi(e),r=oi(t),s=Fr(n.seconds,r.seconds);return 0!==s?s:Fr(n.nanos,r.nanos)}function bi(e){return function i(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=oi(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?ci(e.bytesValue).toBase64():"referenceValue"in e?(t=e.referenceValue,$r.fromName(t).toString()):"geoPointValue"in e?`geo(${(t=e.geoPointValue).latitude},${t.longitude})`:"arrayValue"in e?function(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=i(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const s of t)r?r=!1:n+=",",n+=`${s}:${i(e.fields[s])}`;return n+"}"}(e.mapValue):Er();var t}(e)}function Ei(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function Ti(e){return e&&"integerValue"in e}function _i(e){return!!e&&"arrayValue"in e}function Si(e){return e&&"nullValue"in e}function xi(e){return e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function Di(e){return e&&"mapValue"in e}function Ci(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const n={mapValue:{fields:{}}};return Hs(t.mapValue.fields,(e,t)=>n.mapValue.fields[e]=Ci(t)),n}if(t.arrayValue){const r={arrayValue:{values:[]}};for(let e=0;e<(t.arrayValue.values||[]).length;++e)r.arrayValue.values[e]=Ci(t.arrayValue.values[e]);return r}return Object.assign({},t)}function Ai(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function Ni(e,t){var n=wi(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function ki(e,t){var n=wi(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class Ri{constructor(e){this.value=e}static empty(){return new Ri({mapValue:{}})}field(n){if(n.isEmpty())return this.value;{let e=this.value;for(let t=0;t<n.length-1;++t)if(e=(e.mapValue.fields||{})[n.get(t)],!Di(e))return null;return e=(e.mapValue.fields||{})[n.lastSegment()],e||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=Ci(t)}setAll(e){let n=Kr.emptyPath(),r={},s=[];e.forEach((e,t)=>{if(!n.isImmediateParentOf(t)){const e=this.getFieldsMap(n);this.applyChanges(e,r,s),r={},s=[],n=t.popLast()}e?r[t.lastSegment()]=Ci(e):s.push(t.lastSegment())});var t=this.getFieldsMap(n);this.applyChanges(t,r,s)}delete(e){const t=this.field(e.popLast());Di(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return yi(this.value,e.value)}getFieldsMap(t){let n=this.value;n.mapValue.fields||(n.mapValue={fields:{}});for(let r=0;r<t.length;++r){let e=n.mapValue.fields[t.get(r)];Di(e)&&e.mapValue.fields||(e={mapValue:{fields:{}}},n.mapValue.fields[t.get(r)]=e),n=e}return n.mapValue.fields}applyChanges(n,e,t){Hs(e,(e,t)=>n[e]=t);for(const e of t)delete n[e]}clone(){return new Ri(Ci(this.value))}}class Li{constructor(e,t,n,r,s,i,a){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=s,this.data=i,this.documentState=a}static newInvalidDocument(e){return new Li(e,0,qr.min(),qr.min(),qr.min(),Ri.empty(),0)}static newFoundDocument(e,t,n,r){return new Li(e,1,t,qr.min(),n,r,0)}static newNoDocument(e,t){return new Li(e,2,t,qr.min(),qr.min(),Ri.empty(),0)}static newUnknownDocument(e,t){return new Li(e,3,t,qr.min(),qr.min(),Ri.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(qr.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Ri.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Ri.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=qr.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof Li&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new Li(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Mi{constructor(e,t){this.position=e,this.inclusive=t}}function Oi(e,t,n){let r=0;for(let s=0;s<e.position.length;s++){const i=t[s],a=e.position[s];if(r=i.field.isKeyField()?$r.comparator($r.fromName(a.referenceValue),n.key):wi(a,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return r}function Fi(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!yi(e.position[n],t.position[n]))return!1;return!0}class Vi{constructor(e,t="asc"){this.field=e,this.dir=t}}class Pi{}class Bi extends Pi{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new Qi(e,t,n):"array-contains"===t?new Xi(e,n):"in"===t?new Ji(e,n):"not-in"===t?new Zi(e,n):"array-contains-any"===t?new ea(e,n):new Bi(e,t,n)}static createKeyFieldInFilter(e,t,n){return new("in"===t?Wi:Hi)(e,n)}matches(e){var t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(wi(t,this.value)):null!==t&&pi(this.value)===pi(t)&&this.matchesComparison(wi(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return 0<e;case">=":return 0<=e;default:return Er()}}isInequality(){return 0<=["<","<=",">",">=","!=","not-in"].indexOf(this.op)}getFlattenedFilters(){return[this]}getFilters(){return[this]}getFirstInequalityField(){return this.isInequality()?this.field:null}}class qi extends Pi{constructor(e,t){super(),this.filters=e,this.op=t,this.ht=null}static create(e,t){return new qi(e,t)}matches(t){return Ui(this)?void 0===this.filters.find(e=>!e.matches(t)):void 0!==this.filters.find(e=>e.matches(t))}getFlattenedFilters(){return null!==this.ht||(this.ht=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ht}getFilters(){return Object.assign([],this.filters)}getFirstInequalityField(){var e=this.lt(e=>e.isInequality());return null!==e?e.field:null}lt(e){for(const t of this.getFlattenedFilters())if(e(t))return t;return null}}function Ui(e){return"and"===e.op}function Gi(e){return"or"===e.op}function ji(e){return Ki(e)&&Ui(e)}function Ki(e){for(const t of e.filters)if(t instanceof qi)return!1;return!0}function $i(e,t){var n=e.filters.concat(t);return qi.create(n,e.op)}function zi(e){return e instanceof Bi?`${(t=e).field.canonicalString()} ${t.op} ${bi(t.value)}`:e instanceof qi?(e=e).op.toString()+" {"+e.getFilters().map(zi).join(" ,")+"}":"Filter";var t}class Qi extends Bi{constructor(e,t,n){super(e,t,n),this.key=$r.fromName(n.referenceValue)}matches(e){var t=$r.comparator(e.key,this.key);return this.matchesComparison(t)}}class Wi extends Bi{constructor(e,t){super(e,"in",t),this.keys=Yi(0,t)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}}class Hi extends Bi{constructor(e,t){super(e,"not-in",t),this.keys=Yi(0,t)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}}function Yi(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map(e=>$r.fromName(e.referenceValue))}class Xi extends Bi{constructor(e,t){super(e,"array-contains",t)}matches(e){var t=e.data.field(this.field);return _i(t)&&vi(t.arrayValue,this.value)}}class Ji extends Bi{constructor(e,t){super(e,"in",t)}matches(e){var t=e.data.field(this.field);return null!==t&&vi(this.value.arrayValue,t)}}class Zi extends Bi{constructor(e,t){super(e,"not-in",t)}matches(e){if(vi(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;var t=e.data.field(this.field);return null!==t&&!vi(this.value.arrayValue,t)}}class ea extends Bi{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!_i(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>vi(this.value.arrayValue,e))}}class ta{constructor(e,t=null,n=[],r=[],s=null,i=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=a,this.ft=null}}function na(e,t=null,n=[],r=[],s=null,i=null,a=null){return new ta(e,t,n,r,s,i,a)}function ra(e){const t=e;if(null===t.ft){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(e=>function t(e){if(e instanceof Bi)return e.field.canonicalString()+e.op.toString()+bi(e.value);if(ji(e))return e.filters.map(e=>t(e)).join(",");var n=e.filters.map(e=>t(e)).join(",");return`${e.op}(${n})`}(e)).join(","),e+="|ob:",e+=t.orderBy.map(e=>function(e){return e.field.canonicalString()+e.dir}(e)).join(","),ys(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(e=>bi(e)).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(e=>bi(e)).join(",")),t.ft=e}return t.ft}function sa(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let s=0;s<e.orderBy.length;s++)if(n=e.orderBy[s],r=t.orderBy[s],n.dir!==r.dir||!n.field.isEqual(r.field))return!1;var n,r;if(e.filters.length!==t.filters.length)return!1;for(let i=0;i<e.filters.length;i++)if(!function r(e,t){return e instanceof Bi?(n=e,(i=t)instanceof Bi&&n.op===i.op&&n.field.isEqual(i.field)&&yi(n.value,i.value)):e instanceof qi?(s=t)instanceof qi&&e.op===s.op&&e.filters.length===s.filters.length&&e.filters.reduce((e,t,n)=>e&&r(t,s.filters[n]),!0):void Er();var s,n,i}(e.filters[i],t.filters[i]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!Fi(e.startAt,t.startAt)&&Fi(e.endAt,t.endAt)}function ia(e){return $r.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function aa(e,t){return e.filters.filter(e=>e instanceof Bi&&e.field.isEqual(t))}function oa(t,n,r){let s=gi,i=!0;for(const r of aa(t,n)){let e=gi,t=!0;switch(r.op){case"<":case"<=":e="nullValue"in(a=r.value)?gi:"booleanValue"in a?{booleanValue:!1}:"integerValue"in a||"doubleValue"in a?{doubleValue:NaN}:"timestampValue"in a?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in a?{stringValue:""}:"bytesValue"in a?{bytesValue:""}:"referenceValue"in a?Ei(fi.empty(),$r.empty()):"geoPointValue"in a?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in a?{arrayValue:{}}:"mapValue"in a?{mapValue:{}}:Er();break;case"==":case"in":case">=":e=r.value;break;case">":e=r.value,t=!1;break;case"!=":case"not-in":e=gi}Ni({value:s,inclusive:i},{value:e,inclusive:t})<0&&(s=e,i=t)}var a;if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];Ni({value:s,inclusive:i},{value:t,inclusive:r.inclusive})<0&&(s=t,i=r.inclusive);break}return{value:s,inclusive:i}}function ua(t,n,r){let s=mi,i=!0;for(const r of aa(t,n)){let e=mi,t=!0;switch(r.op){case">=":case">":e="nullValue"in(a=r.value)?{booleanValue:!1}:"booleanValue"in a?{doubleValue:NaN}:"integerValue"in a||"doubleValue"in a?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in a?{stringValue:""}:"stringValue"in a?{bytesValue:""}:"bytesValue"in a?Ei(fi.empty(),$r.empty()):"referenceValue"in a?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in a?{arrayValue:{}}:"arrayValue"in a?{mapValue:{}}:"mapValue"in a?mi:Er(),t=!1;break;case"==":case"in":case"<=":e=r.value;break;case"<":e=r.value,t=!1;break;case"!=":case"not-in":e=mi}0<ki({value:s,inclusive:i},{value:e,inclusive:t})&&(s=e,i=t)}var a;if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];0<ki({value:s,inclusive:i},{value:t,inclusive:r.inclusive})&&(s=t,i=r.inclusive);break}return{value:s,inclusive:i}}class ca{constructor(e,t=null,n=[],r=[],s=null,i="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=a,this.endAt=o,this.dt=null,this.wt=null,this.startAt,this.endAt}}function ha(e,t,n,r,s,i,a,o){return new ca(e,t,n,r,s,i,a,o)}function la(e){return new ca(e)}function da(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function fa(e){return 0<e.explicitOrderBy.length?e.explicitOrderBy[0].field:null}function ma(e){for(const t of e.filters){const e=t.getFirstInequalityField();if(null!==e)return e}return null}function ga(e){return null!==e.collectionGroup}function pa(t){const n=t;if(null===n.dt){n.dt=[];const t=ma(n),e=fa(n);if(null!==t&&null===e)t.isKeyField()||n.dt.push(new Vi(t)),n.dt.push(new Vi(Kr.keyField(),"asc"));else{let e=!1;for(const r of n.explicitOrderBy)n.dt.push(r),r.field.isKeyField()&&(e=!0);if(!e){const t=0<n.explicitOrderBy.length?n.explicitOrderBy[n.explicitOrderBy.length-1].dir:"asc";n.dt.push(new Vi(Kr.keyField(),t))}}}return n.dt}function ya(e){const t=e;if(!t.wt)if("F"===t.limitType)t.wt=na(t.path,t.collectionGroup,pa(t),t.filters,t.limit,t.startAt,t.endAt);else{const e=[];for(const s of pa(t)){const t="desc"===s.dir?"asc":"desc";e.push(new Vi(s.field,t))}var n=t.endAt?new Mi(t.endAt.position,t.endAt.inclusive):null,r=t.startAt?new Mi(t.startAt.position,t.startAt.inclusive):null;t.wt=na(t.path,t.collectionGroup,e,t.filters,t.limit,n,r)}return t.wt}function va(e,t){t.getFirstInequalityField(),ma(e);var n=e.filters.concat([t]);return new ca(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function wa(e,t,n){return new ca(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function Ia(e,t){return sa(ya(e),ya(t))&&e.limitType===t.limitType}function ba(e){return`${ra(ya(e))}|lt:${e.limitType}`}function Ea(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),0<e.filters.length&&(t+=`, filters: [${e.filters.map(e=>zi(e)).join(", ")}]`),ys(e.limit)||(t+=", limit: "+e.limit),0<e.orderBy.length&&(t+=`, orderBy: [${e.orderBy.map(e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e)).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(e=>bi(e)).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(e=>bi(e)).join(",")),`Target(${t})`}(ya(e))}; limitType=${e.limitType})`}function Ta(n,e){return e.isFoundDocument()&&(s=n,a=(i=e).key.path,null!==s.collectionGroup?i.key.hasCollectionId(s.collectionGroup)&&s.path.isPrefixOf(a):$r.isDocumentKey(s.path)?s.path.isEqual(a):s.path.isImmediateParentOf(a))&&function(e){for(const t of pa(n))if(!t.field.isKeyField()&&null===e.data.field(t.field))return;return 1}(e)&&function(e){for(const t of n.filters)if(!t.matches(e))return;return 1}(e)&&(s=e,(!(e=n).startAt||(t=e.startAt,r=Oi(t,pa(e),s),t.inclusive?r<=0:r<0))&&(!e.endAt||(t=e.endAt,r=Oi(t,pa(e),s),t.inclusive?0<=r:0<r)));var t,r,s,i,a}function _a(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function Sa(s){return(e,t)=>{let n=!1;for(const r of pa(s)){const s=function(e,s,t){var n=e.field.isKeyField()?$r.comparator(s.key,t.key):function(e,t){var n=s.data.field(e),r=t.data.field(e);return null!==n&&null!==r?wi(n,r):Er()}(e.field,t);switch(e.dir){case"asc":return n;case"desc":return-1*n;default:return Er()}}(r,e,t);if(0!==s)return s;n=n||r.field.isKeyField()}return 0}}class xa{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,r]of n)if(this.equalsFn(t,e))return r}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let s=0;s<r.length;s++)if(this.equalsFn(r[s][0],e))return void(r[s]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(r){Hs(this.inner,(e,t)=>{for(const[e,n]of t)r(e,n)})}isEmpty(){return Ys(this.inner)}size(){return this.innerSize}}const Da=new Xs($r.comparator);const Ca=new Xs($r.comparator);function Aa(...e){let t=Ca;for(const n of e)t=t.insert(n.key,n);return t}function Na(e){let n=Ca;return e.forEach((e,t)=>n=n.insert(e,t.overlayedDocument)),n}function ka(){return new xa(e=>e.toString(),(e,t)=>e.isEqual(t))}const Ra=new Xs($r.comparator),La=new ei($r.comparator);function Ma(...e){let t=La;for(const n of e)t=t.add(n);return t}const Oa=new ei(Fr);function Fa(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:vs(t)?"-0":t}}function Va(e){return{integerValue:""+e}}function Pa(e,t){return ws(t)?Va(t):Fa(e,t)}class Ba{constructor(){this._=void 0}}function qa(e,t){return e instanceof za?Ti(n=t)||n&&"doubleValue"in n?t:{integerValue:0}:null;var n}class Ua extends Ba{}class Ga extends Ba{constructor(e){super(),this.elements=e}}function ja(e,t){const n=Wa(t);for(const t of e.elements)n.some(e=>yi(e,t))||n.push(t);return{arrayValue:{values:n}}}class Ka extends Ba{constructor(e){super(),this.elements=e}}function $a(e,t){let n=Wa(t);for(const t of e.elements)n=n.filter(e=>!yi(e,t));return{arrayValue:{values:n}}}class za extends Ba{constructor(e,t){super(),this.serializer=e,this._t=t}}function Qa(e){return ui(e.integerValue||e.doubleValue)}function Wa(e){return _i(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class Ha{constructor(e,t){this.field=e,this.transform=t}}class Ya{constructor(e,t){this.version=e,this.transformResults=t}}class Xa{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new Xa}static exists(e){return new Xa(void 0,e)}static updateTime(e){return new Xa(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function Ja(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class Za{}function eo(e,n){if(!e.hasLocalMutations||n&&0===n.fields.length)return null;if(null===n)return e.isNoDocument()?new co(e.key,Xa.none()):new so(e.key,e.data,Xa.none());{const s=e.data,i=Ri.empty();let t=new ei(Kr.comparator);for(var r of n.fields)if(!t.has(r)){let e=s.field(r);null===e&&1<r.length&&(r=r.popLast(),e=s.field(r)),null===e?i.delete(r):i.set(r,e),t=t.add(r)}return new io(e.key,i,new ri(t.toArray()),Xa.none())}}function to(e,t,n){e instanceof so?function(e,t,n){const r=e.value.clone(),s=oo(e.fieldTransforms,t,n.transformResults);r.setAll(s),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof io?function(e,t,n){if(!Ja(e.precondition,t))return t.convertToUnknownDocument(n.version);const r=oo(e.fieldTransforms,t,n.transformResults),s=t.data;s.setAll(ao(e)),s.setAll(r),t.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(e,t,n):t.convertToNoDocument(n.version).setHasCommittedMutations()}function no(e,t,n,r){return e instanceof so?function(e,t,n,r){if(!Ja(e.precondition,t))return n;const s=e.value.clone(),i=uo(e.fieldTransforms,r,t);return s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null}(e,t,n,r):e instanceof io?function(e,t,n,r){if(!Ja(e.precondition,t))return n;const s=uo(e.fieldTransforms,r,t),i=t.data;return i.setAll(ao(e)),i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map(e=>e.field))}(e,t,n,r):(t=t,n=n,Ja(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n)}function ro(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||n&&r&&Vr(n,r,(e,t)=>function(e,t){return e.field.isEqual(t.field)&&(e=e.transform,t=t.transform,e instanceof Ga&&t instanceof Ga||e instanceof Ka&&t instanceof Ka?Vr(e.elements,t.elements,yi):e instanceof za&&t instanceof za?yi(e._t,t._t):e instanceof Ua&&t instanceof Ua)}(e,t)))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask)));var n,r}class so extends Za{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class io extends Za{constructor(e,t,n,r,s=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function ao(n){const r=new Map;return n.fieldMask.fields.forEach(e=>{var t;e.isEmpty()||(t=n.data.field(e),r.set(e,t))}),r}function oo(e,t,n){const r=new Map;Tr(e.length===n.length);for(let h=0;h<n.length;h++){var s=e[h],i=s.transform,a=t.data.field(s.field);r.set(s.field,(o=i,u=a,c=n[h],o instanceof Ga?ja(o,u):o instanceof Ka?$a(o,u):c))}var o,u,c;return r}function uo(e,t,n){const r=new Map;for(const c of e){const e=c.transform,h=n.data.field(c.field);r.set(c.field,(s=e,i=h,a=t,u=o=void 0,s instanceof Ua?function(){const e={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:a.seconds,nanos:a.nanoseconds}}}};return i&&(e.fields.__previous_value__=i),{mapValue:e}}():s instanceof Ga?ja(s,i):s instanceof Ka?$a(s,i):(o=qa(s=s,i),u=Qa(o)+Qa(s._t),Ti(o)&&Ti(s._t)?Va(u):Fa(s.serializer,u))))}var s,i,a,o,u;return r}class co extends Za{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class ho extends Za{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class lo{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){var n=t.mutationResults;for(let r=0;r<this.mutations.length;r++){const s=this.mutations[r];s.key.isEqual(e.key)&&to(s,e,n[r])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=no(n,e,t,this.localWriteTime));for(const r of this.mutations)r.key.isEqual(e.key)&&(t=no(r,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(i,a){const o=ka();return this.mutations.forEach(e=>{const t=i.get(e.key),n=t.overlayedDocument;let r=this.applyToLocalView(n,t.mutatedFields);r=a.has(e.key)?null:r;var s=eo(n,r);null!==s&&o.set(e.key,s),n.isValidDocument()||n.convertToNoDocument(qr.min())}),o}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),Ma())}isEqual(e){return this.batchId===e.batchId&&Vr(this.mutations,e.mutations,(e,t)=>ro(e,t))&&Vr(this.baseMutations,e.baseMutations,(e,t)=>ro(e,t))}}class fo{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){Tr(e.mutations.length===n.length);let r=Ra;var s=e.mutations;for(let i=0;i<s.length;i++)r=r.insert(s[i].key,n[i].version);return new fo(e,t,n,r)}}class mo{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class go{constructor(e){this.count=e}}function po(e){switch(e){default:return Er(),0;case _r.CANCELLED:case _r.UNKNOWN:case _r.DEADLINE_EXCEEDED:case _r.RESOURCE_EXHAUSTED:case _r.INTERNAL:case _r.UNAVAILABLE:case _r.UNAUTHENTICATED:return;case _r.INVALID_ARGUMENT:case _r.NOT_FOUND:case _r.ALREADY_EXISTS:case _r.PERMISSION_DENIED:case _r.FAILED_PRECONDITION:case _r.ABORTED:case _r.OUT_OF_RANGE:case _r.UNIMPLEMENTED:case _r.DATA_LOSS:return 1}}function yo(e){if(void 0===e)return wr("GRPC error has no .code"),_r.UNKNOWN;switch(e){case rr.OK:return _r.OK;case rr.CANCELLED:return _r.CANCELLED;case rr.UNKNOWN:return _r.UNKNOWN;case rr.DEADLINE_EXCEEDED:return _r.DEADLINE_EXCEEDED;case rr.RESOURCE_EXHAUSTED:return _r.RESOURCE_EXHAUSTED;case rr.INTERNAL:return _r.INTERNAL;case rr.UNAVAILABLE:return _r.UNAVAILABLE;case rr.UNAUTHENTICATED:return _r.UNAUTHENTICATED;case rr.INVALID_ARGUMENT:return _r.INVALID_ARGUMENT;case rr.NOT_FOUND:return _r.NOT_FOUND;case rr.ALREADY_EXISTS:return _r.ALREADY_EXISTS;case rr.PERMISSION_DENIED:return _r.PERMISSION_DENIED;case rr.FAILED_PRECONDITION:return _r.FAILED_PRECONDITION;case rr.ABORTED:return _r.ABORTED;case rr.OUT_OF_RANGE:return _r.OUT_OF_RANGE;case rr.UNIMPLEMENTED:return _r.UNIMPLEMENTED;case rr.DATA_LOSS:return _r.DATA_LOSS;default:return Er()}}(at=rr=rr||{})[at.OK=0]="OK",at[at.CANCELLED=1]="CANCELLED",at[at.UNKNOWN=2]="UNKNOWN",at[at.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",at[at.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",at[at.NOT_FOUND=5]="NOT_FOUND",at[at.ALREADY_EXISTS=6]="ALREADY_EXISTS",at[at.PERMISSION_DENIED=7]="PERMISSION_DENIED",at[at.UNAUTHENTICATED=16]="UNAUTHENTICATED",at[at.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",at[at.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",at[at.ABORTED=10]="ABORTED",at[at.OUT_OF_RANGE=11]="OUT_OF_RANGE",at[at.UNIMPLEMENTED=12]="UNIMPLEMENTED",at[at.INTERNAL=13]="INTERNAL",at[at.UNAVAILABLE=14]="UNAVAILABLE",at[at.DATA_LOSS=15]="DATA_LOSS";class vo{constructor(){this.onExistenceFilterMismatchCallbacks=new Map}static get instance(){return wo}static getOrCreateInstance(){return null===wo&&(wo=new vo),wo}onExistenceFilterMismatch(e){const t=Symbol();return this.onExistenceFilterMismatchCallbacks.set(t,e),()=>this.onExistenceFilterMismatchCallbacks.delete(t)}notifyOnExistenceFilterMismatch(t){this.onExistenceFilterMismatchCallbacks.forEach(e=>e(t))}}let wo=null;class Io{constructor(e,t,n,r,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,bo.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new Io(qr.min(),r,Oa,Da,Ma())}}class bo{constructor(e,t,n,r,s){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new bo(n,t,Ma(),Ma(),Ma())}}class Eo{constructor(e,t,n,r){this.It=e,this.removedTargetIds=t,this.key=n,this.Tt=r}}class To{constructor(e,t){this.targetId=e,this.Et=t}}class _o{constructor(e,t,n=ii.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class So{constructor(){this.At=0,this.Rt=Co(),this.vt=ii.EMPTY_BYTE_STRING,this.bt=!1,this.Pt=!0}get current(){return this.bt}get resumeToken(){return this.vt}get Vt(){return 0!==this.At}get St(){return this.Pt}Dt(e){0<e.approximateByteSize()&&(this.Pt=!0,this.vt=e)}Ct(){let n=Ma(),r=Ma(),s=Ma();return this.Rt.forEach((e,t)=>{switch(t){case 0:n=n.add(e);break;case 2:r=r.add(e);break;case 1:s=s.add(e);break;default:Er()}}),new bo(this.vt,this.bt,n,r,s)}xt(){this.Pt=!1,this.Rt=Co()}Nt(e,t){this.Pt=!0,this.Rt=this.Rt.insert(e,t)}kt(e){this.Pt=!0,this.Rt=this.Rt.remove(e)}Ot(){this.At+=1}$t(){--this.At}Mt(){this.Pt=!0,this.bt=!0}}class xo{constructor(e){this.Ft=e,this.Bt=new Map,this.Lt=Da,this.qt=Do(),this.Ut=new ei(Fr)}Kt(e){for(const t of e.It)e.Tt&&e.Tt.isFoundDocument()?this.Gt(t,e.Tt):this.Qt(t,e.key,e.Tt);for(const n of e.removedTargetIds)this.Qt(n,e.key,e.Tt)}zt(n){this.forEachTarget(n,e=>{const t=this.jt(e);switch(n.state){case 0:this.Wt(e)&&t.Dt(n.resumeToken);break;case 1:t.$t(),t.Vt||t.xt(),t.Dt(n.resumeToken);break;case 2:t.$t(),t.Vt||this.removeTarget(e);break;case 3:this.Wt(e)&&(t.Mt(),t.Dt(n.resumeToken));break;case 4:this.Wt(e)&&(this.Ht(e),t.Dt(n.resumeToken));break;default:Er()}})}forEachTarget(e,n){0<e.targetIds.length?e.targetIds.forEach(n):this.Bt.forEach((e,t)=>{this.Wt(t)&&n(t)})}Jt(e){const t=e.targetId,n=e.Et.count,r=this.Yt(t);if(r){var s=r.target;if(ia(s))if(0===n){const e=new $r(s.path);this.Qt(t,e,Li.newNoDocument(e,qr.min()))}else Tr(1===n);else{const r=this.Zt(t);r!==n&&(this.Ht(t),this.Ut=this.Ut.add(t),null===(s=vo.instance)||void 0===s||s.notifyOnExistenceFilterMismatch({localCacheCount:r,existenceFilterCount:e.Et.count}))}}}Xt(r){const s=new Map;this.Bt.forEach((e,t)=>{var n=this.Yt(t);if(n){if(e.current&&ia(n.target)){const s=new $r(n.target.path);null!==this.Lt.get(s)||this.te(t,s)||this.Qt(t,s,Li.newNoDocument(s,r))}e.St&&(s.set(t,e.Ct()),e.xt())}});let i=Ma();this.qt.forEach((e,t)=>{let n=!0;t.forEachWhile(e=>{var t=this.Yt(e);return!t||2===t.purpose||(n=!1)}),n&&(i=i.add(e))}),this.Lt.forEach((e,t)=>t.setReadTime(r));var e=new Io(r,s,this.Ut,this.Lt,i);return this.Lt=Da,this.qt=Do(),this.Ut=new ei(Fr),e}Gt(e,t){var n;this.Wt(e)&&(n=this.te(e,t.key)?2:0,this.jt(e).Nt(t.key,n),this.Lt=this.Lt.insert(t.key,t),this.qt=this.qt.insert(t.key,this.ee(t.key).add(e)))}Qt(e,t,n){if(this.Wt(e)){const r=this.jt(e);this.te(e,t)?r.Nt(t,1):r.kt(t),this.qt=this.qt.insert(t,this.ee(t).delete(e)),n&&(this.Lt=this.Lt.insert(t,n))}}removeTarget(e){this.Bt.delete(e)}Zt(e){var t=this.jt(e).Ct();return this.Ft.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Ot(e){this.jt(e).Ot()}jt(e){let t=this.Bt.get(e);return t||(t=new So,this.Bt.set(e,t)),t}ee(e){let t=this.qt.get(e);return t||(t=new ei(Fr),this.qt=this.qt.insert(e,t)),t}Wt(e){var t=null!==this.Yt(e);return t||vr("WatchChangeAggregator","Detected inactive target",e),t}Yt(e){var t=this.Bt.get(e);return t&&t.Vt?null:this.Ft.ne(e)}Ht(t){this.Bt.set(t,new So),this.Ft.getRemoteKeysForTarget(t).forEach(e=>{this.Qt(t,e,null)})}te(e,t){return this.Ft.getRemoteKeysForTarget(e).has(t)}}function Do(){return new Xs($r.comparator)}function Co(){return new Xs($r.comparator)}const Ao={asc:"ASCENDING",desc:"DESCENDING"},No={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},ko={and:"AND",or:"OR"};class Ro{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function Lo(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function Mo(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function Oo(e){return Tr(!!e),qr.fromTimestamp((t=oi(e),new Br(t.seconds,t.nanos)));var t}function Fo(e,t){return e=e,new Gr(["projects",e.projectId,"databases",e.database]).child("documents").child(t).canonicalString()}function Vo(e){var t=Gr.fromString(e);return Tr(tu(t)),t}function Po(e,t){return Fo(e.databaseId,t.path)}function Bo(e,t){const n=Vo(t);if(n.get(1)!==e.databaseId.projectId)throw new Sr(_r.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new Sr(_r.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new $r(jo(n))}function qo(e,t){return Fo(e.databaseId,t)}function Uo(e){var t=Vo(e);return 4===t.length?Gr.emptyPath():jo(t)}function Go(e){return new Gr(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function jo(e){return Tr(4<e.length&&"documents"===e.get(4)),e.popFirst(5)}function Ko(e,t,n){return{name:Po(e,t),fields:n.value.mapValue.fields}}function $o(e,t,n){const r=Bo(e,t.name),s=Oo(t.updateTime),i=t.createTime?Oo(t.createTime):qr.min(),a=new Ri({mapValue:{fields:t.fields}}),o=Li.newFoundDocument(r,s,i,a);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function zo(e,t){let n;if(t instanceof so)n={update:Ko(e,t.key,t.value)};else if(t instanceof co)n={delete:Po(e,t.key)};else if(t instanceof io)n={update:Ko(e,t.key,t.data),updateMask:function(e){const t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof ho))return Er();n={verify:Po(e,t.key)}}return 0<t.fieldTransforms.length&&(n.updateTransforms=t.fieldTransforms.map(e=>function(e){var t=e.transform;if(t instanceof Ua)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(t instanceof Ga)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:t.elements}};if(t instanceof Ka)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:t.elements}};if(t instanceof za)return{fieldPath:e.field.canonicalString(),increment:t._t};throw Er()}(e))),t.precondition.isNone||(n.currentDocument=void 0!==(r=t.precondition).updateTime?{updateTime:(t=r.updateTime,Lo(e,t.toTimestamp()))}:void 0!==r.exists?{exists:r.exists}:Er()),n;var r}function Qo(t,n){const e=n.currentDocument?void 0!==(s=n.currentDocument).updateTime?Xa.updateTime(Oo(s.updateTime)):void 0!==s.exists?Xa.exists(s.exists):Xa.none():Xa.none(),r=n.updateTransforms?n.updateTransforms.map(e=>function(e,t){let n=null;if("setToServerValue"in t)Tr("REQUEST_TIME"===t.setToServerValue),n=new Ua;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new Ga(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new Ka(e)}else"increment"in t?n=new za(e,t.increment):Er();var r=Kr.fromServerFormat(t.fieldPath);return new Ha(r,n)}(t,e)):[];var s;if(n.update){n.update.name;var i=Bo(t,n.update.name),a=new Ri({mapValue:{fields:n.update.fields}});if(n.updateMask){const t=function(){const e=n.updateMask.fieldPaths||[];return new ri(e.map(e=>Kr.fromServerFormat(e)))}();return new io(i,a,t,e,r)}return new so(i,a,e,r)}if(n.delete){const r=Bo(t,n.delete);return new co(r,e)}if(n.verify){const r=Bo(t,n.verify);return new ho(r,e)}return Er()}function Wo(e,t){return{documents:[qo(e,t.path)]}}function Ho(e,t){const n={structuredQuery:{}},r=t.path;null!==t.collectionGroup?(n.parent=qo(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=qo(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);var s=function(e){if(0!==e.length)return function n(e){return e instanceof Bi?function(e){if("=="===e.op){if(xi(e.value))return{unaryFilter:{field:Zo(e.field),op:"IS_NAN"}};if(Si(e.value))return{unaryFilter:{field:Zo(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(xi(e.value))return{unaryFilter:{field:Zo(e.field),op:"IS_NOT_NAN"}};if(Si(e.value))return{unaryFilter:{field:Zo(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Zo(e.field),op:Xo(e.op),value:e.value}}}(e):e instanceof qi?function(e){const t=e.getFilters().map(e=>n(e));return 1===t.length?t[0]:{compositeFilter:{op:Jo(e.op),filters:t}}}(e):Er()}(qi.create(e,"and"))}(t.filters);s&&(n.structuredQuery.where=s);s=function(e){if(0!==e.length)return e.map(e=>function(e){return{field:Zo(e.field),direction:(e=e.dir,Ao[e])}}(e))}(t.orderBy);s&&(n.structuredQuery.orderBy=s);var i,s=(i=t.limit,e.useProto3Json||ys(i)?i:{value:i});return null!==s&&(n.structuredQuery.limit=s),t.startAt&&(n.structuredQuery.startAt={before:(s=t.startAt).inclusive,values:s.position}),t.endAt&&(n.structuredQuery.endAt={before:!(t=t.endAt).inclusive,values:t.position}),n}function Yo(e){let t=Uo(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let s=null;if(0<r){Tr(1===r);const m=n.from[0];m.allDescendants?s=m.collectionId:t=t.child(m.collectionId)}let i=[];n.where&&(i=function(){const e=function t(e){return void 0!==e.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":const t=eu(e.unaryFilter.field);return Bi.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=eu(e.unaryFilter.field);return Bi.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=eu(e.unaryFilter.field);return Bi.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const s=eu(e.unaryFilter.field);return Bi.create(s,"!=",{nullValue:"NULL_VALUE"});default:return Er()}}(e):void 0!==e.fieldFilter?function(e){return Bi.create(eu(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return Er()}}(e.fieldFilter.op),e.fieldFilter.value)}(e):void 0!==e.compositeFilter?function(e){return qi.create(e.compositeFilter.filters.map(e=>t(e)),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return Er()}}(e.compositeFilter.op))}(e):Er()}(n.where);return e instanceof qi&&ji(e)?e.getFilters():[e]}());let a=[];n.orderBy&&(a=n.orderBy.map(e=>function(e){return new Vi(eu(e.field),function(){switch(e.direction){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}())}(e)));let o=null;var u,c,h,l;n.limit&&(o=(e=n.limit,ys(u="object"==typeof e?e.value:e)?null:u));let d=null;n.startAt&&(d=(c=n.startAt,l=!!c.before,h=c.values||[],new Mi(h,l)));let f=null;return n.endAt&&(f=(c=n.endAt,h=!c.before,l=c.values||[],new Mi(l,h))),ha(t,s,a,i,o,"F",d,f)}function Xo(e){return No[e]}function Jo(e){return ko[e]}function Zo(e){return{fieldPath:e.canonicalString()}}function eu(e){return Kr.fromServerFormat(e.fieldPath)}function tu(e){return 4<=e.length&&"projects"===e.get(0)&&"databases"===e.get(2)}class nu{constructor(e,t,n,r,s=qr.min(),i=qr.min(),a=ii.EMPTY_BYTE_STRING){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=a}withSequenceNumber(e){return new nu(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(e,t){return new nu(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e)}withLastLimboFreeSnapshotVersion(e){return new nu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken)}}class ru{constructor(e){this.se=e}}function su(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:iu(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document={name:Po(s=e.se,(e=t).key),fields:e.data.value.mapValue.fields,updateTime:Lo(s,e.version.toTimestamp()),createTime:Lo(s,e.createTime.toTimestamp())};else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:au(t.version)};else{if(!t.isUnknownDocument())return Er();r.unknownDocument={path:n.path.toArray(),version:au(t.version)}}var s;return r}function iu(e){var t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function au(e){var t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function ou(e){var t=new Br(e.seconds,e.nanoseconds);return qr.fromTimestamp(t)}function uu(t,e){const n=(e.baseMutations||[]).map(e=>Qo(t.se,e));for(let i=0;i<e.mutations.length-1;++i){const n=e.mutations[i];if(i+1<e.mutations.length&&void 0!==e.mutations[i+1].transform){const r=e.mutations[i+1];n.updateTransforms=r.transform.fieldTransforms,e.mutations.splice(i+1,1),++i}}const r=e.mutations.map(e=>Qo(t.se,e)),s=Br.fromMillis(e.localWriteTimeMs);return new lo(e.batchId,s,n,r)}function cu(e){var t,n=ou(e.readTime),r=void 0!==e.lastLimboFreeSnapshotVersion?ou(e.lastLimboFreeSnapshotVersion):qr.min();let s;return s=void 0!==e.query.documents?(Tr(1===(t=e.query).documents.length),ya(la(Uo(t.documents[0])))):ya(Yo(e.query)),new nu(s,e.targetId,0,e.lastListenSequenceNumber,n,r,ii.fromBase64String(e.resumeToken))}function hu(e,t){var n=au(t.snapshotVersion),r=au(t.lastLimboFreeSnapshotVersion),s=(ia(t.target)?Wo:Ho)(e.se,t.target),i=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:ra(t.target),readTime:n,resumeToken:i,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:s}}function lu(e){var t=Yo({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?wa(t,t.limit,"L"):t}function du(e,t){return new mo(t.largestBatchId,Qo(e.se,t.overlayMutation))}function fu(e,t){var n=t.path.lastSegment();return[e,Is(t.path.popLast()),n]}function mu(e,t,n,r){return{indexId:e,uid:t.uid||"",sequenceNumber:n,readTime:au(r.readTime),documentKey:Is(r.documentKey.path),largestBatchId:r.largestBatchId}}class gu{getBundleMetadata(e,t){return pu(e).get(t).next(e=>{if(e)return{id:(t=e).bundleId,createTime:ou(t.createTime),version:t.version};var t})}saveBundleMetadata(e,t){return pu(e).put({bundleId:(n=t).id,createTime:au(Oo(n.createTime)),version:n.version});var n}getNamedQuery(e,t){return yu(e).get(t).next(e=>{if(e)return{name:(t=e).name,query:lu(t.bundledQuery),readTime:ou(t.readTime)};var t})}saveNamedQuery(e,t){return yu(e).put({name:(t=t).name,readTime:au(Oo(t.readTime)),bundledQuery:t.bundledQuery})}}function pu(e){return Qs(e,"bundles")}function yu(e){return Qs(e,"namedQueries")}class vu{constructor(e,t){this.serializer=e,this.userId=t}static ie(e,t){var n=t.uid||"";return new vu(e,n)}getOverlay(e,t){return wu(e).get(fu(this.userId,t)).next(e=>e?du(this.serializer,e):null)}getOverlays(e,t){const n=ka();return ss.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(r,s,e){const i=[];return e.forEach((e,t)=>{var n=new mo(s,t);i.push(this.re(r,n))}),ss.waitFor(i)}removeOverlaysForBatchId(n,e,r){const t=new Set;e.forEach(e=>t.add(Is(e.getCollectionPath())));const s=[];return t.forEach(e=>{var t=IDBKeyRange.bound([this.userId,e,r],[this.userId,e,r+1],!1,!0);s.push(wu(n).J("collectionPathOverlayIndex",t))}),ss.waitFor(s)}getOverlaysForCollection(e,t,n){const r=ka(),s=Is(t),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return wu(e).j("collectionPathOverlayIndex",i).next(e=>{for(const t of e){const e=du(this.serializer,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,s){const i=ka();let a;var r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return wu(e).Z({index:"collectionGroupOverlayIndex",range:r},(e,t,n)=>{const r=du(this.serializer,t);i.size()<s||r.largestBatchId===a?(i.set(r.getKey(),r),a=r.largestBatchId):n.done()}).next(()=>i)}re(e,t){return wu(e).put(function(e,t,n){var[,r,s]=fu(t,n.mutation.key);return{userId:t,collectionPath:r,documentId:s,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:zo(e.se,n.mutation)}}(this.serializer,this.userId,t))}}function wu(e){return Qs(e,"documentOverlays")}class Iu{constructor(){}oe(e,t){this.ue(e,t),t.ce()}ue(e,t){var n,r;"nullValue"in e?this.ae(t,5):"booleanValue"in e?(this.ae(t,10),t.he(e.booleanValue?1:0)):"integerValue"in e?(this.ae(t,15),t.he(ui(e.integerValue))):"doubleValue"in e?(n=ui(e.doubleValue),isNaN(n)?this.ae(t,13):(this.ae(t,15),vs(n)?t.he(0):t.he(n))):"timestampValue"in e?(r=e.timestampValue,this.ae(t,20),"string"==typeof r?t.le(r):(t.le(`${r.seconds||""}`),t.he(r.nanos||0))):"stringValue"in e?(this.fe(e.stringValue,t),this.de(t)):"bytesValue"in e?(this.ae(t,30),t.we(ci(e.bytesValue)),this.de(t)):"referenceValue"in e?this._e(e.referenceValue,t):"geoPointValue"in e?(r=e.geoPointValue,this.ae(t,45),t.he(r.latitude||0),t.he(r.longitude||0)):"mapValue"in e?Ai(e)?this.ae(t,Number.MAX_SAFE_INTEGER):(this.me(e.mapValue,t),this.de(t)):"arrayValue"in e?(this.ge(e.arrayValue,t),this.de(t)):Er()}fe(e,t){this.ae(t,25),this.ye(e,t)}ye(e,t){t.le(e)}me(e,t){var n=e.fields||{};this.ae(t,55);for(const e of Object.keys(n))this.fe(e,t),this.ue(n[e],t)}ge(e,t){var n=e.values||[];this.ae(t,50);for(const e of n)this.ue(e,t)}_e(e,t){this.ae(t,37),$r.fromName(e).path.forEach(e=>{this.ae(t,60),this.ye(e,t)})}ae(e,t){e.he(t)}de(e){e.he(2)}}function bu(e){var t=64-function(e){let t=0;for(let r=0;r<8;++r){var n=function(e){if(0===e)return 8;let t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}(255&e[r]);if(t+=n,8!==n)break}return t}(e);return Math.ceil(t/8)}Iu.pe=new Iu;class Eu{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ie(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Te(n.value),n=t.next();this.Ee()}Ae(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Re(n.value),n=t.next();this.ve()}be(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Te(e);else if(e<2048)this.Te(960|e>>>6),this.Te(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Te(480|e>>>12),this.Te(128|63&e>>>6),this.Te(128|63&e);else{const e=t.codePointAt(0);this.Te(240|e>>>18),this.Te(128|63&e>>>12),this.Te(128|63&e>>>6),this.Te(128|63&e)}}this.Ee()}Pe(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Re(e);else if(e<2048)this.Re(960|e>>>6),this.Re(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Re(480|e>>>12),this.Re(128|63&e>>>6),this.Re(128|63&e);else{const e=t.codePointAt(0);this.Re(240|e>>>18),this.Re(128|63&e>>>12),this.Re(128|63&e>>>6),this.Re(128|63&e)}}this.ve()}Ve(e){var t=this.Se(e),n=bu(t);this.De(1+n),this.buffer[this.position++]=255&n;for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=255&t[r]}Ce(e){var t=this.Se(e),n=bu(t);this.De(1+n),this.buffer[this.position++]=~(255&n);for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=~(255&t[r])}xe(){this.Ne(255),this.Ne(255)}ke(){this.Oe(255),this.Oe(255)}reset(){this.position=0}seed(e){this.De(e.length),this.buffer.set(e,this.position),this.position+=e.length}$e(){return this.buffer.slice(0,this.position)}Se(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=0!=(128&t[0]);t[0]^=n?255:128;for(let r=1;r<t.length;++r)t[r]^=n?255:0;return t}Te(e){var t=255&e;0==t?(this.Ne(0),this.Ne(255)):255==t?(this.Ne(255),this.Ne(0)):this.Ne(t)}Re(e){var t=255&e;0==t?(this.Oe(0),this.Oe(255)):255==t?(this.Oe(255),this.Oe(0)):this.Oe(e)}Ee(){this.Ne(0),this.Ne(1)}ve(){this.Oe(0),this.Oe(1)}Ne(e){this.De(1),this.buffer[this.position++]=e}Oe(e){this.De(1),this.buffer[this.position++]=~e}De(e){var t=e+this.position;if(!(t<=this.buffer.length)){let e=2*this.buffer.length;e<t&&(e=t);const n=new Uint8Array(e);n.set(this.buffer),this.buffer=n}}}class Tu{constructor(e){this.Me=e}we(e){this.Me.Ie(e)}le(e){this.Me.be(e)}he(e){this.Me.Ve(e)}ce(){this.Me.xe()}}class _u{constructor(e){this.Me=e}we(e){this.Me.Ae(e)}le(e){this.Me.Pe(e)}he(e){this.Me.Ce(e)}ce(){this.Me.ke()}}class Su{constructor(){this.Me=new Eu,this.Fe=new Tu(this.Me),this.Be=new _u(this.Me)}seed(e){this.Me.seed(e)}Le(e){return 0===e?this.Fe:this.Be}$e(){return this.Me.$e()}reset(){this.Me.reset()}}class xu{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}qe(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new xu(this.indexId,this.documentKey,this.arrayValue,n)}}function Du(e,t){let n=e.indexId-t.indexId;return 0!==n?n:(n=Cu(e.arrayValue,t.arrayValue),0!==n?n:(n=Cu(e.directionalValue,t.directionalValue),0!==n?n:$r.comparator(e.documentKey,t.documentKey)))}function Cu(e,t){for(let r=0;r<e.length&&r<t.length;++r){var n=e[r]-t[r];if(0!=n)return n}return e.length-t.length}class Au{constructor(e){this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Ue=e.orderBy,this.Ke=[];for(const t of e.filters){const e=t;e.isInequality()?this.Ge=e:this.Ke.push(e)}}Qe(e){Tr(e.collectionGroup===this.collectionId);var t=Qr(e);if(void 0!==t&&!this.ze(t))return!1;var n=Wr(e);let r=0,s=0;for(;r<n.length&&this.ze(n[r]);++r);if(r===n.length)return!0;if(void 0!==this.Ge){const e=n[r];if(!this.je(this.Ge,e)||!this.We(this.Ue[s++],e))return!1;++r}for(;r<n.length;++r){const e=n[r];if(s>=this.Ue.length||!this.We(this.Ue[s++],e))return!1}return!0}ze(e){for(const t of this.Ke)if(this.je(t,e))return!0;return!1}je(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;var n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind==n}We(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function Nu(e){if(0===e.getFilters().length)return[];const t=function t(e){if(Tr(e instanceof Bi||e instanceof qi),e instanceof Bi)return e;if(1===e.filters.length)return t(e.filters[0]);const n=e.filters.map(e=>t(e));let r=qi.create(n,e.op);return r=Fu(r),Lu(r)?r:(Tr(r instanceof qi),Tr(Ui(r)),Tr(1<r.filters.length),r.filters.reduce((e,t)=>Mu(e,t)))}(function t(n){var e;if(Tr(n instanceof Bi||n instanceof qi),n instanceof Bi){if(n instanceof Ji){const r=(null===(e=null===(e=n.value.arrayValue)||void 0===e?void 0:e.values)||void 0===e?void 0:e.map(e=>Bi.create(n.field,"==",e)))||[];return qi.create(r,"or")}return n}const r=n.filters.map(e=>t(e));return qi.create(r,n.op)}(e));return Tr(Lu(t)),ku(t)||Ru(t)?[t]:t.getFilters()}function ku(e){return e instanceof Bi}function Ru(e){return e instanceof qi&&ji(e)}function Lu(e){return ku(e)||Ru(e)||function(e){if(e instanceof qi&&Gi(e)){for(const t of e.getFilters())if(!ku(t)&&!Ru(t))return!1;return!0}return!1}(e)}function Mu(e,t){var n,r;return Tr(e instanceof Bi||e instanceof qi),Tr(t instanceof Bi||t instanceof qi),Fu(e instanceof Bi?t instanceof Bi?(n=e,r=t,qi.create([n,r],"and")):Ou(e,t):t instanceof Bi?Ou(t,e):function(e,t){if(Tr(0<e.filters.length&&0<t.filters.length),Ui(e)&&Ui(t))return $i(e,t.getFilters());const n=Gi(e)?e:t,r=Gi(e)?t:e,s=n.filters.map(e=>Mu(e,r));return qi.create(s,"or")}(e,t))}function Ou(t,e){if(Ui(e))return $i(e,t.getFilters());var n=e.filters.map(e=>Mu(t,e));return qi.create(n,"or")}function Fu(t){if(Tr(t instanceof Bi||t instanceof qi),t instanceof Bi)return t;const e=t.getFilters();if(1===e.length)return Fu(e[0]);if(Ki(t))return t;const n=e.map(e=>Fu(e)),r=[];return n.forEach(e=>{e instanceof Bi?r.push(e):e instanceof qi&&(e.op===t.op?r.push(...e.filters):r.push(e))}),1===r.length?r[0]:qi.create(r,t.op)}class Vu{constructor(){this.He=new Pu}addToCollectionParentIndex(e,t){return this.He.add(t),ss.resolve()}getCollectionParents(e,t){return ss.resolve(this.He.getEntries(t))}addFieldIndex(e,t){return ss.resolve()}deleteFieldIndex(e,t){return ss.resolve()}getDocumentsMatchingTarget(e,t){return ss.resolve(null)}getIndexType(e,t){return ss.resolve(0)}getFieldIndexes(e,t){return ss.resolve([])}getNextCollectionGroupToUpdate(e){return ss.resolve(null)}getMinOffset(e,t){return ss.resolve(Zr.min())}getMinOffsetFromCollectionGroup(e,t){return ss.resolve(Zr.min())}updateCollectionGroup(e,t,n){return ss.resolve()}updateIndexEntries(e,t){return ss.resolve()}}class Pu{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new ei(Gr.comparator),s=!r.has(n);return this.index[t]=r.add(n),s}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new ei(Gr.comparator)).toArray()}}const Bu=new Uint8Array(0);class qu{constructor(e,t){this.user=e,this.databaseId=t,this.Je=new Pu,this.Ye=new xa(e=>ra(e),(e,t)=>sa(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(this.Je.has(t))return ss.resolve();var n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener(()=>{this.Je.add(t)});r={collectionId:n,parent:Is(r)};return Uu(e).put(r)}getCollectionParents(e,n){const r=[],t=IDBKeyRange.bound([n,""],[Pr(n),""],!1,!0);return Uu(e).j(t).next(e=>{for(const t of e){if(t.collectionId!==n)break;r.push(Es(t.parent))}return r})}addFieldIndex(e,t){const n=ju(e),r={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])};delete r.indexId;const s=n.add(r);if(t.indexState){const n=Ku(e);return s.next(e=>{n.put(mu(e,this.user,t.indexState.sequenceNumber,t.indexState.offset))})}return s.next()}deleteFieldIndex(e,t){const n=ju(e),r=Ku(e),s=Gu(e);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}getDocumentsMatchingTarget(e,c){const h=Gu(e);let l=!0;const n=new Map;return ss.forEach(this.Ze(c),t=>this.Xe(e,t).next(e=>{l=l&&!!e,n.set(t,e)})).next(()=>{if(l){let u=Ma();const l=[];return ss.forEach(n,(e,t)=>{vr("IndexedDbIndexManager",`Using index ${o=e,`id=${o.indexId}|cg=${o.collectionGroup}|f=${o.fields.map(e=>`${e.fieldPath}:${e.kind}`).join(",")}`} to execute ${ra(c)}`);var n=function(e,t){var n=Qr(t);if(void 0===n)return null;for(const t of aa(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(t,e),r=function(e,t){const n=new Map;for(const r of Wr(t))for(const t of aa(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(t,e),s=function(e,t){const n=[];let r=!0;for(const s of Wr(t)){const t=(0===s.kind?oa:ua)(e,s.fieldPath,e.startAt);n.push(t.value),r=r&&t.inclusive}return new Mi(n,r)}(t,e),i=function(e,t){const n=[];let r=!0;for(const s of Wr(t)){const t=(0===s.kind?ua:oa)(e,s.fieldPath,e.endAt);n.push(t.value),r=r&&t.inclusive}return new Mi(n,r)}(t,e),a=this.tn(e,t,s),o=this.tn(e,t,i),r=this.en(e,t,r),r=this.nn(e.indexId,n,a,s.inclusive,o,i.inclusive,r);return ss.forEach(r,e=>h.H(e,c.limit).next(e=>{e.forEach(e=>{var t=$r.fromSegments(e.documentKey);u.has(t)||(u=u.add(t),l.push(t))})}))}).next(()=>l)}return ss.resolve(null)})}Ze(t){let e=this.Ye.get(t);return e||(e=0===t.filters.length?[t]:Nu(qi.create(t.filters,"and")).map(e=>na(t.path,t.collectionGroup,t.orderBy,e.getFilters(),t.limit,t.startAt,t.endAt)),this.Ye.set(t,e),e)}nn(t,e,n,r,s,i,a){const o=(null!=e?e.length:1)*Math.max(n.length,s.length),u=o/(null!=e?e.length:1),c=[];for(let h=0;h<o;++h){const o=e?this.sn(e[h/u]):Bu,l=this.rn(t,o,n[h%u],r),d=this.on(t,o,s[h%u],i),f=a.map(e=>this.rn(t,o,e,!0));c.push(...this.createRange(l,d,f))}return c}rn(e,t,n,r){const s=new xu(e,$r.empty(),t,n);return r?s:s.qe()}on(e,t,n,r){const s=new xu(e,$r.empty(),t,n);return r?s.qe():s}Xe(e,t){const r=new Au(t),n=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,n).next(e=>{let t=null;for(const n of e)r.Qe(n)&&(!t||n.fields.length>t.fields.length)&&(t=n);return t})}getIndexType(e,t){let n=2;const r=this.Ze(t);return ss.forEach(r,t=>this.Xe(e,t).next(e=>{e?0!==n&&e.fields.length<function(e){let t=new ei(Kr.comparator),n=!1;for(const r of e.filters)for(const e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(const n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})).next(()=>null!==t.limit&&1<r.length&&2===n?1:n)}un(e,t){const n=new Su;for(const s of Wr(e)){const e=t.data.field(s.fieldPath);if(null==e)return null;var r=n.Le(s.kind);Iu.pe.oe(e,r)}return n.$e()}sn(e){const t=new Su;return Iu.pe.oe(e,t.Le(0)),t.$e()}cn(e,t){const n=new Su;return Iu.pe.oe(Ei(this.databaseId,t),n.Le(0===(r=Wr(e)).length?0:r[r.length-1].kind)),n.$e();var r}en(e,t,n){if(null===n)return[];let r=[];r.push(new Su);let s=0;for(const i of Wr(e)){const e=n[s++];for(const n of r)if(this.an(t,i.fieldPath)&&_i(e))r=this.hn(r,i,e);else{const t=n.Le(i.kind);Iu.pe.oe(e,t)}}return this.ln(r)}tn(e,t,n){return this.en(e,t,n.position)}ln(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].$e();return t}hn(e,t,n){const r=[...e],s=[];for(const e of n.arrayValue.values||[])for(const n of r){const r=new Su;r.seed(n.$e()),Iu.pe.oe(e,r.Le(t.kind)),s.push(r)}return s}an(e,t){return!!e.filters.find(e=>e instanceof Bi&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){const n=ju(e),r=Ku(e);return(t?n.j("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.j()).next(e=>{const i=[];return ss.forEach(e,s=>r.get([s.indexId,this.uid]).next(e=>{var t,n,r;i.push((t=s,n=(e=e)?new Yr(e.sequenceNumber,new Zr(ou(e.readTime),new $r(Es(e.documentKey)),e.largestBatchId)):Yr.empty(),r=t.fields.map(([e,t])=>new Hr(Kr.fromServerFormat(e),t)),new zr(t.indexId,t.collectionGroup,r,n)))})).next(()=>i)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{var n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!=n?n:Fr(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,n,r){const s=ju(e),i=Ku(e);return this.fn(e).next(t=>s.j("collectionGroupIndex",IDBKeyRange.bound(n,n)).next(e=>ss.forEach(e,e=>i.put(mu(e.indexId,this.user,t,r)))))}updateIndexEntries(s,e){const n=new Map;return ss.forEach(e,(t,r)=>{var e=n.get(t.collectionGroup);return(e?ss.resolve(e):this.getFieldIndexes(s,t.collectionGroup)).next(e=>(n.set(t.collectionGroup,e),ss.forEach(e,n=>this.dn(s,t,n).next(e=>{var t=this.wn(r,n);return e.isEqual(t)?ss.resolve():this._n(s,r,n,e,t)}))))})}mn(e,t,n,r){return Gu(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.cn(n,t.key),documentKey:t.key.path.toArray()})}gn(e,t,n,r){return Gu(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.cn(n,t.key),t.key.path.toArray()])}dn(e,n,r){const t=Gu(e);let s=new ei(Du);return t.Z({index:"documentKeyIndex",range:IDBKeyRange.only([r.indexId,this.uid,this.cn(r,n)])},(e,t)=>{s=s.add(new xu(r.indexId,n,t.arrayValue,t.directionalValue))}).next(()=>s)}wn(e,t){let n=new ei(Du);var r=this.un(t,e);if(null==r)return n;const s=Qr(t);if(null!=s){var i=e.data.field(s.fieldPath);if(_i(i))for(const s of i.arrayValue.values||[])n=n.add(new xu(t.indexId,e.key,this.sn(s),r))}else n=n.add(new xu(t.indexId,e.key,Bu,r));return n}_n(t,n,r,c,e){vr("IndexedDbIndexManager","Updating index entries for document '%s'",n.key);const s=[];return function(e,n,r,s){var i=c.getIterator(),a=e.getIterator();let o=ni(i),u=ni(a);for(;o||u;){let e=!1,t=!1;if(o&&u){const r=n(o,u);r<0?t=!0:0<r&&(e=!0)}else null!=o?t=!0:e=!0;e?(r(u),u=ni(a)):t?(s(o),o=ni(i)):(o=ni(i),u=ni(a))}}(e,Du,e=>{s.push(this.mn(t,n,r,e))},e=>{s.push(this.gn(t,n,r,e))}),ss.waitFor(s)}fn(e){let r=1;return Ku(e).Z({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,t,n)=>{n.done(),r=t.sequenceNumber+1}).next(()=>r)}createRange(e,t,n){n=n.sort((e,t)=>Du(e,t)).filter((e,t,n)=>!t||0!==Du(e,n[t-1]));const r=[];r.push(e);for(const s of n){const n=Du(s,e),i=Du(s,t);if(0===n)r[0]=e.qe();else if(0<n&&i<0)r.push(s),r.push(s.qe());else if(0<i)break}r.push(t);const s=[];for(let a=0;a<r.length;a+=2){if(this.yn(r[a],r[a+1]))return[];const t=[r[a].indexId,this.uid,r[a].arrayValue,r[a].directionalValue,Bu,[]],n=[r[a+1].indexId,this.uid,r[a+1].arrayValue,r[a+1].directionalValue,Bu,[]];s.push(IDBKeyRange.bound(t,n))}return s}yn(e,t){return 0<Du(e,t)}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next($u)}getMinOffset(t,e){return ss.mapArray(this.Ze(e),e=>this.Xe(t,e).next(e=>e||Er())).next($u)}}function Uu(e){return Qs(e,"collectionParents")}function Gu(e){return Qs(e,"indexEntries")}function ju(e){return Qs(e,"indexConfiguration")}function Ku(e){return Qs(e,"indexState")}function $u(e){Tr(0!==e.length);let t=e[0].indexState.offset,n=t.largestBatchId;for(let s=1;s<e.length;s++){var r=e[s].indexState.offset;es(r,t)<0&&(t=r),n<r.largestBatchId&&(n=r.largestBatchId)}return new Zr(t.readTime,t.documentKey,n)}const zu={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Qu{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new Qu(e,Qu.DEFAULT_COLLECTION_PERCENTILE,Qu.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function Wu(e,t,n){const r=e.store("mutations"),s=e.store("documentMutations"),i=[],a=IDBKeyRange.only(n.batchId);let o=0;const u=r.Z({range:a},(e,t,n)=>(o++,n.delete()));i.push(u.next(()=>{Tr(1===o)}));const c=[];for(const e of n.mutations){const r=Ss(t,e.key.path,n.batchId);i.push(s.delete(r)),c.push(e.key)}return ss.waitFor(i).next(()=>c)}function Hu(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw Er();t=e.noDocument}return JSON.stringify(t).length}Qu.DEFAULT_COLLECTION_PERCENTILE=10,Qu.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Qu.DEFAULT=new Qu(41943040,Qu.DEFAULT_COLLECTION_PERCENTILE,Qu.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Qu.DISABLED=new Qu(-1,0,0);class Yu{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.pn={}}static ie(e,t,n,r){Tr(""!==e.uid);var s=e.isAuthenticated()?e.uid:"";return new Yu(s,t,n,r)}checkEmpty(e){let r=!0;var t=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Ju(e).Z({index:"userMutationsIndex",range:t},(e,t,n)=>{r=!1,n.done()}).next(()=>r)}addMutationBatch(h,l,d,f){const m=Zu(h),g=Ju(h);return g.add({}).next(e=>{Tr("number"==typeof e);const t=new lo(e,l,d,f),n=(s=this.serializer,i=this.userId,a=t,o=a.baseMutations.map(e=>zo(s.se,e)),u=a.mutations.map(e=>zo(s.se,e)),{userId:i,batchId:a.batchId,localWriteTimeMs:a.localWriteTime.toMillis(),baseMutations:o,mutations:u}),r=[];var s,i,a,o,u;let c=new ei((e,t)=>Fr(e.canonicalString(),t.canonicalString()));for(const h of f){const l=Ss(this.userId,h.key.path,e);c=c.add(h.key.path.popLast()),r.push(g.put(n)),r.push(m.put(l,xs))}return c.forEach(e=>{r.push(this.indexManager.addToCollectionParentIndex(h,e))}),h.addOnCommittedListener(()=>{this.pn[e]=t.keys()}),ss.waitFor(r).next(()=>t)})}lookupMutationBatch(e,t){return Ju(e).get(t).next(e=>e?(Tr(e.userId===this.userId),uu(this.serializer,e)):null)}In(e,n){return this.pn[n]?ss.resolve(this.pn[n]):this.lookupMutationBatch(e,n).next(e=>{if(e){var t=e.keys();return this.pn[n]=t}return null})}getNextMutationBatchAfterBatchId(e,t){const r=t+1,n=IDBKeyRange.lowerBound([this.userId,r]);let s=null;return Ju(e).Z({index:"userMutationsIndex",range:n},(e,t,n)=>{t.userId===this.userId&&(Tr(t.batchId>=r),s=uu(this.serializer,t)),n.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(e){var t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let r=-1;return Ju(e).Z({index:"userMutationsIndex",range:t,reverse:!0},(e,t,n)=>{r=t.batchId,n.done()}).next(()=>r)}getAllMutationBatches(e){var t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Ju(e).j("userMutationsIndex",t).next(e=>e.map(e=>uu(this.serializer,e)))}getAllMutationBatchesAffectingDocumentKey(a,o){const e=_s(this.userId,o.path),t=IDBKeyRange.lowerBound(e),u=[];return Zu(a).Z({range:t},(e,t,n)=>{var[r,s,i]=e,s=Es(s);if(r===this.userId&&o.path.isEqual(s))return Ju(a).get(i).next(e=>{if(!e)throw Er();Tr(e.userId===this.userId),u.push(uu(this.serializer,e))});n.done()}).next(()=>u)}getAllMutationBatchesAffectingDocumentKeys(t,e){let o=new ei(Fr);const n=[];return e.forEach(a=>{var e=_s(this.userId,a.path),e=IDBKeyRange.lowerBound(e),e=Zu(t).Z({range:e},(e,t,n)=>{var[r,s,i]=e,s=Es(s);r===this.userId&&a.path.isEqual(s)?o=o.add(i):n.done()});n.push(e)}),ss.waitFor(n).next(()=>this.Tn(t,o))}getAllMutationBatchesAffectingQuery(e,t){const a=t.path,o=a.length+1,n=_s(this.userId,a),r=IDBKeyRange.lowerBound(n);let u=new ei(Fr);return Zu(e).Z({range:r},(e,t,n)=>{var[r,s,i]=e,s=Es(s);r===this.userId&&a.isPrefixOf(s)?s.length===o&&(u=u.add(i)):n.done()}).next(()=>this.Tn(e,u))}Tn(t,e){const n=[],r=[];return e.forEach(e=>{r.push(Ju(t).get(e).next(e=>{if(null===e)throw Er();Tr(e.userId===this.userId),n.push(uu(this.serializer,e))}))}),ss.waitFor(r).next(()=>n)}removeMutationBatch(t,n){return Wu(t.at,this.userId,n).next(e=>(t.addOnCommittedListener(()=>{this.En(n.batchId)}),ss.forEach(e,e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))}En(e){delete this.pn[e]}performConsistencyCheck(n){return this.checkEmpty(n).next(e=>{if(!e)return ss.resolve();var t=IDBKeyRange.lowerBound([this.userId]);const r=[];return Zu(n).Z({range:t},(e,t,n)=>{if(e[0]===this.userId){const t=Es(e[1]);r.push(t)}else n.done()}).next(()=>{Tr(0===r.length)})})}containsKey(e,t){return Xu(e,this.userId,t)}An(e){return ec(e).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function Xu(e,i,t){const n=_s(i,t.path),a=n[1],r=IDBKeyRange.lowerBound(n);let o=!1;return Zu(e).Z({range:r,Y:!0},(e,t,n)=>{var[r,s]=e;r===i&&s===a&&(o=!0),n.done()}).next(()=>o)}function Ju(e){return Qs(e,"mutations")}function Zu(e){return Qs(e,"documentMutations")}function ec(e){return Qs(e,"mutationQueues")}class tc{constructor(e){this.Rn=e}next(){return this.Rn+=2,this.Rn}static vn(){return new tc(0)}static bn(){return new tc(-1)}}class nc{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(n){return this.Pn(n).next(e=>{const t=new tc(e.highestTargetId);return e.highestTargetId=t.next(),this.Vn(n,e).next(()=>e.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.Pn(e).next(e=>qr.fromTimestamp(new Br(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.Pn(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(t,n,r){return this.Pn(t).next(e=>(e.highestListenSequenceNumber=n,r&&(e.lastRemoteSnapshotVersion=r.toTimestamp()),n>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=n),this.Vn(t,e)))}addTargetData(t,n){return this.Sn(t,n).next(()=>this.Pn(t).next(e=>(e.targetCount+=1,this.Dn(n,e),this.Vn(t,e))))}updateTargetData(e,t){return this.Sn(e,t)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next(()=>rc(t).delete(e.targetId)).next(()=>this.Pn(t)).next(e=>(Tr(0<e.targetCount),--e.targetCount,this.Vn(t,e)))}removeTargets(r,s,i){let a=0;const o=[];return rc(r).Z((e,t)=>{var n=cu(t);n.sequenceNumber<=s&&null===i.get(n.targetId)&&(a++,o.push(this.removeTargetData(r,n)))}).next(()=>ss.waitFor(o)).next(()=>a)}forEachTarget(e,r){return rc(e).Z((e,t)=>{var n=cu(t);r(n)})}Pn(e){return sc(e).get("targetGlobalKey").next(e=>(Tr(null!==e),e))}Vn(e,t){return sc(e).put("targetGlobalKey",t)}Sn(e,t){return rc(e).put(hu(this.serializer,t))}Dn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.Pn(e).next(e=>e.targetCount)}getTargetData(e,s){var t=ra(s),t=IDBKeyRange.bound([t,Number.NEGATIVE_INFINITY],[t,Number.POSITIVE_INFINITY]);let i=null;return rc(e).Z({range:t,index:"queryTargetsIndex"},(e,t,n)=>{var r=cu(t);sa(s,r.target)&&(i=r,n.done())}).next(()=>i)}addMatchingKeys(n,e,r){const s=[],i=ic(n);return e.forEach(e=>{var t=Is(e.path);s.push(i.put({targetId:r,path:t})),s.push(this.referenceDelegate.addReference(n,r,e))}),ss.waitFor(s)}removeMatchingKeys(n,e,r){const s=ic(n);return ss.forEach(e,e=>{var t=Is(e.path);return ss.waitFor([s.delete([r,t]),this.referenceDelegate.removeReference(n,r,e)])})}removeMatchingKeysForTargetId(e,t){const n=ic(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=ic(e);let s=Ma();return r.Z({range:n,Y:!0},(e,t,n)=>{var r=Es(e[1]),r=new $r(r);s=s.add(r)}).next(()=>s)}containsKey(e,t){var n=Is(t.path),n=IDBKeyRange.bound([n],[Pr(n)],!1,!0);let r=0;return ic(e).Z({index:"documentTargetsIndex",Y:!0,range:n},([e],t,n)=>{0!==e&&(r++,n.done())}).next(()=>0<r)}ne(e,t){return rc(e).get(t).next(e=>e?cu(e):null)}}function rc(e){return Qs(e,"targets")}function sc(e){return Qs(e,"targetGlobal")}function ic(e){return Qs(e,"targetDocuments")}function ac([e,t],[n,r]){var s=Fr(e,n);return 0===s?Fr(t,r):s}class oc{constructor(e){this.Cn=e,this.buffer=new ei(ac),this.xn=0}Nn(){return++this.xn}kn(e){var t=[e,this.Nn()];if(this.buffer.size<this.Cn)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();ac(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class uc{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.On=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.$n(6e4)}stop(){this.On&&(this.On.cancel(),this.On=null)}get started(){return null!==this.On}$n(e){vr("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.On=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.On=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){cs(e)?vr("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await rs(e)}await this.$n(3e5)})}}class cc{constructor(e,t){this.Mn=e,this.params=t}calculateTargetCount(e,t){return this.Mn.Fn(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return ss.resolve(ps.ct);const n=new oc(t);return this.Mn.forEachTarget(e,e=>n.kn(e.sequenceNumber)).next(()=>this.Mn.Bn(e,e=>n.kn(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.Mn.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.Mn.removeOrphanedDocuments(e,t)}collect(t,n){return-1===this.params.cacheSizeCollectionThreshold?(vr("LruGarbageCollector","Garbage collection skipped; disabled"),ss.resolve(zu)):this.getCacheSize(t).next(e=>e<this.params.cacheSizeCollectionThreshold?(vr("LruGarbageCollector",`Garbage collection skipped; Cache size ${e} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),zu):this.Ln(t,n))}getCacheSize(e){return this.Mn.getCacheSize(e)}Ln(t,n){let r,s,i,a,o,u,c;const h=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(e=>(s=e>this.params.maximumSequenceNumbersToCollect?(vr("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),this.params.maximumSequenceNumbersToCollect):e,a=Date.now(),this.nthSequenceNumber(t,s))).next(e=>(r=e,o=Date.now(),this.removeTargets(t,r,n))).next(e=>(i=e,u=Date.now(),this.removeOrphanedDocuments(t,r))).next(e=>(c=Date.now(),yr()<=l.DEBUG&&vr("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${a-h}ms\n\tDetermined least recently used ${s} in `+(o-a)+"ms\n"+`\tRemoved ${i} targets in `+(u-o)+"ms\n"+`\tRemoved ${e} documents in `+(c-u)+"ms\n"+`Total Duration: ${c-h}ms`),ss.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:i,documentsRemoved:e})))}}class hc{constructor(e,t){this.db=e,this.garbageCollector=(e=this,t=t,new cc(e,t))}Fn(e){const n=this.qn(e);return this.db.getTargetCache().getTargetCount(e).next(t=>n.next(e=>t+e))}qn(e){let t=0;return this.Bn(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Bn(e,n){return this.Un(e,(e,t)=>n(t))}addReference(e,t,n){return lc(e,n)}removeReference(e,t,n){return lc(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return lc(e,t)}Kn(t,n){let r=!1;return ec(t).X(e=>Xu(t,e,n).next(e=>(e&&(r=!0),ss.resolve(!e)))).next(()=>r)}removeOrphanedDocuments(n,r){const s=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[];let a=0;return this.Un(n,(t,e)=>{if(e<=r){const r=this.Kn(n,t).next(e=>{if(!e)return a++,s.getEntry(n,t).next(()=>(s.removeEntry(t,qr.min()),ic(n).delete([0,Is(t.path)])))});i.push(r)}}).next(()=>ss.waitFor(i)).next(()=>s.apply(n)).next(()=>a)}removeTarget(e,t){var n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return lc(e,t)}Un(e,r){const t=ic(e);let s,i=ps.ct;return t.Z({index:"documentTargetsIndex"},([e],{path:t,sequenceNumber:n})=>{0===e?(i!==ps.ct&&r(new $r(Es(s)),i),i=n,s=t):i=ps.ct}).next(()=>{i!==ps.ct&&r(new $r(Es(s)),i)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function lc(e,t){return ic(e).put((e=e.currentSequenceNumber,{targetId:0,path:Is(t.path),sequenceNumber:e}))}class dc{constructor(){this.changes=new xa(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,Li.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();var n=this.changes.get(t);return void 0!==n?ss.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class fc{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return yc(e).put(n)}removeEntry(e,n,t){return yc(e).delete(function(e){const t=n.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],iu(e),t[t.length-1]]}(t))}updateMetadata(t,n){return this.getMetadata(t).next(e=>(e.byteSize+=n,this.Gn(t,e)))}getEntry(e,n){let r=Li.newInvalidDocument(n);return yc(e).Z({index:"documentKeyIndex",range:IDBKeyRange.only(vc(n))},(e,t)=>{r=this.Qn(n,t)}).next(()=>r)}zn(e,n){let r={size:0,document:Li.newInvalidDocument(n)};return yc(e).Z({index:"documentKeyIndex",range:IDBKeyRange.only(vc(n))},(e,t)=>{r={document:this.Qn(n,t),size:Hu(t)}}).next(()=>r)}getEntries(e,t){let r=Da;return this.jn(e,t,(e,t)=>{var n=this.Qn(e,t);r=r.insert(e,n)}).next(()=>r)}Wn(e,t){let r=Da,s=new Xs($r.comparator);return this.jn(e,t,(e,t)=>{var n=this.Qn(e,t);r=r.insert(e,n),s=s.insert(e,Hu(t))}).next(()=>({documents:r,Hn:s}))}jn(e,t,s){if(t.isEmpty())return ss.resolve();let n=new ei(Ic);t.forEach(e=>n=n.add(e));const r=IDBKeyRange.bound(vc(n.first()),vc(n.last())),i=n.getIterator();let a=i.getNext();return yc(e).Z({index:"documentKeyIndex",range:r},(e,t,n)=>{for(var r=$r.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);a&&Ic(a,r)<0;)s(a,null),a=i.getNext();a&&a.isEqual(r)&&(s(a,t),a=i.hasNext()?i.getNext():null),a?n.G(vc(a)):n.done()}).next(()=>{for(;a;)s(a,null),a=i.hasNext()?i.getNext():null})}getDocumentsMatchingQuery(e,r,t,s){const n=r.path,i=[n.popLast().toArray(),n.lastSegment(),iu(t.readTime),t.documentKey.path.isEmpty()?"":t.documentKey.path.lastSegment()],a=[n.popLast().toArray(),n.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return yc(e).j(IDBKeyRange.bound(i,a,!0)).next(e=>{let t=Da;for(const n of e){const e=this.Qn($r.fromSegments(n.prefixPath.concat(n.collectionGroup,n.documentId)),n);e.isFoundDocument()&&(Ta(r,e)||s.has(e.key))&&(t=t.insert(e.key,e))}return t})}getAllFromCollectionGroup(e,t,n,s){let i=Da;var r=wc(t,n),a=wc(t,Zr.max());return yc(e).Z({index:"collectionGroupIndex",range:IDBKeyRange.bound(r,a,!0)},(e,t,n)=>{var r=this.Qn($r.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);i=i.insert(r.key,r),i.size===s&&n.done()}).next(()=>i)}newChangeBuffer(e){return new gc(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return pc(e).get("remoteDocumentGlobalKey").next(e=>(Tr(!!e),e))}Gn(e,t){return pc(e).put("remoteDocumentGlobalKey",t)}Qn(e,t){if(t){const e=function(e,t){let n;if(t.document)n=$o(e.se,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=$r.fromSegments(t.noDocument.path),s=ou(t.noDocument.readTime);n=Li.newNoDocument(e,s),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return Er();{const e=$r.fromSegments(t.unknownDocument.path),i=ou(t.unknownDocument.version);n=Li.newUnknownDocument(e,i)}}return t.readTime&&n.setReadTime((t=t.readTime,r=new Br(t[0],t[1]),qr.fromTimestamp(r))),n;var r}(this.serializer,t);if(!e.isNoDocument()||!e.version.isEqual(qr.min()))return e}return Li.newInvalidDocument(e)}}function mc(e){return new fc(e)}class gc extends dc{constructor(e,t){super(),this.Jn=e,this.trackRemovals=t,this.Yn=new xa(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(i){const a=[];let o=0,u=new ei((e,t)=>Fr(e.canonicalString(),t.canonicalString()));return this.changes.forEach((e,t)=>{var n=this.Yn.get(e);if(a.push(this.Jn.removeEntry(i,e,n.readTime)),t.isValidDocument()){var r=su(this.Jn.serializer,t);u=u.add(e.path.popLast());var s=Hu(r);o+=s-n.size,a.push(this.Jn.addEntry(i,e,r))}else if(o-=n.size,this.trackRemovals){const o=su(this.Jn.serializer,t.convertToNoDocument(qr.min()));a.push(this.Jn.addEntry(i,e,o))}}),u.forEach(e=>{a.push(this.Jn.indexManager.addToCollectionParentIndex(i,e))}),a.push(this.Jn.updateMetadata(i,o)),ss.waitFor(a)}getFromCache(e,t){return this.Jn.zn(e,t).next(e=>(this.Yn.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.Jn.Wn(e,t).next(({documents:n,Hn:e})=>(e.forEach((e,t)=>{this.Yn.set(e,{size:t,readTime:n.get(e).readTime})}),n))}}function pc(e){return Qs(e,"remoteDocumentGlobal")}function yc(e){return Qs(e,"remoteDocumentsV14")}function vc(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function wc(e,t){const n=t.documentKey.path.toArray();return[e,iu(t.readTime),n.slice(0,n.length-2),0<n.length?n[n.length-1]:""]}function Ic(e,t){var n=e.path.toArray(),r=t.path.toArray();let s=0;for(let i=0;i<n.length-2&&i<r.length-2;++i)if(s=Fr(n[i],r[i]),s)return s;return s=Fr(n.length,r.length),s||(s=Fr(n[n.length-2],r[r.length-2]),s||Fr(n[n.length-1],r[r.length-1]))}class bc{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class Ec{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(t,n){let r=null;return this.documentOverlayCache.getOverlay(t,n).next(e=>(r=e,this.remoteDocumentCache.getEntry(t,n))).next(e=>(null!==r&&no(r.mutation,e,ri.empty(),Br.now()),e))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.getLocalViewOfDocuments(t,e,Ma()).next(()=>e))}getLocalViewOfDocuments(e,t,n=Ma()){const r=ka();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let n=Aa();return e.forEach((e,t)=>{n=n.insert(e,t.overlayedDocument)}),n}))}getOverlayedDocuments(e,t){const n=ka();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,Ma()))}populateOverlays(e,n,t){const r=[];return t.forEach(e=>{n.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,t)=>{n.set(e,t)})})}computeViews(e,t,r,s){let i=Da;const a=ka(),o=ka();return t.forEach((e,t)=>{const n=r.get(t.key);s.has(t.key)&&(void 0===n||n.mutation instanceof io)?i=i.insert(t.key,t):void 0!==n?(a.set(t.key,n.mutation.getFieldMask()),no(n.mutation,t,n.mutation.getFieldMask(),Br.now())):a.set(t.key,ri.empty())}),this.recalculateAndSaveOverlays(e,i).next(e=>(e.forEach((e,t)=>a.set(e,t)),t.forEach((e,t)=>{var n;return o.set(e,new bc(t,null!==(n=a.get(e))&&void 0!==n?n:null))}),o))}recalculateAndSaveOverlays(i,a){const o=ka();let u=new Xs((e,t)=>e-t),c=Ma();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(i,a).next(e=>{for(const r of e)r.keys().forEach(e=>{var t,n=a.get(e);null!==n&&(t=o.get(e)||ri.empty(),t=r.applyToLocalView(n,t),o.set(e,t),t=(u.get(r.batchId)||Ma()).add(e),u=u.insert(r.batchId,t))})}).next(()=>{const e=[],t=u.getReverseIterator();for(;t.hasNext();){const u=t.getNext(),n=u.key,r=u.value,s=ka();r.forEach(e=>{var t;c.has(e)||(null!==(t=eo(a.get(e),o.get(e)))&&s.set(e,t),c=c.add(e))}),e.push(this.documentOverlayCache.saveOverlays(i,n,s))}return ss.waitFor(e)}).next(()=>o)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.recalculateAndSaveOverlays(t,e))}getDocumentsMatchingQuery(e,t,n){return r=t,$r.isDocumentKey(r.path)&&null===r.collectionGroup&&0===r.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):ga(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n):this.getDocumentsMatchingCollectionQuery(e,t,n);var r}getNextDocuments(i,t,a,o){return this.remoteDocumentCache.getAllFromCollectionGroup(i,t,a,o).next(n=>{const e=0<o-n.size?this.documentOverlayCache.getOverlaysForCollectionGroup(i,t,a.largestBatchId,o-n.size):ss.resolve(ka());let r=-1,s=n;return e.next(e=>ss.forEach(e,(t,e)=>(r<e.largestBatchId&&(r=e.largestBatchId),n.get(t)?ss.resolve():this.remoteDocumentCache.getEntry(i,t).next(e=>{s=s.insert(t,e)}))).next(()=>this.populateOverlays(i,e,n)).next(()=>this.computeViews(i,s,e,Ma())).next(e=>({batchId:r,changes:Na(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new $r(t)).next(e=>{let t=Aa();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}getDocumentsMatchingCollectionGroupQuery(r,s,i){const a=s.collectionGroup;let o=Aa();return this.indexManager.getCollectionParents(r,a).next(e=>ss.forEach(e,e=>{var t,n=(t=s,e=e.child(a),new ca(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt));return this.getDocumentsMatchingCollectionQuery(r,n,i).next(e=>{e.forEach((e,t)=>{o=o.insert(e,t)})})}).next(()=>o))}getDocumentsMatchingCollectionQuery(t,i,n){let a;return this.documentOverlayCache.getOverlaysForCollection(t,i.path,n.largestBatchId).next(e=>(a=e,this.remoteDocumentCache.getDocumentsMatchingQuery(t,i,n,a))).next(r=>{a.forEach((e,t)=>{var n=t.getKey();null===r.get(n)&&(r=r.insert(n,Li.newInvalidDocument(n)))});let s=Aa();return r.forEach((e,t)=>{var n=a.get(e);void 0!==n&&no(n.mutation,t,ri.empty(),Br.now()),Ta(i,t)&&(s=s.insert(e,t))}),s})}}class Tc{constructor(e){this.serializer=e,this.Zn=new Map,this.Xn=new Map}getBundleMetadata(e,t){return ss.resolve(this.Zn.get(t))}saveBundleMetadata(e,t){return this.Zn.set(t.id,{id:t.id,version:t.version,createTime:Oo(t.createTime)}),ss.resolve()}getNamedQuery(e,t){return ss.resolve(this.Xn.get(t))}saveNamedQuery(e,t){return this.Xn.set(t.name,{name:(t=t).name,query:lu(t.bundledQuery),readTime:Oo(t.readTime)}),ss.resolve()}}class _c{constructor(){this.overlays=new Xs($r.comparator),this.ts=new Map}getOverlay(e,t){return ss.resolve(this.overlays.get(t))}getOverlays(e,t){const n=ka();return ss.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(n,r,e){return e.forEach((e,t)=>{this.re(n,r,t)}),ss.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.ts.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.ts.delete(n)),ss.resolve()}getOverlaysForCollection(e,t,n){const r=ka(),s=t.length+1,i=new $r(t.child("")),a=this.overlays.getIteratorFrom(i);for(;a.hasNext();){const e=a.getNext().value,i=e.getKey();if(!t.isPrefixOf(i.path))break;i.path.length===s&&e.largestBatchId>n&&r.set(e.getKey(),e)}return ss.resolve(r)}getOverlaysForCollectionGroup(t,e,n,r){let s=new Xs((e,t)=>e-t);const i=this.overlays.getIterator();for(;i.hasNext();){const t=i.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=s.get(t.largestBatchId);null===e&&(e=ka(),s=s.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const a=ka(),o=s.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach((e,t)=>a.set(e,t)),!(a.size()>=r)););return ss.resolve(a)}re(e,t,n){var r=this.overlays.get(n.key);if(null!==r){const e=this.ts.get(r.largestBatchId).delete(n.key);this.ts.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new mo(t,n));let s=this.ts.get(t);void 0===s&&(s=Ma(),this.ts.set(t,s)),this.ts.set(t,s.add(n.key))}}class Sc{constructor(){this.es=new ei(xc.ns),this.ss=new ei(xc.rs)}isEmpty(){return this.es.isEmpty()}addReference(e,t){var n=new xc(e,t);this.es=this.es.add(n),this.ss=this.ss.add(n)}os(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.us(new xc(e,t))}cs(e,t){e.forEach(e=>this.removeReference(e,t))}hs(e){const t=new $r(new Gr([])),n=new xc(t,e),r=new xc(t,e+1),s=[];return this.ss.forEachInRange([n,r],e=>{this.us(e),s.push(e.key)}),s}ls(){this.es.forEach(e=>this.us(e))}us(e){this.es=this.es.delete(e),this.ss=this.ss.delete(e)}fs(e){var t=new $r(new Gr([])),n=new xc(t,e),t=new xc(t,e+1);let r=Ma();return this.ss.forEachInRange([n,t],e=>{r=r.add(e.key)}),r}containsKey(e){var t=new xc(e,0),t=this.es.firstAfterOrEqual(t);return null!==t&&e.isEqual(t.key)}}class xc{constructor(e,t){this.key=e,this.ds=t}static ns(e,t){return $r.comparator(e.key,t.key)||Fr(e.ds,t.ds)}static rs(e,t){return Fr(e.ds,t.ds)||$r.comparator(e.key,t.key)}}class Dc{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.ws=1,this._s=new ei(xc.ns)}checkEmpty(e){return ss.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){var s=this.ws;this.ws++,0<this.mutationQueue.length&&this.mutationQueue[this.mutationQueue.length-1];var i=new lo(s,t,n,r);this.mutationQueue.push(i);for(const t of r)this._s=this._s.add(new xc(t.key,s)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return ss.resolve(i)}lookupMutationBatch(e,t){return ss.resolve(this.gs(t))}getNextMutationBatchAfterBatchId(e,t){var n=this.ys(t+1),n=n<0?0:n;return ss.resolve(this.mutationQueue.length>n?this.mutationQueue[n]:null)}getHighestUnacknowledgedBatchId(){return ss.resolve(0===this.mutationQueue.length?-1:this.ws-1)}getAllMutationBatches(e){return ss.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new xc(t,0),r=new xc(t,Number.POSITIVE_INFINITY),s=[];return this._s.forEachInRange([n,r],e=>{var t=this.gs(e.ds);s.push(t)}),ss.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new ei(Fr);return t.forEach(e=>{var t=new xc(e,0),n=new xc(e,Number.POSITIVE_INFINITY);this._s.forEachInRange([t,n],e=>{r=r.add(e.ds)})}),ss.resolve(this.ps(r))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let s=n;$r.isDocumentKey(s)||(s=s.child(""));var i=new xc(new $r(s),0);let a=new ei(Fr);return this._s.forEachWhile(e=>{var t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(a=a.add(e.ds)),!0)},i),ss.resolve(this.ps(a))}ps(e){const n=[];return e.forEach(e=>{var t=this.gs(e);null!==t&&n.push(t)}),n}removeMutationBatch(n,r){Tr(0===this.Is(r.batchId,"removed")),this.mutationQueue.shift();let s=this._s;return ss.forEach(r.mutations,e=>{var t=new xc(e.key,r.batchId);return s=s.delete(t),this.referenceDelegate.markPotentiallyOrphaned(n,e.key)}).next(()=>{this._s=s})}En(e){}containsKey(e,t){var n=new xc(t,0),n=this._s.firstAfterOrEqual(n);return ss.resolve(t.isEqual(n&&n.key))}performConsistencyCheck(e){return this.mutationQueue.length,ss.resolve()}Is(e,t){return this.ys(e)}ys(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}gs(e){var t=this.ys(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class Cc{constructor(e){this.Ts=e,this.docs=new Xs($r.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),s=r?r.size:0,i=this.Ts(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){var t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return ss.resolve(n?n.document.mutableCopy():Li.newInvalidDocument(t))}getEntries(e,t){let n=Da;return t.forEach(e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():Li.newInvalidDocument(e))}),ss.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let s=Da;const i=t.path,a=new $r(i.child("")),o=this.docs.getIteratorFrom(a);for(;o.hasNext();){const{key:e,value:{document:a}}=o.getNext();if(!i.isPrefixOf(e.path))break;e.path.length>i.length+1||es(Jr(a),n)<=0||(r.has(a.key)||Ta(t,a))&&(s=s.insert(a.key,a.mutableCopy()))}return ss.resolve(s)}getAllFromCollectionGroup(e,t,n,r){Er()}Es(e,t){return ss.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new Ac(this)}getSize(e){return ss.resolve(this.size)}}class Ac extends dc{constructor(e){super(),this.Jn=e}applyChanges(n){const r=[];return this.changes.forEach((e,t)=>{t.isValidDocument()?r.push(this.Jn.addEntry(n,t)):this.Jn.removeEntry(e)}),ss.waitFor(r)}getFromCache(e,t){return this.Jn.getEntry(e,t)}getAllFromCache(e,t){return this.Jn.getEntries(e,t)}}class Nc{constructor(e){this.persistence=e,this.As=new xa(e=>ra(e),sa),this.lastRemoteSnapshotVersion=qr.min(),this.highestTargetId=0,this.Rs=0,this.vs=new Sc,this.targetCount=0,this.bs=tc.vn()}forEachTarget(e,n){return this.As.forEach((e,t)=>n(t)),ss.resolve()}getLastRemoteSnapshotVersion(e){return ss.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return ss.resolve(this.Rs)}allocateTargetId(e){return this.highestTargetId=this.bs.next(),ss.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Rs&&(this.Rs=t),ss.resolve()}Sn(e){this.As.set(e.target,e);var t=e.targetId;t>this.highestTargetId&&(this.bs=new tc(t),this.highestTargetId=t),e.sequenceNumber>this.Rs&&(this.Rs=e.sequenceNumber)}addTargetData(e,t){return this.Sn(t),this.targetCount+=1,ss.resolve()}updateTargetData(e,t){return this.Sn(t),ss.resolve()}removeTargetData(e,t){return this.As.delete(t.target),this.vs.hs(t.targetId),--this.targetCount,ss.resolve()}removeTargets(n,r,s){let i=0;const a=[];return this.As.forEach((e,t)=>{t.sequenceNumber<=r&&null===s.get(t.targetId)&&(this.As.delete(e),a.push(this.removeMatchingKeysForTargetId(n,t.targetId)),i++)}),ss.waitFor(a).next(()=>i)}getTargetCount(e){return ss.resolve(this.targetCount)}getTargetData(e,t){var n=this.As.get(t)||null;return ss.resolve(n)}addMatchingKeys(e,t,n){return this.vs.os(t,n),ss.resolve()}removeMatchingKeys(t,e,n){this.vs.cs(e,n);const r=this.persistence.referenceDelegate,s=[];return r&&e.forEach(e=>{s.push(r.markPotentiallyOrphaned(t,e))}),ss.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.vs.hs(t),ss.resolve()}getMatchingKeysForTargetId(e,t){var n=this.vs.fs(t);return ss.resolve(n)}containsKey(e,t){return ss.resolve(this.vs.containsKey(t))}}class kc{constructor(e,t){this.Ps={},this.overlays={},this.Vs=new ps(0),this.Ss=!1,this.Ss=!0,this.referenceDelegate=e(this),this.Ds=new Nc(this),this.indexManager=new Vu,this.remoteDocumentCache=(e=e=>this.referenceDelegate.Cs(e),new Cc(e)),this.serializer=new ru(t),this.xs=new Tc(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Ss=!1,Promise.resolve()}get started(){return this.Ss}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new _c,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.Ps[e.toKey()];return n||(n=new Dc(t,this.referenceDelegate),this.Ps[e.toKey()]=n),n}getTargetCache(){return this.Ds}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.xs}runTransaction(e,t,n){vr("MemoryPersistence","Starting transaction:",e);const r=new Rc(this.Vs.next());return this.referenceDelegate.Ns(),n(r).next(e=>this.referenceDelegate.ks(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}Os(t,n){return ss.or(Object.values(this.Ps).map(e=>()=>e.containsKey(t,n)))}}class Rc extends ns{constructor(e){super(),this.currentSequenceNumber=e}}class Lc{constructor(e){this.persistence=e,this.$s=new Sc,this.Ms=null}static Fs(e){return new Lc(e)}get Bs(){if(this.Ms)return this.Ms;throw Er()}addReference(e,t,n){return this.$s.addReference(n,t),this.Bs.delete(n.toString()),ss.resolve()}removeReference(e,t,n){return this.$s.removeReference(n,t),this.Bs.add(n.toString()),ss.resolve()}markPotentiallyOrphaned(e,t){return this.Bs.add(t.toString()),ss.resolve()}removeTarget(e,t){this.$s.hs(t.targetId).forEach(e=>this.Bs.add(e.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.Bs.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}Ns(){this.Ms=new Set}ks(n){const r=this.persistence.getRemoteDocumentCache().newChangeBuffer();return ss.forEach(this.Bs,e=>{const t=$r.fromPath(e);return this.Ls(n,t).next(e=>{e||r.removeEntry(t,qr.min())})}).next(()=>(this.Ms=null,r.apply(n)))}updateLimboDocument(e,t){return this.Ls(e,t).next(e=>{e?this.Bs.delete(t.toString()):this.Bs.add(t.toString())})}Cs(e){return 0}Ls(e,t){return ss.or([()=>ss.resolve(this.$s.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Os(e,t)])}}class Mc{constructor(e){this.serializer=e}M(t,e,n,r){const s=new is("createOrUpgrade",e);var i;n<1&&1<=r&&(t.createObjectStore("owner"),(i=t).createObjectStore("mutationQueues",{keyPath:"userId"}),i.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Ts,{unique:!0}),i.createObjectStore("documentMutations"),Oc(t),t.createObjectStore("remoteDocuments"));let a=ss.resolve();return n<3&&3<=r&&(0!==n&&((i=t).deleteObjectStore("targetDocuments"),i.deleteObjectStore("targets"),i.deleteObjectStore("targetGlobal"),Oc(t)),a=a.next(()=>function(){const e=s.store("targetGlobal"),t={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:qr.min().toTimestamp(),targetCount:0};return e.put("targetGlobalKey",t)}())),n<4&&4<=r&&(0!==n&&(a=a.next(()=>function(r,s){return s.store("mutations").j().next(e=>{r.deleteObjectStore("mutations"),r.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Ts,{unique:!0});const t=s.store("mutations"),n=e.map(e=>t.put(e));return ss.waitFor(n)})}(t,s))),a=a.next(()=>{t.createObjectStore("clientMetadata",{keyPath:"clientId"})})),n<5&&5<=r&&(a=a.next(()=>this.qs(s))),n<6&&6<=r&&(a=a.next(()=>(t.createObjectStore("remoteDocumentGlobal"),this.Us(s)))),n<7&&7<=r&&(a=a.next(()=>this.Ks(s))),n<8&&8<=r&&(a=a.next(()=>this.Gs(t,s))),n<9&&9<=r&&(a=a.next(()=>{var e;(e=t).objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),n<10&&10<=r&&(a=a.next(()=>this.Qs(s))),n<11&&11<=r&&(a=a.next(()=>{t.createObjectStore("bundles",{keyPath:"bundleId"}),t.createObjectStore("namedQueries",{keyPath:"name"})})),n<12&&12<=r&&(a=a.next(()=>{!function(){const e=t.createObjectStore("documentOverlays",{keyPath:Ps});e.createIndex("collectionPathOverlayIndex",Bs,{unique:!1}),e.createIndex("collectionGroupOverlayIndex",qs,{unique:!1})}()})),n<13&&13<=r&&(a=a.next(()=>function(){const e=t.createObjectStore("remoteDocumentsV14",{keyPath:Ds});e.createIndex("documentKeyIndex",Cs),e.createIndex("collectionGroupIndex",As)}()).next(()=>this.zs(t,s)).next(()=>t.deleteObjectStore("remoteDocuments"))),n<14&&14<=r&&(a=a.next(()=>this.js(t,s))),n<15&&15<=r&&(a=a.next(()=>function(e){e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:Ms}).createIndex("sequenceNumberIndex",Os,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:Fs}).createIndex("documentKeyIndex",Vs,{unique:!1})}(t))),a}Us(t){let n=0;return t.store("remoteDocuments").Z((e,t)=>{n+=Hu(t)}).next(()=>{var e={byteSize:n};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",e)})}qs(r){const e=r.store("mutationQueues"),t=r.store("mutations");return e.j().next(e=>ss.forEach(e,n=>{var e=IDBKeyRange.bound([n.userId,-1],[n.userId,n.lastAcknowledgedBatchId]);return t.j("userMutationsIndex",e).next(e=>ss.forEach(e,e=>{Tr(e.userId===n.userId);var t=uu(this.serializer,e);return Wu(r,n.userId,t).next(()=>{})}))}))}Ks(e){const a=e.store("targetDocuments"),t=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next(s=>{const i=[];return t.Z((e,t)=>{const n=new Gr(e),r=[0,Is(n)];i.push(a.get(r).next(e=>e?ss.resolve():(e=>a.put({targetId:0,path:Is(e),sequenceNumber:s.highestListenSequenceNumber}))(n)))}).next(()=>ss.waitFor(i))})}Gs(e,t){e.createObjectStore("collectionParents",{keyPath:Ls});const n=t.store("collectionParents"),r=new Pu,s=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:Is(r)})}};return t.store("remoteDocuments").Z({Y:!0},(e,t)=>{const n=new Gr(e);return s(n.popLast())}).next(()=>t.store("documentMutations").Z({Y:!0},([,e],t)=>{const n=Es(e);return s(n.popLast())}))}Qs(e){const r=e.store("targets");return r.Z((e,t)=>{var n=cu(t),n=hu(this.serializer,n);return r.put(n)})}zs(e,i){const t=i.store("remoteDocuments"),a=[];return t.Z((e,t)=>{const n=i.store("remoteDocumentsV14"),r=((s=t).document?new $r(Gr.fromString(s.document.name).popFirst(5)):s.noDocument?$r.fromSegments(s.noDocument.path):s.unknownDocument?$r.fromSegments(s.unknownDocument.path):Er()).path.toArray();var s={prefixPath:r.slice(0,r.length-2),collectionGroup:r[r.length-2],documentId:r[r.length-1],readTime:t.readTime||[0,0],unknownDocument:t.unknownDocument,noDocument:t.noDocument,document:t.document,hasCommittedMutations:!!t.hasCommittedMutations};a.push(n.put(s))}).next(()=>ss.waitFor(a))}js(e,i){const t=i.store("mutations"),a=mc(this.serializer),o=new kc(Lc.Fs,this.serializer.se);return t.j().next(e=>{const r=new Map;return e.forEach(e=>{var t;let n=null!==(t=r.get(e.userId))&&void 0!==t?t:Ma();uu(this.serializer,e).keys().forEach(e=>n=n.add(e)),r.set(e.userId,n)}),ss.forEach(r,(e,t)=>{var n=new mr(t),r=vu.ie(this.serializer,n),s=o.getIndexManager(n),n=Yu.ie(n,this.serializer,s,o.referenceDelegate);return new Ec(a,n,r,s).recalculateAndSaveOverlaysForDocumentKeys(new zs(i,ps.ct),e).next()})})}}function Oc(e){e.createObjectStore("targetDocuments",{keyPath:ks}).createIndex("documentTargetsIndex",Rs,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",Ns,{unique:!0}),e.createObjectStore("targetGlobal")}const Fc="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class Vc{constructor(e,t,n,r,s,i,a,o,u,c,h=15){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.Ws=s,this.window=i,this.document=a,this.Hs=u,this.Js=c,this.Ys=h,this.Vs=null,this.Ss=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Zs=null,this.inForeground=!1,this.Xs=null,this.ti=null,this.ei=Number.NEGATIVE_INFINITY,this.ni=e=>Promise.resolve(),!Vc.D())throw new Sr(_r.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new hc(this,r),this.si=t+"main",this.serializer=new ru(o),this.ii=new as(this.si,this.Ys,new Mc(this.serializer)),this.Ds=new nc(this.referenceDelegate,this.serializer),this.remoteDocumentCache=mc(this.serializer),this.xs=new gu,this.window&&this.window.localStorage?this.ri=this.window.localStorage:(this.ri=null,!1===c&&wr("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.oi().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new Sr(_r.FAILED_PRECONDITION,Fc);return this.ui(),this.ci(),this.ai(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Ds.getHighestSequenceNumber(e))}).then(e=>{this.Vs=new ps(e,this.Hs)}).then(()=>{this.Ss=!0}).catch(e=>(this.ii&&this.ii.close(),Promise.reject(e)))}hi(t){return this.ni=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.ii.B(async e=>{null===e.newVersion&&await t()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.Ws.enqueueAndForget(async()=>{this.started&&await this.oi()}))}oi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",t=>Bc(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.li(t).next(e=>{e||(this.isPrimary=!1,this.Ws.enqueueRetryable(()=>this.ni(!1)))})}).next(()=>this.fi(t)).next(e=>this.isPrimary&&!e?this.di(t).next(()=>!1):!!e&&this.wi(t).next(()=>!0))).catch(e=>{if(cs(e))return vr("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return vr("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.Ws.enqueueRetryable(()=>this.ni(e)),this.isPrimary=e})}li(e){return Pc(e).get("owner").next(e=>ss.resolve(this._i(e)))}mi(e){return Bc(e).delete(this.clientId)}async gi(){if(this.isPrimary&&!this.yi(this.ei,18e5)){this.ei=Date.now();var e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{const r=Qs(e,"clientMetadata");return r.j().next(e=>{const t=this.pi(e,18e5),n=e.filter(e=>-1===t.indexOf(e));return ss.forEach(n,e=>r.delete(e.clientId)).next(()=>n)})}).catch(()=>[]);if(this.ri)for(const t of e)this.ri.removeItem(this.Ii(t.clientId))}}ai(){this.ti=this.Ws.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.oi().then(()=>this.gi()).then(()=>this.ai()))}_i(e){return!!e&&e.ownerId===this.clientId}fi(t){return this.Js?ss.resolve(!0):Pc(t).get("owner").next(e=>{if(null!==e&&this.yi(e.leaseTimestampMs,5e3)&&!this.Ti(e.ownerId)){if(this._i(e)&&this.networkEnabled)return!0;if(!this._i(e)){if(!e.allowTabSynchronization)throw new Sr(_r.FAILED_PRECONDITION,Fc);return!1}}return!(!this.networkEnabled||!this.inForeground)||Bc(t).j().next(e=>void 0===this.pi(e,5e3).find(e=>{if(this.clientId!==e.clientId){var t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&vr("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.Ss=!1,this.Ei(),this.ti&&(this.ti.cancel(),this.ti=null),this.Ai(),this.Ri(),await this.ii.runTransaction("shutdown","readwrite",["owner","clientMetadata"],e=>{const t=new zs(e,ps.ct);return this.di(t).next(()=>this.mi(t))}),this.ii.close(),this.vi()}pi(e,t){return e.filter(e=>this.yi(e.updateTimeMs,t)&&!this.Ti(e.clientId))}bi(){return this.runTransaction("getActiveClients","readonly",e=>Bc(e).j().next(e=>this.pi(e,18e5).map(e=>e.clientId)))}get started(){return this.Ss}getMutationQueue(e,t){return Yu.ie(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Ds}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new qu(e,this.serializer.se.databaseId)}getDocumentOverlayCache(e){return vu.ie(this.serializer,e)}getBundleCache(){return this.xs}runTransaction(t,n,r){vr("IndexedDbPersistence","Starting transaction:",t);var e,s="readonly"===n?"readonly":"readwrite",e=15===(e=this.Ys)?$s:14===e?Ks:13===e?js:12===e?Gs:11===e?Us:void Er();let i;return this.ii.runTransaction(t,s,e,e=>(i=new zs(e,this.Vs?this.Vs.next():ps.ct),"readwrite-primary"===n?this.li(i).next(e=>!!e||this.fi(i)).next(e=>{if(!e)throw wr(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.Ws.enqueueRetryable(()=>this.ni(!1)),new Sr(_r.FAILED_PRECONDITION,ts);return r(i)}).next(e=>this.wi(i).next(()=>e)):this.Pi(i).next(()=>r(i)))).then(e=>(i.raiseOnCommittedEvent(),e))}Pi(e){return Pc(e).get("owner").next(e=>{if(null!==e&&this.yi(e.leaseTimestampMs,5e3)&&!this.Ti(e.ownerId)&&!this._i(e)&&!(this.Js||this.allowTabSynchronization&&e.allowTabSynchronization))throw new Sr(_r.FAILED_PRECONDITION,Fc)})}wi(e){var t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Pc(e).put("owner",t)}static D(){return as.D()}di(e){const t=Pc(e);return t.get("owner").next(e=>this._i(e)?(vr("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):ss.resolve())}yi(e,t){var n=Date.now();return!(e<n-t||n<e&&(wr(`Detected an update time that is in the future: ${e} > ${n}`),1))}ui(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Xs=()=>{this.Ws.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.oi()))},this.document.addEventListener("visibilitychange",this.Xs),this.inForeground="visible"===this.document.visibilityState)}Ai(){this.Xs&&(this.document.removeEventListener("visibilitychange",this.Xs),this.Xs=null)}ci(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.Zs=()=>{this.Ei();var e=/(?:Version|Mobile)\/1[456]/;h()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.Ws.enterRestrictedMode(!0),this.Ws.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Zs))}Ri(){this.Zs&&(this.window.removeEventListener("pagehide",this.Zs),this.Zs=null)}Ti(e){var t;try{var n=null!==(null===(t=this.ri)||void 0===t?void 0:t.getItem(this.Ii(e)));return vr("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return wr("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}Ei(){if(this.ri)try{this.ri.setItem(this.Ii(this.clientId),String(Date.now()))}catch(e){wr("Failed to set zombie client id.",e)}}vi(){if(this.ri)try{this.ri.removeItem(this.Ii(this.clientId))}catch(e){}}Ii(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function Pc(e){return Qs(e,"owner")}function Bc(e){return Qs(e,"clientMetadata")}function qc(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class Uc{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Vi=n,this.Si=r}static Di(e,t){let n=Ma(),r=Ma();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new Uc(e,t.fromCache,n,r)}}class Gc{constructor(){this.Ci=!1}initialize(e,t){this.xi=e,this.indexManager=t,this.Ci=!0}getDocumentsMatchingQuery(t,n,r,s){return this.Ni(t,n).next(e=>e||this.ki(t,n,s,r)).next(e=>e||this.Oi(t,n))}Ni(s,i){if(da(i))return ss.resolve(null);let t=ya(i);return this.indexManager.getIndexType(s,t).next(e=>0===e?null:(null!==i.limit&&1===e&&(i=wa(i,null,"F"),t=ya(i)),this.indexManager.getDocumentsMatchingTarget(s,t).next(e=>{const r=Ma(...e);return this.xi.getDocuments(s,r).next(n=>this.indexManager.getMinOffset(s,t).next(e=>{var t=this.$i(i,n);return this.Mi(i,t,r,e.readTime)?this.Ni(s,wa(i,null,"F")):this.Fi(s,t,i,e)}))})))}ki(n,r,s,i){return da(r)||i.isEqual(qr.min())?this.Oi(n,r):this.xi.getDocuments(n,s).next(e=>{var t=this.$i(r,e);return this.Mi(r,t,s,i)?this.Oi(n,r):(yr()<=l.DEBUG&&vr("QueryEngine","Re-using previous result from %s to execute query: %s",i.toString(),Ea(r)),this.Fi(n,t,r,Xr(i,-1)))})}$i(n,e){let r=new ei(Sa(n));return e.forEach((e,t)=>{Ta(n,t)&&(r=r.add(t))}),r}Mi(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const s="F"===e.limitType?t.last():t.first();return!!s&&(s.hasPendingWrites||0<s.version.compareTo(r))}Oi(e,t){return yr()<=l.DEBUG&&vr("QueryEngine","Using full collection scan to execute query:",Ea(t)),this.xi.getDocumentsMatchingQuery(e,t,Zr.min())}Fi(e,n,t,r){return this.xi.getDocumentsMatchingQuery(e,t,r).next(t=>(n.forEach(e=>{t=t.insert(e.key,e)}),t))}}class jc{constructor(e,t,n,r){this.persistence=e,this.Bi=t,this.serializer=r,this.Li=new Xs(Fr),this.qi=new xa(e=>ra(e),sa),this.Ui=new Map,this.Ki=e.getRemoteDocumentCache(),this.Ds=e.getTargetCache(),this.xs=e.getBundleCache(),this.Gi(n)}Gi(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new Ec(this.Ki,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Ki.setIndexManager(this.indexManager),this.Bi.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.Li))}}function Kc(e,t,n,r){return new jc(e,t,n,r)}async function $c(e,t){const a=e;return a.persistence.runTransaction("Handle user change","readonly",s=>{let i;return a.mutationQueue.getAllMutationBatches(s).next(e=>(i=e,a.Gi(t),a.mutationQueue.getAllMutationBatches(s))).next(e=>{const t=[],n=[];let r=Ma();for(const s of i){t.push(s.batchId);for(const e of s.mutations)r=r.add(e.key)}for(const s of e){n.push(s.batchId);for(const e of s.mutations)r=r.add(e.key)}return a.localDocuments.getDocuments(s,r).next(e=>({Qi:e,removedBatchIds:t,addedBatchIds:n}))})})}function zc(e){const t=e;return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.Ds.getLastRemoteSnapshotVersion(e))}function Qc(e,c){const h=e,l=c.snapshotVersion;let d=h.Li;return h.persistence.runTransaction("Apply remote event","readwrite-primary",o=>{const e=h.Ki.newChangeBuffer({trackRemovals:!0});d=h.Li;const u=[];c.targetChanges.forEach((t,n)=>{const r=d.get(n);if(r){u.push(h.Ds.removeMatchingKeys(o,t.removedDocuments,n).next(()=>h.Ds.addMatchingKeys(o,t.addedDocuments,n)));let e=r.withSequenceNumber(o.currentSequenceNumber);var s,i,a;c.targetMismatches.has(n)?e=e.withResumeToken(ii.EMPTY_BYTE_STRING,qr.min()).withLastLimboFreeSnapshotVersion(qr.min()):0<t.resumeToken.approximateByteSize()&&(e=e.withResumeToken(t.resumeToken,l)),d=d.insert(n,e),s=r,i=e,a=t,0!==s.resumeToken.approximateByteSize()&&!(3e8<=i.snapshotVersion.toMicroseconds()-s.snapshotVersion.toMicroseconds()||0<a.addedDocuments.size+a.modifiedDocuments.size+a.removedDocuments.size)||u.push(h.Ds.updateTargetData(o,e))}});let t=Da,n=Ma();if(c.documentUpdates.forEach(e=>{c.resolvedLimboDocuments.has(e)&&u.push(h.persistence.referenceDelegate.updateLimboDocument(o,e))}),u.push(Wc(o,e,c.documentUpdates).next(e=>{t=e.zi,n=e.ji})),!l.isEqual(qr.min())){const c=h.Ds.getLastRemoteSnapshotVersion(o).next(e=>h.Ds.setTargetsMetadata(o,o.currentSequenceNumber,l));u.push(c)}return ss.waitFor(u).next(()=>e.apply(o)).next(()=>h.localDocuments.getLocalViewOfDocuments(o,t,n)).next(()=>t)}).then(e=>(h.Li=d,e))}function Wc(e,i,t){let n=Ma(),a=Ma();return t.forEach(e=>n=n.add(e)),i.getEntries(e,n).next(r=>{let s=Da;return t.forEach((e,t)=>{const n=r.get(e);t.isFoundDocument()!==n.isFoundDocument()&&(a=a.add(e)),t.isNoDocument()&&t.version.isEqual(qr.min())?(i.removeEntry(e,t.readTime),s=s.insert(e,t)):!n.isValidDocument()||0<t.version.compareTo(n.version)||0===t.version.compareTo(n.version)&&n.hasPendingWrites?(i.addEntry(t),s=s.insert(e,t)):vr("LocalStore","Ignoring outdated watch update for ",e,". Current version:",n.version," Watch version:",t.version)}),{zi:s,ji:a}})}function Hc(e,r){const s=e;return s.persistence.runTransaction("Allocate target","readwrite",t=>{let n;return s.Ds.getTargetData(t,r).next(e=>e?(n=e,ss.resolve(n)):s.Ds.allocateTargetId(t).next(e=>(n=new nu(r,e,0,t.currentSequenceNumber),s.Ds.addTargetData(t,n).next(()=>n))))}).then(e=>{var t=s.Li.get(e.targetId);return(null===t||0<e.snapshotVersion.compareTo(t.snapshotVersion))&&(s.Li=s.Li.insert(e.targetId,e),s.qi.set(r,e.targetId)),e})}async function Yc(e,t,n){const r=e,s=r.Li.get(t),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,e=>r.persistence.referenceDelegate.removeTarget(e,s))}catch(e){if(!cs(e))throw e;vr("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.Li=r.Li.remove(t),r.qi.delete(s.target)}function Xc(e,n,r){const s=e;let i=qr.min(),a=Ma();return s.persistence.runTransaction("Execute query","readonly",t=>function(e,t,n){const r=e,s=r.qi.get(n);return void 0!==s?ss.resolve(r.Li.get(s)):r.Ds.getTargetData(t,n)}(s,t,ya(n)).next(e=>{if(e)return i=e.lastLimboFreeSnapshotVersion,s.Ds.getMatchingKeysForTargetId(t,e.targetId).next(e=>{a=e})}).next(()=>s.Bi.getDocumentsMatchingQuery(t,n,r?i:qr.min(),r?a:Ma())).next(e=>(eh(s,_a(n),e),{documents:e,Wi:a})))}function Jc(e,t){const n=e,r=n.Ds,s=n.Li.get(t);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",e=>r.ne(e,t).next(e=>e?e.target:null))}function Zc(e,t){const n=e,r=n.Ui.get(t)||qr.min();return n.persistence.runTransaction("Get new document changes","readonly",e=>n.Ki.getAllFromCollectionGroup(e,t,Xr(r,-1),Number.MAX_SAFE_INTEGER)).then(e=>(eh(n,t,e),e))}function eh(e,t,n){let r=e.Ui.get(t)||qr.min();n.forEach((e,t)=>{0<t.readTime.compareTo(r)&&(r=t.readTime)}),e.Ui.set(t,r)}function th(e,t){return`firestore_clients_${e}_${t}`}function nh(e,t,n){let r=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function rh(e,t){return`firestore_targets_${e}_${t}`}class sh{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Zi(e,t,n){var r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new Sr(r.error.code,r.error.message))),i?new sh(e,t,r.state,s):(wr("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}Xi(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class ih{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Zi(e,t){var n=JSON.parse(t);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new Sr(n.error.code,n.error.message))),s?new ih(e,n.state,r):(wr("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}Xi(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class ah{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Zi(e,t){var n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=Oa;for(let i=0;r&&i<n.activeTargetIds.length;++i)r=ws(n.activeTargetIds[i]),s=s.add(n.activeTargetIds[i]);return r?new ah(e,s):(wr("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class oh{constructor(e,t){this.clientId=e,this.onlineState=t}static Zi(e){var t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new oh(t.clientId,t.onlineState):(wr("SharedClientState",`Failed to parse online state: ${e}`),null)}}class uh{constructor(){this.activeTargetIds=Oa}tr(e){this.activeTargetIds=this.activeTargetIds.add(e)}er(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Xi(){var e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class ch{constructor(e,t,n,r,s){this.window=e,this.Ws=t,this.persistenceKey=n,this.nr=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.sr=this.ir.bind(this),this.rr=new Xs(Fr),this.started=!1,this.ur=[];var i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.cr=th(this.persistenceKey,this.nr),this.ar=`firestore_sequence_number_${this.persistenceKey}`,this.rr=this.rr.insert(this.nr,new uh),this.hr=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.lr=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.dr=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.wr=`firestore_online_state_${this.persistenceKey}`,this._r=`firestore_bundle_loaded_v2_${this.persistenceKey}`,this.window.addEventListener("storage",this.sr)}static D(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.bi();for(const n of e)if(n!==this.nr){const e=this.getItem(th(this.persistenceKey,n));var t;!e||(t=ah.Zi(n,e))&&(this.rr=this.rr.insert(t.clientId,t))}this.mr();const n=this.storage.getItem(this.wr);if(n){const e=this.gr(n);e&&this.yr(e)}for(const e of this.ur)this.ir(e);this.ur=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.ar,JSON.stringify(e))}getAllActiveQueryTargets(){return this.pr(this.rr)}isActiveQueryTarget(n){let r=!1;return this.rr.forEach((e,t)=>{t.activeTargetIds.has(n)&&(r=!0)}),r}addPendingMutation(e){this.Ir(e,"pending")}updateMutationState(e,t,n){this.Ir(e,t,n),this.Tr(e)}addLocalQueryTarget(e){let t="not-current";var n;return this.isActiveQueryTarget(e)&&(!(n=this.storage.getItem(rh(this.persistenceKey,e)))||(n=ih.Zi(e,n))&&(t=n.state)),this.Er.tr(e),this.mr(),t}removeLocalQueryTarget(e){this.Er.er(e),this.mr()}isLocalQueryTarget(e){return this.Er.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(rh(this.persistenceKey,e))}updateQueryState(e,t,n){this.Ar(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.Tr(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.Rr(e)}notifyBundleLoaded(e){this.vr(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.sr),this.removeItem(this.cr),this.started=!1)}getItem(e){var t=this.storage.getItem(e);return vr("SharedClientState","READ",e,t),t}setItem(e,t){vr("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){vr("SharedClientState","REMOVE",e),this.storage.removeItem(e)}ir(e){const s=e;s.storageArea===this.storage&&(vr("SharedClientState","EVENT",s.key,s.newValue),s.key!==this.cr?this.Ws.enqueueRetryable(async()=>{if(this.started){if(null!==s.key)if(this.hr.test(s.key)){if(null==s.newValue){var e=this.br(s.key);return this.Pr(e,null)}e=this.Vr(s.key,s.newValue);if(e)return this.Pr(e.clientId,e)}else if(this.lr.test(s.key)){if(null!==s.newValue){var t=this.Sr(s.key,s.newValue);if(t)return this.Dr(t)}}else if(this.dr.test(s.key)){if(null!==s.newValue){t=this.Cr(s.key,s.newValue);if(t)return this.Nr(t)}}else if(s.key===this.wr){if(null!==s.newValue){var n=this.gr(s.newValue);if(n)return this.yr(n)}}else if(s.key===this.ar){n=function(e){let t=ps.ct;if(null!=e)try{var n=JSON.parse(e);Tr("number"==typeof n),t=n}catch(e){wr("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(s.newValue);n!==ps.ct&&this.sequenceNumberHandler(n)}else if(s.key===this._r){const r=this.kr(s.newValue);await Promise.all(r.map(e=>this.syncEngine.Or(e)))}}else this.ur.push(s)}):wr("Received WebStorage notification for local change. Another client might have garbage-collected our state"))}get Er(){return this.rr.get(this.nr)}mr(){this.setItem(this.cr,this.Er.Xi())}Ir(e,t,n){const r=new sh(this.currentUser,e,t,n),s=nh(this.persistenceKey,this.currentUser,e);this.setItem(s,r.Xi())}Tr(e){var t=nh(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Rr(e){var t={clientId:this.nr,onlineState:e};this.storage.setItem(this.wr,JSON.stringify(t))}Ar(e,t,n){const r=rh(this.persistenceKey,e),s=new ih(e,t,n);this.setItem(r,s.Xi())}vr(e){var t=JSON.stringify(Array.from(e));this.setItem(this._r,t)}br(e){var t=this.hr.exec(e);return t?t[1]:null}Vr(e,t){var n=this.br(e);return ah.Zi(n,t)}Sr(e,t){var n=this.lr.exec(e),r=Number(n[1]),n=void 0!==n[2]?n[2]:null;return sh.Zi(new mr(n),r,t)}Cr(e,t){var n=this.dr.exec(e),n=Number(n[1]);return ih.Zi(n,t)}gr(e){return oh.Zi(e)}kr(e){return JSON.parse(e)}async Dr(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.$r(e.batchId,e.state,e.error);vr("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}Nr(e){return this.syncEngine.Mr(e.targetId,e.state,e.error)}Pr(e,t){const n=t?this.rr.insert(e,t):this.rr.remove(e),r=this.pr(this.rr),s=this.pr(n),i=[],a=[];return s.forEach(e=>{r.has(e)||i.push(e)}),r.forEach(e=>{s.has(e)||a.push(e)}),this.syncEngine.Fr(i,a).then(()=>{this.rr=n})}yr(e){this.rr.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}pr(e){let n=Oa;return e.forEach((e,t)=>{n=n.unionWith(t.activeTargetIds)}),n}}class hh{constructor(){this.Br=new uh,this.Lr={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.Br.tr(e),this.Lr[e]||"not-current"}updateQueryState(e,t,n){this.Lr[e]=t}removeLocalQueryTarget(e){this.Br.er(e)}isLocalQueryTarget(e){return this.Br.activeTargetIds.has(e)}clearQueryState(e){delete this.Lr[e]}getAllActiveQueryTargets(){return this.Br.activeTargetIds}isActiveQueryTarget(e){return this.Br.activeTargetIds.has(e)}start(){return this.Br=new uh,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class lh{qr(e){}shutdown(){}}class dh{constructor(){this.Ur=()=>this.Kr(),this.Gr=()=>this.Qr(),this.zr=[],this.jr()}qr(e){this.zr.push(e)}shutdown(){window.removeEventListener("online",this.Ur),window.removeEventListener("offline",this.Gr)}jr(){window.addEventListener("online",this.Ur),window.addEventListener("offline",this.Gr)}Kr(){vr("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.zr)e(0)}Qr(){vr("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.zr)e(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let fh=null;function mh(){return null===fh?fh=268435456+Math.round(2147483648*Math.random()):fh++,"0x"+fh.toString(16)}const gh={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class ph{constructor(e){this.Wr=e.Wr,this.Hr=e.Hr}Jr(e){this.Yr=e}Zr(e){this.Xr=e}onMessage(e){this.eo=e}close(){this.Hr()}send(e){this.Wr(e)}no(){this.Yr()}so(e){this.Xr(e)}io(e){this.eo(e)}}const yh="WebChannelConnection";class vh extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;var t=e.ssl?"https":"http";this.ro=t+"://"+e.host,this.oo="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}get uo(){return!1}co(t,e,n,r,s){const i=mh(),a=this.ao(t,e);vr("RestConnection",`Sending RPC '${t}' ${i}:`,a,n);var o={};return this.ho(o,r,s),this.lo(t,a,o,n).then(e=>(vr("RestConnection",`Received RPC '${t}' ${i}: `,e),e),e=>{throw Ir("RestConnection",`RPC '${t}' ${i} failed with error: `,e,"url: ",a,"request:",n),e})}fo(e,t,n,r,s,i){return this.co(e,t,n,r,s)}ho(n,e,t){n["X-Goog-Api-Client"]="gl-js/ fire/"+gr,n["Content-Type"]="text/plain",this.databaseInfo.appId&&(n["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach((e,t)=>n[t]=e),t&&t.headers.forEach((e,t)=>n[t]=e)}ao(e,t){var n=gh[e];return`${this.ro}/v1/${t}:${n}`}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams}lo(o,t,n,r){const u=mh();return new Promise((s,i)=>{const a=new dr;a.setWithCredentials(!0),a.listenOnce(ar.COMPLETE,()=>{try{switch(a.getLastErrorCode()){case ir.NO_ERROR:var e=a.getResponseJson();vr(yh,`XHR for RPC '${o}' ${u} received:`,JSON.stringify(e)),s(e);break;case ir.TIMEOUT:vr(yh,`RPC '${o}' ${u} timed out`),i(new Sr(_r.DEADLINE_EXCEEDED,"Request time out"));break;case ir.HTTP_ERROR:var t=a.getStatus();if(vr(yh,`RPC '${o}' ${u} failed with status:`,t,"response text:",a.getResponseText()),0<t){let e=a.getResponseJson();Array.isArray(e)&&(e=e[0]);var n=null==e?void 0:e.error;if(n&&n.status&&n.message){const o=(r=n.status.toLowerCase().replace(/_/g,"-"),0<=Object.values(_r).indexOf(r)?r:_r.UNKNOWN);i(new Sr(o,n.message))}else i(new Sr(_r.UNKNOWN,"Server responded with status "+a.getStatus()))}else i(new Sr(_r.UNAVAILABLE,"Connection failed."));break;default:Er()}}finally{vr(yh,`RPC '${o}' ${u} completed.`)}var r});var e=JSON.stringify(r);vr(yh,`RPC '${o}' ${u} sending request:`,r),a.send(t,"POST",e,n,15)})}wo(s,e,t){const i=mh(),n=[this.ro,"/","google.firestore.v1.Firestore","/",s,"/channel"],r=new Jn,a=sr(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(o.xmlHttpFactory=new hr({})),this.ho(o.initMessageHeaders,e,t),o.encodeInitMessageHeaders=!0;var u=n.join("");vr(yh,`Creating RPC '${s}' stream ${i}: ${u}`,o);const c=r.createWebChannel(u,o);let h=!1,l=!1;const d=new ph({Wr:e=>{l?vr(yh,`Not sending because RPC '${s}' stream ${i} is closed:`,e):(h||(vr(yh,`Opening RPC '${s}' stream ${i} transport.`),c.open(),h=!0),vr(yh,`RPC '${s}' stream ${i} sending:`,e),c.send(e))},Hr:()=>c.close()}),f=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return f(c,lr.EventType.OPEN,()=>{l||vr(yh,`RPC '${s}' stream ${i} transport opened.`)}),f(c,lr.EventType.CLOSE,()=>{l||(l=!0,vr(yh,`RPC '${s}' stream ${i} transport closed`),d.so())}),f(c,lr.EventType.ERROR,e=>{l||(l=!0,Ir(yh,`RPC '${s}' stream ${i} transport errored:`,e),d.so(new Sr(_r.UNAVAILABLE,"The operation could not be completed")))}),f(c,lr.EventType.MESSAGE,n=>{if(!l){var e=n.data[0];Tr(!!e);var r=e.error||(null===(r=e[0])||void 0===r?void 0:r.error);if(r){vr(yh,`RPC '${s}' stream ${i} received error:`,r);const n=r.status;let e=function(e){var t=rr[e];if(void 0!==t)return yo(t)}(n),t=r.message;void 0===e&&(e=_r.INTERNAL,t="Unknown error status: "+n+" with message "+r.message),l=!0,d.so(new Sr(e,t)),c.close()}else vr(yh,`RPC '${s}' stream ${i} received:`,e),d.io(e)}}),f(a,or.STAT_EVENT,e=>{e.stat===ur?vr(yh,`RPC '${s}' stream ${i} detected buffering proxy`):e.stat===cr&&vr(yh,`RPC '${s}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{d.no()},0),d}}function wh(){return"undefined"!=typeof window?window:null}function Ih(){return"undefined"!=typeof document?document:null}function bh(e){return new Ro(e,!0)}class Eh{constructor(e,t,n=1e3,r=1.5,s=6e4){this.Ws=e,this.timerId=t,this._o=n,this.mo=r,this.yo=s,this.po=0,this.Io=null,this.To=Date.now(),this.reset()}reset(){this.po=0}Eo(){this.po=this.yo}Ao(e){this.cancel();var t=Math.floor(this.po+this.Ro()),n=Math.max(0,Date.now()-this.To),r=Math.max(0,t-n);0<r&&vr("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.po} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.Io=this.Ws.enqueueAfterDelay(this.timerId,r,()=>(this.To=Date.now(),e())),this.po*=this.mo,this.po<this._o&&(this.po=this._o),this.po>this.yo&&(this.po=this.yo)}vo(){null!==this.Io&&(this.Io.skipDelay(),this.Io=null)}cancel(){null!==this.Io&&(this.Io.cancel(),this.Io=null)}Ro(){return(Math.random()-.5)*this.po}}class Th{constructor(e,t,n,r,s,i,a,o){this.Ws=e,this.bo=n,this.Po=r,this.connection=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.Vo=0,this.So=null,this.Do=null,this.stream=null,this.Co=new Eh(e,t)}xo(){return 1===this.state||5===this.state||this.No()}No(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.ko()}async stop(){this.xo()&&await this.close(0)}Oo(){this.state=0,this.Co.reset()}$o(){this.No()&&null===this.So&&(this.So=this.Ws.enqueueAfterDelay(this.bo,6e4,()=>this.Mo()))}Fo(e){this.Bo(),this.stream.send(e)}async Mo(){if(this.No())return this.close(0)}Bo(){this.So&&(this.So.cancel(),this.So=null)}Lo(){this.Do&&(this.Do.cancel(),this.Do=null)}async close(e,t){this.Bo(),this.Lo(),this.Co.cancel(),this.Vo++,4!==e?this.Co.reset():t&&t.code===_r.RESOURCE_EXHAUSTED?(wr(t.toString()),wr("Using maximum backoff delay to prevent overloading the backend."),this.Co.Eo()):t&&t.code===_r.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.qo(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Zr(t)}qo(){}auth(){this.state=1;const e=this.Uo(this.Vo),n=this.Vo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,t])=>{this.Vo===n&&this.Ko(e,t)},t=>{e(()=>{var e=new Sr(_r.UNKNOWN,"Fetching auth token failed: "+t.message);return this.Go(e)})})}Ko(e,t){const n=this.Uo(this.Vo);this.stream=this.Qo(e,t),this.stream.Jr(()=>{n(()=>(this.state=2,this.Do=this.Ws.enqueueAfterDelay(this.Po,1e4,()=>(this.No()&&(this.state=3),Promise.resolve())),this.listener.Jr()))}),this.stream.Zr(e=>{n(()=>this.Go(e))}),this.stream.onMessage(e=>{n(()=>this.onMessage(e))})}ko(){this.state=5,this.Co.Ao(async()=>{this.state=0,this.start()})}Go(e){return vr("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}Uo(t){return e=>{this.Ws.enqueueAndForget(()=>this.Vo===t?e():(vr("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class _h extends Th{constructor(e,t,n,r,s,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,i),this.serializer=s}Qo(e,t){return this.connection.wo("Listen",e,t)}onMessage(e){this.Co.reset();var t=function(e,t){let n;if("targetChange"in t){t.targetChange;var r="NO_CHANGE"===(f=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===f?1:"REMOVE"===f?2:"CURRENT"===f?3:"RESET"===f?4:Er(),s=t.targetChange.targetIds||[],i=(f=t.targetChange.resumeToken,e.useProto3Json?(Tr(void 0===f||"string"==typeof f),ii.fromBase64String(f||"")):(Tr(void 0===f||f instanceof Uint8Array),ii.fromUint8Array(f||new Uint8Array))),a=t.targetChange.cause,o=a&&(o=void 0===(f=a).code?_r.UNKNOWN:yo(f.code),new Sr(o,f.message||""));n=new _o(r,s,i,o||null)}else if("documentChange"in t){t.documentChange;var u=t.documentChange;u.document,u.document.name,u.document.updateTime;var i=Bo(e,u.document.name),o=Oo(u.document.updateTime),c=u.document.createTime?Oo(u.document.createTime):qr.min(),h=new Ri({mapValue:{fields:u.document.fields}}),c=Li.newFoundDocument(i,o,c,h),h=u.targetIds||[],u=u.removedTargetIds||[];n=new Eo(h,u,c.key,c)}else if("documentDelete"in t){t.documentDelete;h=t.documentDelete;h.document;u=Bo(e,h.document),c=h.readTime?Oo(h.readTime):qr.min(),c=Li.newNoDocument(u,c),h=h.removedTargetIds||[];n=new Eo([],h,c.key,c)}else if("documentRemove"in t){t.documentRemove;var l=t.documentRemove;l.document;var d=Bo(e,l.document),l=l.removedTargetIds||[];n=new Eo([],l,d,null)}else{if(!("filter"in t))return Er();{t.filter;const e=t.filter;e.targetId;l=e.count||0,d=new go(l),l=e.targetId;n=new To(l,d)}}var o,f;return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return qr.min();var t=e.targetChange;return(!t.targetIds||!t.targetIds.length)&&t.readTime?Oo(t.readTime):qr.min()}(e);return this.listener.zo(t,n)}jo(e){const t={};t.database=Go(this.serializer),t.addTarget=function(e,t){let n;var r=t.target;return n=ia(r)?{documents:Wo(e,r)}:{query:Ho(e,r)},n.targetId=t.targetId,0<t.resumeToken.approximateByteSize()?n.resumeToken=Mo(e,t.resumeToken):0<t.snapshotVersion.compareTo(qr.min())&&(n.readTime=Lo(e,t.snapshotVersion.toTimestamp())),n}(this.serializer,e);var n,r,r=(this.serializer,n=e,null==(r=function(){switch(n.purpose){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return Er()}}())?null:{"goog-listen-tags":r});r&&(t.labels=r),this.Fo(t)}Wo(e){const t={};t.database=Go(this.serializer),t.removeTarget=e,this.Fo(t)}}class Sh extends Th{constructor(e,t,n,r,s,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,i),this.serializer=s,this.Ho=!1}get Jo(){return this.Ho}start(){this.Ho=!1,this.lastStreamToken=void 0,super.start()}qo(){this.Ho&&this.Yo([])}Qo(e,t){return this.connection.wo("Write",e,t)}onMessage(e){if(Tr(!!e.streamToken),this.lastStreamToken=e.streamToken,this.Ho){this.Co.reset();var t=(r=e.writeResults,s=e.commitTime,r&&0<r.length?(Tr(void 0!==s),r.map(e=>function(e,t){let n=e.updateTime?Oo(e.updateTime):Oo(t);return n.isEqual(qr.min())&&(n=Oo(t)),new Ya(n,e.transformResults||[])}(e,s))):[]),n=Oo(e.commitTime);return this.listener.Zo(n,t)}var r,s;return Tr(!e.writeResults||0===e.writeResults.length),this.Ho=!0,this.listener.Xo()}tu(){const e={};e.database=Go(this.serializer),this.Fo(e)}Yo(e){var t={streamToken:this.lastStreamToken,writes:e.map(e=>zo(this.serializer,e))};this.Fo(t)}}class xh extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.eu=!1}nu(){if(this.eu)throw new Sr(_r.FAILED_PRECONDITION,"The client has already been terminated.")}co(n,r,s){return this.nu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.connection.co(n,r,s,e,t)).catch(e=>{throw"FirebaseError"===e.name?(e.code===_r.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new Sr(_r.UNKNOWN,e.toString())})}fo(n,r,s,i){return this.nu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.connection.fo(n,r,s,e,t,i)).catch(e=>{throw"FirebaseError"===e.name?(e.code===_r.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new Sr(_r.UNKNOWN,e.toString())})}terminate(){this.eu=!0}}class Dh{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.su=0,this.iu=null,this.ru=!0}ou(){0===this.su&&(this.uu("Unknown"),this.iu=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.iu=null,this.cu("Backend didn't respond within 10 seconds."),this.uu("Offline"),Promise.resolve())))}au(e){"Online"===this.state?this.uu("Unknown"):(this.su++,1<=this.su&&(this.hu(),this.cu(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.uu("Offline")))}set(e){this.hu(),this.su=0,"Online"===e&&(this.ru=!1),this.uu(e)}uu(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}cu(e){var t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.ru?(wr(t),this.ru=!1):vr("OnlineStateTracker",t)}hu(){null!==this.iu&&(this.iu.cancel(),this.iu=null)}}class Ch{constructor(e,t,n,r,s){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.lu=[],this.fu=new Map,this.du=new Set,this.wu=[],this._u=s,this._u.qr(e=>{n.enqueueAndForget(async()=>{Vh(this)&&(vr("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=e;t.du.add(4),await Nh(t),t.mu.set("Unknown"),t.du.delete(4),await Ah(t)}(this))})}),this.mu=new Dh(n,r)}}async function Ah(e){if(Vh(e))for(const t of e.wu)await t(!0)}async function Nh(e){for(const t of e.wu)await t(!1)}function kh(e,t){const n=e;n.fu.has(t.targetId)||(n.fu.set(t.targetId,t),Fh(n)?Oh(n):zh(n).No()&&Lh(n,t))}function Rh(e,t){const n=e,r=zh(n);n.fu.delete(t),r.No()&&Mh(n,t),0===n.fu.size&&(r.No()?r.$o():Vh(n)&&n.mu.set("Unknown"))}function Lh(e,t){e.gu.Ot(t.targetId),zh(e).jo(t)}function Mh(e,t){e.gu.Ot(t),zh(e).Wo(t)}function Oh(t){t.gu=new xo({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),ne:e=>t.fu.get(e)||null}),zh(t).start(),t.mu.ou()}function Fh(e){return Vh(e)&&!zh(e).xo()&&0<e.fu.size}function Vh(e){return 0===e.du.size}function Ph(e){e.gu=void 0}async function Bh(e,t,n){if(!cs(t))throw t;e.du.add(1),await Nh(e),e.mu.set("Offline"),n=n||(()=>zc(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{vr("RemoteStore","Retrying IndexedDB access"),await n(),e.du.delete(1),await Ah(e)})}function qh(t,n){return n().catch(e=>Bh(t,e,n))}async function Uh(e){const t=e,n=Qh(t);let r=0<t.lu.length?t.lu[t.lu.length-1].batchId:-1;for(;Vh(s=t)&&s.lu.length<10;)try{const e=await function(e,t){const n=e;return n.persistence.runTransaction("Get next mutation batch","readonly",e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t)))}(t.localStore,r);if(null===e){0===t.lu.length&&n.$o();break}r=e.batchId,function(e,t){e.lu.push(t);const n=Qh(e);n.No()&&n.Jo&&n.Yo(t.mutations)}(t,e)}catch(e){await Bh(t,e)}var s;Gh(t)&&jh(t)}function Gh(e){return Vh(e)&&!Qh(e).xo()&&0<e.lu.length}function jh(e){Qh(e).start()}async function Kh(e,t){const n=e;n.asyncQueue.verifyOperationInProgress(),vr("RemoteStore","RemoteStore received new credentials");var r=Vh(n);n.du.add(3),await Nh(n),r&&n.mu.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.du.delete(3),await Ah(n)}async function $h(e,t){const n=e;t?(n.du.delete(2),await Ah(n)):(n.du.add(2),await Nh(n),n.mu.set("Unknown"))}function zh(t){return t.yu||(t.yu=function(e,t,n){const r=e;return r.nu(),new _h(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(t.datastore,t.asyncQueue,{Jr:(async function(n){n.fu.forEach((e,t)=>{Lh(n,e)})}).bind(null,t),Zr:(async function(e,t){Ph(e),Fh(e)?(e.mu.au(t),Oh(e)):e.mu.set("Unknown")}).bind(null,t),zo:(async function(e,r,t){if(e.mu.set("Online"),r instanceof _o&&2===r.state&&r.cause)try{await async function(e){var t=r.cause;for(const n of r.targetIds)e.fu.has(n)&&(await e.remoteSyncer.rejectListen(n,t),e.fu.delete(n),e.gu.removeTarget(n))}(e)}catch(t){vr("RemoteStore","Failed to remove targets %s: %s ",r.targetIds.join(","),t),await Bh(e,t)}else if(r instanceof Eo?e.gu.Kt(r):r instanceof To?e.gu.Jt(r):e.gu.zt(r),!t.isEqual(qr.min()))try{const r=await zc(e.localStore);0<=t.compareTo(r)&&await function(r,s){const e=r.gu.Xt(s);return e.targetChanges.forEach((e,t)=>{if(0<e.resumeToken.approximateByteSize()){const n=r.fu.get(t);n&&r.fu.set(t,n.withResumeToken(e.resumeToken,s))}}),e.targetMismatches.forEach(e=>{const t=r.fu.get(e);var n;t&&(r.fu.set(e,t.withResumeToken(ii.EMPTY_BYTE_STRING,t.snapshotVersion)),Mh(r,e),n=new nu(t.target,e,1,t.sequenceNumber),Lh(r,n))}),r.remoteSyncer.applyRemoteEvent(e)}(e,t)}catch(r){vr("RemoteStore","Failed to raise snapshot:",r),await Bh(e,r)}}).bind(null,t)}),t.wu.push(async e=>{e?(t.yu.Oo(),Fh(t)?Oh(t):t.mu.set("Unknown")):(await t.yu.stop(),Ph(t))})),t.yu}function Qh(t){return t.pu||(t.pu=function(e,t,n){const r=e;return r.nu(),new Sh(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(t.datastore,t.asyncQueue,{Jr:(async function(e){Qh(e).tu()}).bind(null,t),Zr:(async function(e,t){t&&Qh(e).Jo&&await async function(e,t){if(po(n=t.code)&&n!==_r.ABORTED){const n=e.lu.shift();Qh(e).Oo(),await qh(e,()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t)),await Uh(e)}var n}(e,t),Gh(e)&&jh(e)}).bind(null,t),Xo:(async function(e){const t=Qh(e);for(const n of e.lu)t.Yo(n.mutations)}).bind(null,t),Zo:(async function(e,t,n){const r=e.lu.shift(),s=fo.from(r,t,n);await qh(e,()=>e.remoteSyncer.applySuccessfulWrite(s)),await Uh(e)}).bind(null,t)}),t.wu.push(async e=>{e?(t.pu.Oo(),await Uh(t)):(await t.pu.stop(),0<t.lu.length&&(vr("RemoteStore",`Stopping write stream with ${t.lu.length} pending writes`),t.lu=[]))})),t.pu}class Wh{constructor(e,t,n,r,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new xr,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}static createAndSchedule(e,t,n,r,s){const i=Date.now()+n,a=new Wh(e,t,i,r,s);return a.start(n),a}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Sr(_r.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Hh(e,t){if(wr("AsyncQueue",`${t}: ${e}`),cs(e))return new Sr(_r.UNAVAILABLE,`${t}: ${e}`);throw e}class Yh{constructor(n){this.comparator=n?(e,t)=>n(e,t)||$r.comparator(e.key,t.key):(e,t)=>$r.comparator(e.key,t.key),this.keyedMap=Aa(),this.sortedSet=new Xs(this.comparator)}static emptySet(e){return new Yh(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){var t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(n){this.sortedSet.inorderTraversal((e,t)=>(n(e),!1))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){var t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof Yh))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach(e=>{t.push(e.toString())}),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(e,t){const n=new Yh;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class Xh{constructor(){this.Iu=new Xs($r.comparator)}track(e){var t=e.doc.key,n=this.Iu.get(t);!n||0!==e.type&&3===n.type?this.Iu=this.Iu.insert(t,e):3===e.type&&1!==n.type?this.Iu=this.Iu.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.Iu=this.Iu.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.Iu=this.Iu.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.Iu=this.Iu.remove(t):1===e.type&&2===n.type?this.Iu=this.Iu.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.Iu=this.Iu.insert(t,{type:2,doc:e.doc}):Er()}Tu(){const n=[];return this.Iu.inorderTraversal((e,t)=>{n.push(t)}),n}}class Jh{constructor(e,t,n,r,s,i,a,o,u){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=u}static fromInitialDocuments(e,t,n,r,s){const i=[];return t.forEach(e=>{i.push({type:0,doc:e})}),new Jh(e,t,Yh.emptySet(t),i,n,r,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Ia(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(t[r].type!==n[r].type||!t[r].doc.isEqual(n[r].doc))return!1;return!0}}class Zh{constructor(){this.Eu=void 0,this.listeners=[]}}class el{constructor(){this.queries=new xa(e=>ba(e),Ia),this.onlineState="Unknown",this.Au=new Set}}async function tl(e,t){const n=e,r=t.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new Zh),s)try{i.Eu=await n.onListen(r)}catch(e){const n=Hh(e,`Initialization of query '${Ea(t.query)}' failed`);return void t.onError(n)}n.queries.set(r,i),i.listeners.push(t),t.Ru(n.onlineState),!i.Eu||t.vu(i.Eu)&&rl(n)}async function nl(e,t){const n=e,r=t.query;let s=!1;const i=n.queries.get(r);if(i){const e=i.listeners.indexOf(t);0<=e&&(i.listeners.splice(e,1),s=0===i.listeners.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function rl(e){e.Au.forEach(e=>{e.next()})}class sl{constructor(e,t,n){this.query=e,this.bu=t,this.Pu=!1,this.Vu=null,this.onlineState="Unknown",this.options=n||{}}vu(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new Jh(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Pu?this.Su(e)&&(this.bu.next(e),t=!0):this.Du(e,this.onlineState)&&(this.Cu(e),t=!0),this.Vu=e,t}onError(e){this.bu.error(e)}Ru(e){this.onlineState=e;let t=!1;return this.Vu&&!this.Pu&&this.Du(this.Vu,e)&&(this.Cu(this.Vu),t=!0),t}Du(e,t){return!e.fromCache||(!this.options.xu||!("Offline"!==t))&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}Su(e){if(0<e.docChanges.length)return!0;var t=this.Vu&&this.Vu.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}Cu(e){e=Jh.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Pu=!0,this.bu.next(e)}}class il{constructor(e,t){this.Nu=e,this.byteLength=t}ku(){return"metadata"in this.Nu}}class al{constructor(e){this.serializer=e}Hi(e){return Bo(this.serializer,e)}Ji(e){return e.metadata.exists?$o(this.serializer,e.document,!1):Li.newNoDocument(this.Hi(e.metadata.name),this.Yi(e.metadata.readTime))}Yi(e){return Oo(e)}}class ol{constructor(e,t,n){this.Ou=e,this.localStore=t,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=ul(e)}$u(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.Nu.namedQuery)this.queries.push(e.Nu.namedQuery);else if(e.Nu.documentMetadata){this.documents.push({metadata:e.Nu.documentMetadata}),e.Nu.documentMetadata.exists||++t;const n=Gr.fromString(e.Nu.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.Nu.document&&(this.documents[this.documents.length-1].document=e.Nu.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}Mu(e){const t=new Map,n=new al(this.serializer);for(const s of e)if(s.metadata.queries){const e=n.Hi(s.metadata.name);for(const n of s.metadata.queries){var r=(t.get(n)||Ma()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const s=e;let i=Ma(),a=Da;for(const e of n){const n=t.Hi(e.metadata.name);e.document&&(i=i.add(n));const c=t.Ji(e);c.setReadTime(t.Yi(e.metadata.readTime)),a=a.insert(n,c)}const o=s.Ki.newChangeBuffer({trackRemovals:!0}),u=await Hc(s,(r=r,ya(la(Gr.fromString(`__bundle__/docs/${r}`)))));return s.persistence.runTransaction("Apply bundle documents","readwrite",t=>Wc(t,o,a).next(e=>(o.apply(t),e)).next(e=>s.Ds.removeMatchingKeysForTargetId(t,u.targetId).next(()=>s.Ds.addMatchingKeys(t,i,u.targetId)).next(()=>s.localDocuments.getLocalViewOfDocuments(t,e.zi,e.ji)).next(()=>e.zi)))}(this.localStore,new al(this.serializer),this.documents,this.Ou.id),t=this.Mu(this.documents);for(const e of this.queries)await async function(e,n,r=Ma()){const s=await Hc(e,ya(lu(n.bundledQuery))),i=e;return i.persistence.runTransaction("Save named query","readwrite",e=>{var t=Oo(n.readTime);if(0<=s.snapshotVersion.compareTo(t))return i.xs.saveNamedQuery(e,n);t=s.withResumeToken(ii.EMPTY_BYTE_STRING,t);return i.Li=i.Li.insert(t.targetId,t),i.Ds.updateTargetData(e,t).next(()=>i.Ds.removeMatchingKeysForTargetId(e,s.targetId)).next(()=>i.Ds.addMatchingKeys(e,r,s.targetId)).next(()=>i.xs.saveNamedQuery(e,n))})}(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",{progress:this.progress,Fu:this.collectionGroups,Bu:e}}}function ul(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class cl{constructor(e){this.key=e}}class hl{constructor(e){this.key=e}}class ll{constructor(e,t){this.query=e,this.Lu=t,this.qu=null,this.hasCachedResults=!1,this.current=!1,this.Uu=Ma(),this.mutatedKeys=Ma(),this.Ku=Sa(e),this.Gu=new Yh(this.Ku)}get Qu(){return this.Lu}zu(e,t){const o=t?t.ju:new Xh,u=(t||this).Gu;let c=(t||this).mutatedKeys,h=u,l=!1;const d="F"===this.query.limitType&&u.size===this.query.limit?u.last():null,f="L"===this.query.limitType&&u.size===this.query.limit?u.first():null;if(e.inorderTraversal((e,t)=>{const n=u.get(e),r=Ta(this.query,t)?t:null,s=!!n&&this.mutatedKeys.has(n.key),i=!!r&&(r.hasLocalMutations||this.mutatedKeys.has(r.key)&&r.hasCommittedMutations);let a=!1;n&&r?n.data.isEqual(r.data)?s!==i&&(o.track({type:3,doc:r}),a=!0):this.Wu(n,r)||(o.track({type:2,doc:r}),a=!0,(d&&0<this.Ku(r,d)||f&&this.Ku(r,f)<0)&&(l=!0)):!n&&r?(o.track({type:0,doc:r}),a=!0):n&&!r&&(o.track({type:1,doc:n}),a=!0,(d||f)&&(l=!0)),a&&(c=r?(h=h.add(r),i?c.add(e):c.delete(e)):(h=h.delete(e),c.delete(e)))}),null!==this.query.limit)for(;h.size>this.query.limit;){const e="F"===this.query.limitType?h.last():h.first();h=h.delete(e.key),c=c.delete(e.key),o.track({type:1,doc:e})}return{Gu:h,ju:o,Mi:l,mutatedKeys:c}}Wu(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){var r=this.Gu;this.Gu=e.Gu,this.mutatedKeys=e.mutatedKeys;const s=e.ju.Tu();s.sort((e,t)=>function(e,t){var n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Er()}};return n(e)-n(t)}(e.type,t.type)||this.Ku(e.doc,t.doc)),this.Hu(n);var i=t?this.Ju():[],a=0===this.Uu.size&&this.current?1:0,o=a!==this.qu;return this.qu=a,0!==s.length||o?{snapshot:new Jh(this.query,e.Gu,r,s,e.mutatedKeys,0==a,o,!1,!!n&&0<n.resumeToken.approximateByteSize()),Yu:i}:{Yu:i}}Ru(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Gu:this.Gu,ju:new Xh,mutatedKeys:this.mutatedKeys,Mi:!1},!1)):{Yu:[]}}Zu(e){return!this.Lu.has(e)&&!!this.Gu.has(e)&&!this.Gu.get(e).hasLocalMutations}Hu(e){e&&(e.addedDocuments.forEach(e=>this.Lu=this.Lu.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.Lu=this.Lu.delete(e)),this.current=e.current)}Ju(){if(!this.current)return[];const t=this.Uu;this.Uu=Ma(),this.Gu.forEach(e=>{this.Zu(e.key)&&(this.Uu=this.Uu.add(e.key))});const n=[];return t.forEach(e=>{this.Uu.has(e)||n.push(new hl(e))}),this.Uu.forEach(e=>{t.has(e)||n.push(new cl(e))}),n}Xu(e){this.Lu=e.Wi,this.Uu=Ma();var t=this.zu(e.documents);return this.applyChanges(t,!0)}tc(){return Jh.fromInitialDocuments(this.query,this.Gu,this.mutatedKeys,0===this.qu,this.hasCachedResults)}}class dl{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class fl{constructor(e){this.key=e,this.ec=!1}}class ml{constructor(e,t,n,r,s,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.nc={},this.sc=new xa(e=>ba(e),Ia),this.ic=new Map,this.rc=new Set,this.oc=new Xs($r.comparator),this.uc=new Map,this.cc=new Sc,this.ac={},this.hc=new Map,this.lc=tc.bn(),this.onlineState="Unknown",this.fc=void 0}get isPrimaryClient(){return!0===this.fc}}async function gl(n,e,t,r,s){n.dc=(e,i,t)=>async function(e,t,n){let r=t.view.zu(i);r.Mi&&(r=await Xc(e.localStore,t.query,!1).then(({documents:e})=>t.view.zu(e,r)));var s=n&&n.targetChanges.get(t.targetId),s=t.view.applyChanges(r,e.isPrimaryClient,s);return _l(e,t.targetId,s.Yu),s.snapshot}(n,e,t);const i=await Xc(n.localStore,e,!0),a=new ll(e,i.Wi),o=a.zu(i.documents),u=bo.createSynthesizedTargetChangeForCurrentChange(t,r&&"Offline"!==n.onlineState,s),c=a.applyChanges(o,n.isPrimaryClient,u);_l(n,t,c.Yu);var h=new dl(e,t,a);return n.sc.set(e,h),n.ic.has(t)?n.ic.get(t).push(e):n.ic.set(t,[e]),c.snapshot}async function pl(e,t,n){const r=kl(e);try{const e=await function(e,s){const i=e,a=Br.now(),o=s.reduce((e,t)=>e.add(t.key),Ma());let u,c;return i.persistence.runTransaction("Locally write mutations","readwrite",n=>{let t=Da,r=Ma();return i.Ki.getEntries(n,o).next(e=>{t=e,t.forEach((e,t)=>{t.isValidDocument()||(r=r.add(e))})}).next(()=>i.localDocuments.getOverlayedDocuments(n,t)).next(e=>{u=e;const t=[];for(const n of s){const s=function(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),s=qa(r.transform,e||null);null!=s&&(null===n&&(n=Ri.empty()),n.set(r.field,s))}return n||null}(n,u.get(n.key).overlayedDocument);null!=s&&t.push(new io(n.key,s,function r(e){const s=[];return Hs(e.fields,(e,t)=>{const n=new Kr([e]);if(Di(t)){const e=r(t.mapValue).fields;if(0===e.length)s.push(n);else for(const t of e)s.push(n.child(t))}else s.push(n)}),new ri(s)}(s.value.mapValue),Xa.exists(!0)))}return i.mutationQueue.addMutationBatch(n,a,t,s)}).next(e=>{var t=(c=e).applyToLocalDocumentSet(u,r);return i.documentOverlayCache.saveOverlays(n,e.batchId,t)})}).then(()=>({batchId:c.batchId,changes:Na(u)}))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.ac[e.currentUser.toKey()];r=r||new Xs(Fr),r=r.insert(t,n),e.ac[e.currentUser.toKey()]=r}(r,e.batchId,n),await xl(r,e.changes),await Uh(r.remoteStore)}catch(e){const t=Hh(e,"Failed to persist write");n.reject(t)}}async function yl(e,t){const r=e;try{const e=await Qc(r.localStore,t);t.targetChanges.forEach((e,t)=>{const n=r.uc.get(t);n&&(Tr(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),0<e.addedDocuments.size?n.ec=!0:0<e.modifiedDocuments.size?Tr(n.ec):0<e.removedDocuments.size&&(Tr(n.ec),n.ec=!1))}),await xl(r,e,t)}catch(e){await rs(e)}}function vl(r,s,e){const t=r;if(t.isPrimaryClient&&0===e||!t.isPrimaryClient&&1===e){const r=[];t.sc.forEach((e,t)=>{var n=t.view.Ru(s);n.snapshot&&r.push(n.snapshot)}),function(e,n){const t=e;t.onlineState=n;let r=!1;t.queries.forEach((e,t)=>{for(const e of t.listeners)e.Ru(n)&&(r=!0)}),r&&rl(t)}(t.eventManager,s),r.length&&t.nc.zo(r),t.onlineState=s,t.isPrimaryClient&&t.sharedClientState.setOnlineState(s)}}async function wl(e,t){const n=e,r=t.batch.batchId;try{const e=await function(e,r){const s=e;return s.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{const t=r.batch.keys(),n=s.Ki.newChangeBuffer({trackRemovals:!0});return function(e,t,r,s){const i=r.batch,n=i.keys();let a=ss.resolve();return n.forEach(n=>{a=a.next(()=>s.getEntry(t,n)).next(e=>{var t=r.docVersions.get(n);Tr(null!==t),e.version.compareTo(t)<0&&(i.applyToRemoteDocument(e,r),e.isValidDocument()&&(e.setReadTime(r.commitVersion),s.addEntry(e)))})}),a.next(()=>e.mutationQueue.removeMutationBatch(t,i))}(s,e,r,n).next(()=>n.apply(e)).next(()=>s.mutationQueue.performConsistencyCheck(e)).next(()=>s.documentOverlayCache.removeOverlaysForBatchId(e,t,r.batch.batchId)).next(()=>s.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=Ma();for(let n=0;n<e.mutationResults.length;++n)0<e.mutationResults[n].transformResults.length&&(t=t.add(e.batch.mutations[n].key));return t}(r))).next(()=>s.localDocuments.getDocuments(e,t))})}(n.localStore,t);bl(n,r,null),Il(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await xl(n,e)}catch(e){await rs(e)}}function Il(e,t){(e.hc.get(t)||[]).forEach(e=>{e.resolve()}),e.hc.delete(t)}function bl(e,t,n){const r=e;let s=r.ac[r.currentUser.toKey()];if(s){const e=s.get(t);e&&(n?e.reject(n):e.resolve(),s=s.remove(t)),r.ac[r.currentUser.toKey()]=s}}function El(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const r of t.ic.get(e))t.sc.delete(r),n&&t.nc.wc(r,n);t.ic.delete(e),t.isPrimaryClient&&t.cc.hs(e).forEach(e=>{t.cc.containsKey(e)||Tl(t,e)})}function Tl(e,t){e.rc.delete(t.path.canonicalString());var n=e.oc.get(t);null!==n&&(Rh(e.remoteStore,n),e.oc=e.oc.remove(t),e.uc.delete(n),Sl(e))}function _l(e,t,n){for(const r of n)r instanceof cl?(e.cc.addReference(r.key,t),function(e,t){const n=t.key,r=n.path.canonicalString();e.oc.get(n)||e.rc.has(r)||(vr("SyncEngine","New document in limbo: "+n),e.rc.add(r),Sl(e))}(e,r)):r instanceof hl?(vr("SyncEngine","Document no longer in limbo: "+r.key),e.cc.removeReference(r.key,t),e.cc.containsKey(r.key)||Tl(e,r.key)):Er()}function Sl(e){for(;0<e.rc.size&&e.oc.size<e.maxConcurrentLimboResolutions;){var t=e.rc.values().next().value;e.rc.delete(t);var n=new $r(Gr.fromString(t)),t=e.lc.next();e.uc.set(t,new fl(n)),e.oc=e.oc.insert(n,t),kh(e.remoteStore,new nu(ya(la(n.path)),t,2,ps.ct))}}async function xl(e,t,r){const s=e,i=[],a=[],o=[];s.sc.isEmpty()||(s.sc.forEach((e,n)=>{o.push(s.dc(n,t,r).then(e=>{var t;(e||r)&&s.isPrimaryClient&&s.sharedClientState.updateQueryState(n.targetId,null!=e&&e.fromCache?"not-current":"current"),e&&(i.push(e),t=Uc.Di(n.targetId,e),a.push(t))}))}),await Promise.all(o),s.nc.zo(i),await async function(e,t){const r=e;try{await r.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>ss.forEach(t,t=>ss.forEach(t.Vi,e=>r.persistence.referenceDelegate.addReference(n,t.targetId,e)).next(()=>ss.forEach(t.Si,e=>r.persistence.referenceDelegate.removeReference(n,t.targetId,e)))))}catch(e){if(!cs(e))throw e;vr("LocalStore","Failed to update sequence numbers: "+e)}for(const e of t){const t=e.targetId;if(!e.fromCache){const e=r.Li.get(t),n=e.snapshotVersion,s=e.withLastLimboFreeSnapshotVersion(n);r.Li=r.Li.insert(t,s)}}}(s.localStore,a))}async function Dl(r,e){const s=r;if(Nl(s),kl(s),!0===e&&!0!==s.fc){const r=s.sharedClientState.getAllActiveQueryTargets(),e=await Cl(s,r.toArray());s.fc=!0,await $h(s.remoteStore,!0);for(const r of e)kh(s.remoteStore,r)}else if(!1===e&&!1!==s.fc){const r=[];let n=Promise.resolve();s.ic.forEach((e,t)=>{s.sharedClientState.isLocalQueryTarget(t)?r.push(t):n=n.then(()=>(El(s,t),Yc(s.localStore,t,!0))),Rh(s.remoteStore,t)}),await n,await Cl(s,r),function(){const n=s;n.uc.forEach((e,t)=>{Rh(n.remoteStore,t)}),n.cc.ls(),n.uc=new Map,n.oc=new Xs($r.comparator)}(),s.fc=!1,await $h(s.remoteStore,!1)}}async function Cl(t,n){const r=t,s=[],i=[];for(const t of n){let e;const h=r.ic.get(t);if(h&&0!==h.length){e=await Hc(r.localStore,ya(h[0]));for(const t of h){const n=r.sc.get(t),h=(a=r,o=n,c=u=void 0,c=await Xc((u=a).localStore,o.query,!0),c=o.view.Xu(c),u.isPrimaryClient&&_l(u,o.targetId,c.Yu),await c);h.snapshot&&i.push(h.snapshot)}}else{const h=await Jc(r.localStore,t);e=await Hc(r.localStore,h),await gl(r,Al(h),t,!1,e.resumeToken)}s.push(e)}var a,o,u,c;return r.nc.zo(i),s}function Al(e){return ha(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function Nl(e){const t=e;return t.remoteStore.remoteSyncer.applyRemoteEvent=yl.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=(function(e,t){const n=e,r=n.uc.get(t);if(r&&r.ec)return Ma().add(r.key);{let e=Ma();const r=n.ic.get(t);if(!r)return e;for(const t of r){const r=n.sc.get(t);e=e.unionWith(r.view.Qu)}return e}}).bind(null,t),t.remoteStore.remoteSyncer.rejectListen=(async function(e,t,n){const r=e;r.sharedClientState.updateQueryState(t,"rejected",n);const s=r.uc.get(t),i=s&&s.key;if(i){let e=new Xs($r.comparator);e=e.insert(i,Li.newNoDocument(i,qr.min()));const n=Ma().add(i),s=new Io(qr.min(),new Map,new ei(Fr),e,n);await yl(r,s),r.oc=r.oc.remove(i),r.uc.delete(t),Sl(r)}else await Yc(r.localStore,t,!1).then(()=>El(r,t,n)).catch(rs)}).bind(null,t),t.nc.zo=(function(e,t){const n=e;let r=!1;for(const e of t){const t=e.query,s=n.queries.get(t);if(s){for(const t of s.listeners)t.vu(e)&&(r=!0);s.Eu=e}}r&&rl(n)}).bind(null,t.eventManager),t.nc.wc=(function(e,t,n){const r=e,s=r.queries.get(t);if(s)for(const e of s.listeners)e.onError(n);r.queries.delete(t)}).bind(null,t.eventManager),t}function kl(e){const t=e;return t.remoteStore.remoteSyncer.applySuccessfulWrite=wl.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=(async function(e,t,n){const r=e;try{const e=await function(e,r){const s=e;return s.persistence.runTransaction("Reject batch","readwrite-primary",t=>{let n;return s.mutationQueue.lookupMutationBatch(t,r).next(e=>(Tr(null!==e),n=e.keys(),s.mutationQueue.removeMutationBatch(t,e))).next(()=>s.mutationQueue.performConsistencyCheck(t)).next(()=>s.documentOverlayCache.removeOverlaysForBatchId(t,n,r)).next(()=>s.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,n)).next(()=>s.localDocuments.getDocuments(t,n))})}(r.localStore,t);bl(r,t,n),Il(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await xl(r,e)}catch(n){await rs(n)}}).bind(null,t),t}class Rl{constructor(){this.synchronizeTabs=!1}async initialize(e){this.serializer=bh(e.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(e),this.persistence=this.createPersistence(e),await this.persistence.start(),this.localStore=this.createLocalStore(e),this.gcScheduler=this.createGarbageCollectionScheduler(e,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(e,this.localStore)}createGarbageCollectionScheduler(e,t){return null}createIndexBackfillerScheduler(e,t){return null}createLocalStore(e){return Kc(this.persistence,new Gc,e.initialUser,this.serializer)}createPersistence(e){return new kc(Lc.Fs,this.serializer)}createSharedClientState(e){return new hh}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class Ll extends Rl{constructor(e,t,n){super(),this.mc=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.mc.initialize(this,e),await kl(this.mc.syncEngine),await Uh(this.mc.remoteStore),await this.persistence.hi(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}createLocalStore(e){return Kc(this.persistence,new Gc,e.initialUser,this.serializer)}createGarbageCollectionScheduler(e,t){var n=this.persistence.referenceDelegate.garbageCollector;return new uc(n,e.asyncQueue,t)}createIndexBackfillerScheduler(e,t){var n=new gs(t,this.persistence);return new ms(e.asyncQueue,n)}createPersistence(e){var t=qc(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Qu.withCacheSize(this.cacheSizeBytes):Qu.DEFAULT;return new Vc(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,wh(),Ih(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(e){return new hh}}class Ml extends Ll{constructor(e,t){super(e,t,!1),this.mc=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);var t=this.mc.syncEngine;this.sharedClientState instanceof ch&&(this.sharedClientState.syncEngine={$r:(async function(e,t,n,r){var s=e,i=await function(e,n){const r=e,s=r.mutationQueue;return r.persistence.runTransaction("Lookup mutation documents","readonly",t=>s.In(t,n).next(e=>e?r.localDocuments.getDocuments(t,e):ss.resolve(null)))}(s.localStore,t);null!==i?("pending"===n?await Uh(s.remoteStore):"acknowledged"===n||"rejected"===n?(bl(s,t,r||null),Il(s,t),s.localStore.mutationQueue.En(t)):Er(),await xl(s,i)):vr("SyncEngine","Cannot apply mutation batch with id: "+t)}).bind(null,t),Mr:(async function(e,t,n,r){const s=e;if(s.fc)vr("SyncEngine","Ignoring unexpected query state notification.");else{var i=s.ic.get(t);if(i&&0<i.length)switch(n){case"current":case"not-current":{const e=await Zc(s.localStore,_a(i[0])),r=Io.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,ii.EMPTY_BYTE_STRING);await xl(s,e,r);break}case"rejected":await Yc(s.localStore,t,!0),El(s,t,r);break;default:Er()}}}).bind(null,t),Fr:(async function(e,t,n){const r=Nl(e);if(r.fc){for(const e of t)if(r.ic.has(e))vr("SyncEngine","Adding an already active target "+e);else{const t=await Jc(r.localStore,e),n=await Hc(r.localStore,t);await gl(r,Al(t),n.targetId,!1,n.resumeToken),kh(r.remoteStore,n)}for(const e of n)r.ic.has(e)&&await Yc(r.localStore,e,!1).then(()=>{Rh(r.remoteStore,e),El(r,e)}).catch(rs)}}).bind(null,t),bi:(function(e){return e.localStore.persistence.bi()}).bind(null,t),Or:(async function(e,t){const n=e;return Zc(n.localStore,t).then(e=>xl(n,e))}).bind(null,t)},await this.sharedClientState.start()),await this.persistence.hi(async e=>{await Dl(this.mc.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}createSharedClientState(e){var t=wh();if(!ch.D(t))throw new Sr(_r.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");var n=qc(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new ch(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class Ol{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>vl(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=(async function(e,t){const n=e;if(!n.currentUser.isEqual(t)){vr("SyncEngine","User change. New user:",t.toKey());const r=await $c(n.localStore,t);n.currentUser=t,(e=n).hc.forEach(e=>{e.forEach(e=>{e.reject(new Sr(_r.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),e.hc.clear(),n.sharedClientState.handleUserChange(t,r.removedBatchIds,r.addedBatchIds),await xl(n,r.Qi)}}).bind(null,this.syncEngine),await $h(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new el}createDatastore(e){var t,n,r,s,i=bh(e.databaseInfo.databaseId),t=(t=e.databaseInfo,new vh(t));return n=e.authCredentials,r=e.appCheckCredentials,s=t,e=i,new xh(n,r,s,e)}createRemoteStore(e){return t=this.localStore,n=this.datastore,r=e.asyncQueue,s=e=>vl(this.syncEngine,e,0),i=new(dh.D()?dh:lh),new Ch(t,n,r,s,i);var t,n,r,s,i}createSyncEngine(e,t){return function(e,t,n,r,s,i,a){const o=new ml(e,t,n,r,s,i);return a&&(o.fc=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){return async function(e){const t=e;vr("RemoteStore","RemoteStore shutting down."),t.du.add(5),await Nh(t),t._u.shutdown(),t.mu.set("Unknown")}(this.remoteStore)}}function Fl(t,n=10240){let r=0;return{async read(){if(r<t.byteLength){var e={value:t.slice(r,r+n),done:!1};return r+=n,e}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}class Vl{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.gc(this.observer.next,e)}error(e){this.observer.error?this.gc(this.observer.error,e):wr("Uncaught Error in snapshot listener:",e.toString())}yc(){this.muted=!0}gc(e,t){this.muted||setTimeout(()=>{this.muted||e(t)},0)}}class Pl{constructor(e,t){this.Ic=e,this.serializer=t,this.metadata=new xr,this.buffer=new Uint8Array,this.Tc=new TextDecoder("utf-8"),this.Ec().then(e=>{e&&e.ku()?this.metadata.resolve(e.Nu.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==e?void 0:e.Nu)}`))},e=>this.metadata.reject(e))}close(){return this.Ic.cancel()}async getMetadata(){return this.metadata.promise}async _c(){return await this.getMetadata(),this.Ec()}async Ec(){var e=await this.Ac();if(null===e)return null;var t=this.Tc.decode(e),n=Number(t);isNaN(n)&&this.Rc(`length string (${t}) is not valid number`);t=await this.vc(n);return new il(JSON.parse(t),e.length+n)}bc(){return this.buffer.findIndex(e=>e==="{".charCodeAt(0))}async Ac(){for(;this.bc()<0&&!await this.Pc(););if(0===this.buffer.length)return null;var e=this.bc();e<0&&this.Rc("Reached the end of bundle when a length string is expected.");var t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async vc(e){for(;this.buffer.length<e;)await this.Pc()&&this.Rc("Reached the end of bundle when more is expected.");var t=this.Tc.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}Rc(e){throw this.Ic.cancel(),new Error(`Invalid bundle format: ${e}`)}async Pc(){var e=await this.Ic.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class Bl{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),0<this.mutations.length)throw new Sr(_r.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const t=await async function(e,t){const r=e,n=Go(r.serializer)+"/documents",s={documents:t.map(e=>Po(r.serializer,e))},i=await r.fo("BatchGetDocuments",n,s,t.length),a=new Map;i.forEach(e=>{const t=(n=r.serializer,"found"in(e=e)?function(e,t){Tr(!!t.found),t.found.name,t.found.updateTime;var n=Bo(e,t.found.name),r=Oo(t.found.updateTime),s=t.found.createTime?Oo(t.found.createTime):qr.min(),i=new Ri({mapValue:{fields:t.found.fields}});return Li.newFoundDocument(n,r,s,i)}(n,e):"missing"in e?function(e,t){Tr(!!t.missing),Tr(!!t.readTime);var n=Bo(e,t.missing),r=Oo(t.readTime);return Li.newNoDocument(n,r)}(n,e):Er());var n;a.set(t.key.toString(),t)});const o=[];return t.forEach(e=>{var t=a.get(e.toString());Tr(!!t),o.push(t)}),o}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new co(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach(e=>{t.delete(e.key.toString())}),t.forEach((e,t)=>{var n=$r.fromPath(t);this.mutations.push(new ho(n,this.precondition(n)))}),await async function(e,t){const n=e,r=Go(n.serializer)+"/documents",s={writes:t.map(e=>zo(n.serializer,e))};await n.co("Commit",r,s)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw Er();t=qr.min()}var n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new Sr(_r.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(qr.min())?Xa.exists(!1):Xa.updateTime(t):Xa.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(this.writtenDocs.has(e.toString())||!t)return Xa.exists(!0);if(t.isEqual(qr.min()))throw new Sr(_r.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Xa.updateTime(t)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class ql{constructor(e,t,n,r,s){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=s,this.Vc=n.maxAttempts,this.Co=new Eh(this.asyncQueue,"transaction_retry")}run(){--this.Vc,this.Sc()}Sc(){this.Co.Ao(async()=>{const t=new Bl(this.datastore),e=this.Dc(t);e&&e.then(e=>{this.asyncQueue.enqueueAndForget(()=>t.commit().then(()=>{this.deferred.resolve(e)}).catch(e=>{this.Cc(e)}))}).catch(e=>{this.Cc(e)})})}Dc(e){try{var t=this.updateFunction(e);return!ys(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}Cc(e){0<this.Vc&&this.xc(e)?(--this.Vc,this.asyncQueue.enqueueAndForget(()=>(this.Sc(),Promise.resolve()))):this.deferred.reject(e)}xc(e){if("FirebaseError"!==e.name)return!1;var t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!po(t)}}class Ul{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=mr.UNAUTHENTICATED,this.clientId=Or.A(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,async e=>{vr("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(vr("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new Sr(_r.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const n=new xr;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),n.resolve()}catch(e){var t=Hh(e,"Failed to shutdown persistence");n.reject(t)}}),n.promise}}async function Gl(e,t){e.asyncQueue.verifyOperationInProgress(),vr("FirestoreClient","Initializing OfflineComponentProvider");var n=await e.getConfiguration();await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await $c(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e._offlineComponents=t}async function jl(e,n){e.asyncQueue.verifyOperationInProgress();var t=await $l(e);vr("FirestoreClient","Initializing OnlineComponentProvider");var r=await e.getConfiguration();await n.initialize(t,r),e.setCredentialChangeListener(e=>Kh(n.remoteStore,e)),e.setAppCheckTokenChangeListener((e,t)=>Kh(n.remoteStore,t)),e._onlineComponents=n}function Kl(e){return"FirebaseError"===e.name?e.code===_r.FAILED_PRECONDITION||e.code===_r.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code||11===e.code}async function $l(t){if(!t._offlineComponents)if(t._uninitializedComponentsProvider){vr("FirestoreClient","Using user provided OfflineComponentProvider");try{await Gl(t,t._uninitializedComponentsProvider._offline)}catch(e){var n=e;if(!Kl(n))throw n;Ir("Error using user provided cache. Falling back to memory cache: "+n),await Gl(t,new Rl)}}else vr("FirestoreClient","Using default OfflineComponentProvider"),await Gl(t,new Rl);return t._offlineComponents}async function zl(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(vr("FirestoreClient","Using user provided OnlineComponentProvider"),await jl(e,e._uninitializedComponentsProvider._online)):(vr("FirestoreClient","Using default OnlineComponentProvider"),await jl(e,new Ol))),e._onlineComponents}function Ql(e){return $l(e).then(e=>e.persistence)}function Wl(e){return $l(e).then(e=>e.localStore)}function Hl(e){return zl(e).then(e=>e.remoteStore)}function Yl(e){return zl(e).then(e=>e.syncEngine)}async function Xl(e){const t=await zl(e),n=t.eventManager;return n.onListen=(async function(e,t){const n=Nl(e);let r,s;const i=n.sc.get(t);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.tc();else{const e=await Hc(n.localStore,ya(t));n.isPrimaryClient&&kh(n.remoteStore,e);const i=n.sharedClientState.addLocalQueryTarget(e.targetId);r=e.targetId,s=await gl(n,t,r,"current"===i,e.resumeToken)}return s}).bind(null,t.syncEngine),n.onUnlisten=(async function(e,t){const n=e,r=n.sc.get(t),s=n.ic.get(r.targetId);if(1<s.length)return n.ic.set(r.targetId,s.filter(e=>!Ia(e,t))),void n.sc.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await Yc(n.localStore,r.targetId,!1).then(()=>{n.sharedClientState.clearQueryState(r.targetId),Rh(n.remoteStore,r.targetId),El(n,r.targetId)}).catch(rs)):(El(n,r.targetId),await Yc(n.localStore,r.targetId,!0))}).bind(null,t.syncEngine),n}function Jl(e,t,n={}){const r=new xr;return e.asyncQueue.enqueueAndForget(async()=>function(n,r,s,i,a){const e=new Vl({next:e=>{r.enqueueAndForget(()=>nl(n,o));var t=e.docs.has(s);!t&&e.fromCache?a.reject(new Sr(_r.UNAVAILABLE,"Failed to get document because the client is offline.")):t&&e.fromCache&&i&&"server"===i.source?a.reject(new Sr(_r.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):a.resolve(e)},error:e=>a.reject(e)}),o=new sl(la(s.path),e,{includeMetadataChanges:!0,xu:!0});return tl(n,o)}(await Xl(e),e.asyncQueue,t,n,r)),r.promise}function Zl(e,t,n={}){const r=new xr;return e.asyncQueue.enqueueAndForget(async()=>function(t,n,e,r,s){const i=new Vl({next:e=>{n.enqueueAndForget(()=>nl(t,a)),e.fromCache&&"server"===r.source?s.reject(new Sr(_r.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(e)},error:e=>s.reject(e)}),a=new sl(e,i,{includeMetadataChanges:!0,xu:!0});return tl(t,a)}(await Xl(e),e.asyncQueue,t,n,r)),r.promise}function ed(e,t,n,r){const s=(n=n,t=bh(t),i="string"==typeof n?(new TextEncoder).encode(n):n,n=function(e){if(e instanceof Uint8Array)return Fl(e,void 0);if(e instanceof ArrayBuffer)return Fl(new Uint8Array(e),void 0);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(i),t=t,new Pl(n,t));var i;e.asyncQueue.enqueueAndForget(async()=>{!function(e,t,n){const r=e;!async function(t,n,r){try{var s=await n.getMetadata();if(await function(e,t){const n=e,r=Oo(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",e=>n.xs.getBundleMetadata(e,t.id)).then(e=>!!e&&0<=e.createTime.compareTo(r))}(t.localStore,s))return await n.close(),r._completeWith({taskState:"Success",documentsLoaded:s.totalDocuments,bytesLoaded:s.totalBytes,totalDocuments:s.totalDocuments,totalBytes:s.totalBytes}),Promise.resolve(new Set);r._updateProgress(ul(s));const a=new ol(s,t.localStore,n.serializer);let e=await n._c();for(;e;){const t=await a.$u(e);t&&r._updateProgress(t),e=await n._c()}var i=await a.complete();return await xl(t,i.Bu,void 0),await function(e,t){const n=e;return n.persistence.runTransaction("Save bundle","readwrite",e=>n.xs.saveBundleMetadata(e,t))}(t.localStore,s),r._completeWith(i.progress),Promise.resolve(i.Fu)}catch(t){return Ir("SyncEngine",`Loading bundle failed with ${t}`),r._failWith(t),Promise.resolve(new Set)}}(r,t,n).then(e=>{r.sharedClientState.notifyBundleLoaded(e)})}(await Yl(e),s,r)})}const td=new Map;function nd(e,t,n){if(!n)throw new Sr(_r.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function rd(e,t,n,r){if(!0===t&&!0===r)throw new Sr(_r.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function sd(e){if(!$r.isDocumentKey(e))throw new Sr(_r.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function id(e){if($r.isDocumentKey(e))throw new Sr(_r.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function ad(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return 20<e.length&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"!=typeof e)return"function"==typeof e?"a function":Er();if(e instanceof Array)return"an array";var t=(e=e).constructor?e.constructor.name:null;return t?`a custom ${t} object`:"an object"}function od(e,t){if((e="_delegate"in e?e._delegate:e)instanceof t)return e;if(t.name===e.constructor.name)throw new Sr(_r.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");var n=ad(e);throw new Sr(_r.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}function ud(e,t){if(t<=0)throw new Sr(_r.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class cd{constructor(e){var t;if(void 0===e.host){if(void 0!==e.ssl)throw new Sr(_r.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.cache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new Sr(_r.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.useFetchStreams=!!e.useFetchStreams,rd("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling)}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class hd{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new cd({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new Sr(_r.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new Sr(_r.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new cd(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new Cr;switch(e.type){case"firstParty":return new Rr(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new Sr(_r.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=td.get(e);t&&(vr("ComponentProvider","Removing Datastore"),td.delete(e),t.terminate())}(this),Promise.resolve()}}function ld(n,e,t,r={}){var s;const i=(n=od(n,hd))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==e&&Ir("Host has been set in both settings() and useEmulator(), emulator host will be used"),n._setSettings(Object.assign(Object.assign({},i),{host:`${e}:${t}`,ssl:!1})),r.mockUserToken){let e,t;if("string"==typeof r.mockUserToken)e=r.mockUserToken,t=mr.MOCK_USER;else{e=function(e,t){if(e.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');var n=t||"demo-project",r=e.iat||0,s=e.sub||e.user_id;if(!s)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");return s=Object.assign({iss:`https://securetoken.google.com/${n}`,aud:n,iat:r,exp:r+3600,auth_time:r,sub:s,user_id:s,firebase:{sign_in_provider:"custom",identities:{}}},e),[a(JSON.stringify({alg:"none",type:"JWT"})),a(JSON.stringify(s)),""].join(".")}(r.mockUserToken,null===(s=n._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new Sr(_r.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");t=new mr(i)}n._authCredentials=new Ar(new Dr(e,t))}}class dd{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new md(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new dd(this.firestore,e,this._key)}}class fd{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new fd(this.firestore,e,this._query)}}class md extends fd{constructor(e,t,n){super(e,t,la(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new dd(this.firestore,null,new $r(e))}withConverter(e){return new md(this.firestore,e,this._path)}}function gd(e,t,...n){if(e=g(e),nd("collection","path",t),e instanceof hd){var r=Gr.fromString(t,...n);return id(r),new md(e,null,r)}if(!(e instanceof dd||e instanceof md))throw new Sr(_r.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");r=e._path.child(Gr.fromString(t,...n));return id(r),new md(e.firestore,null,r)}function pd(e,t,...n){if(e=g(e),nd("doc","path",t=1===arguments.length?Or.A():t),e instanceof hd){var r=Gr.fromString(t,...n);return sd(r),new dd(e,null,new $r(r))}if(!(e instanceof dd||e instanceof md))throw new Sr(_r.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");r=e._path.child(Gr.fromString(t,...n));return sd(r),new dd(e.firestore,e instanceof md?e.converter:null,new $r(r))}function yd(e,t){return e=g(e),t=g(t),(e instanceof dd||e instanceof md)&&(t instanceof dd||t instanceof md)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function vd(e,t){return e=g(e),t=g(t),e instanceof fd&&t instanceof fd&&e.firestore===t.firestore&&Ia(e._query,t._query)&&e.converter===t.converter}class wd{constructor(){this.Nc=Promise.resolve(),this.kc=[],this.Oc=!1,this.$c=[],this.Mc=null,this.Fc=!1,this.Bc=!1,this.Lc=[],this.Co=new Eh(this,"async_queue_retry"),this.qc=()=>{var e=Ih();e&&vr("AsyncQueue","Visibility state changed to "+e.visibilityState),this.Co.vo()};const e=Ih();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.qc)}get isShuttingDown(){return this.Oc}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Uc(),this.Kc(e)}enterRestrictedMode(e){if(!this.Oc){this.Oc=!0,this.Bc=e||!1;const t=Ih();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.qc)}}enqueue(e){if(this.Uc(),this.Oc)return new Promise(()=>{});const t=new xr;return this.Kc(()=>this.Oc&&this.Bc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.kc.push(e),this.Gc()))}async Gc(){if(0!==this.kc.length){try{await this.kc[0](),this.kc.shift(),this.Co.reset()}catch(e){if(!cs(e))throw e;vr("AsyncQueue","Operation failed with retryable error: "+e)}0<this.kc.length&&this.Co.Ao(()=>this.Gc())}}Kc(e){var t=this.Nc.then(()=>(this.Fc=!0,e().catch(e=>{throw this.Mc=e,this.Fc=!1,wr("INTERNAL UNHANDLED ERROR: ",function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e)),e}).then(e=>(this.Fc=!1,e))));return this.Nc=t}enqueueAfterDelay(e,t,n){this.Uc(),-1<this.Lc.indexOf(e)&&(t=0);var r=Wh.createAndSchedule(this,e,t,n,e=>this.Qc(e));return this.$c.push(r),r}Uc(){this.Mc&&Er()}verifyOperationInProgress(){}async zc(){for(var e;await(e=this.Nc),e!==this.Nc;);}jc(e){for(const t of this.$c)if(t.timerId===e)return!0;return!1}Wc(t){return this.zc().then(()=>{this.$c.sort((e,t)=>e.targetTimeMs-t.targetTimeMs);for(const e of this.$c)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.zc()})}Hc(e){this.Lc.push(e)}Qc(e){var t=this.$c.indexOf(e);this.$c.splice(t,1)}}function Id(e){return function(e){if("object"==typeof e&&null!==e){var t=e;for(const e of["next","error","complete"])if(e in t&&"function"==typeof t[e])return 1}}(e)}class bd{constructor(){this._progressObserver={},this._taskCompletionResolver=new xr,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}var Ed,Td,_d;class Sd extends hd{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new wd,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||Dd(this),this._firestoreClient.terminate()}}function xd(e){return e._firestoreClient||Dd(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function Dd(e){var t,n,r,s,i,a=e._freezeSettings(),o=(n=e._databaseId,r=(null===(o=e._app)||void 0===o?void 0:o.options.appId)||"",s=e._persistenceKey,i=a,new di(n,r,s,i.host,i.ssl,i.experimentalForceLongPolling,i.experimentalAutoDetectLongPolling,i.useFetchStreams));e._firestoreClient=new Ul(e._authCredentials,e._appCheckCredentials,e._queue,o),null!==(o=a.cache)&&void 0!==o&&o._offlineComponentProvider&&null!==(t=a.cache)&&void 0!==t&&t._onlineComponentProvider&&(e._firestoreClient._uninitializedComponentsProvider={_offlineKind:a.cache.kind,_offline:a.cache._offlineComponentProvider,_online:a.cache._onlineComponentProvider})}function Cd(e,t,n){const r=new xr;return e.asyncQueue.enqueue(async()=>{try{await Gl(e,n),await jl(e,t),r.resolve()}catch(e){const t=e;if(!Kl(t))throw t;Ir("Error enabling indexeddb cache. Falling back to memory cache: "+t),r.reject(t)}}).then(()=>r.promise)}function Ad(e){return function(e){const t=new xr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t){const n=e;Vh(n.remoteStore)||vr("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(){const t=n.localStore;return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e))}();if(-1===e)return void t.resolve();const r=n.hc.get(e)||[];r.push(t),n.hc.set(e,r)}catch(e){const n=Hh(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await Yl(e),t)),t.promise}(xd(e=od(e,Sd)))}function Nd(e){return(n=xd(e=od(e,Sd))).asyncQueue.enqueue(async()=>{const e=await Ql(n),t=await Hl(n);return e.setNetworkEnabled(!0),function(){const e=t;return e.du.delete(0),Ah(e)}()});var n}function kd(e){return(n=xd(e=od(e,Sd))).asyncQueue.enqueue(async()=>{const e=await Ql(n),t=await Hl(n);return e.setNetworkEnabled(!1),async function(){const e=t;e.du.add(0),await Nh(e),e.mu.set("Offline")}()});var n}function Rd(t,e){return n=xd(t=od(t,Sd)),r=e,n.asyncQueue.enqueue(async()=>function(e,t){const n=e;return n.persistence.runTransaction("Get named query","readonly",e=>n.xs.getNamedQuery(e,t))}(await Wl(n),r)).then(e=>e?new fd(t,null,e.query):null);var n,r}function Ld(e){if(e._initialized||e._terminated)throw new Sr(_r.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class Md{constructor(e){this._byteString=e}static fromBase64String(e){try{return new Md(ii.fromBase64String(e))}catch(e){throw new Sr(_r.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new Md(ii.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class Od{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new Sr(_r.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Kr(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class Fd{constructor(e){this._methodName=e}}class Vd{constructor(e,t){if(!isFinite(e)||e<-90||90<e)throw new Sr(_r.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||180<t)throw new Sr(_r.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return Fr(this._lat,e._lat)||Fr(this._long,e._long)}}const Pd=/^__.*__$/;class Bd{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new io(e,this.data,this.fieldMask,t,this.fieldTransforms):new so(e,this.data,t,this.fieldTransforms)}}class qd{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new io(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function Ud(e){switch(e){case 0:case 2:case 1:return 1;case 3:case 4:return;default:throw Er()}}class Gd{constructor(e,t,n,r,s,i){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===s&&this.Jc(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get Yc(){return this.settings.Yc}Zc(e){return new Gd(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Xc(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.Zc({path:n,ta:!1});return r.ea(e),r}na(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.Zc({path:n,ta:!1});return r.Jc(),r}sa(e){return this.Zc({path:void 0,ta:!0})}ia(e){return cf(e,this.settings.methodName,this.settings.ra||!1,this.path,this.settings.oa)}contains(t){return void 0!==this.fieldMask.find(e=>t.isPrefixOf(e))||void 0!==this.fieldTransforms.find(e=>t.isPrefixOf(e.field))}Jc(){if(this.path)for(let e=0;e<this.path.length;e++)this.ea(this.path.get(e))}ea(e){if(0===e.length)throw this.ia("Document fields must not be empty");if(Ud(this.Yc)&&Pd.test(e))throw this.ia('Document fields cannot begin and end with "__"')}}class jd{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||bh(e)}ua(e,t,n,r=!1){return new Gd({Yc:e,methodName:t,oa:n,path:Kr.emptyPath(),ta:!1,ra:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function Kd(e){var t=e._freezeSettings(),n=bh(e._databaseId);return new jd(e._databaseId,!!t.ignoreUndefinedProperties,n)}function $d(e,t,n,r,s,i={}){const a=e.ua(i.merge||i.mergeFields?2:0,t,n,s);sf("Data must be an object, but it was:",a,r);var o=nf(r,a);let u,c;if(i.merge)u=new ri(a.fieldMask),c=a.fieldTransforms;else if(i.mergeFields){const e=[];for(const r of i.mergeFields){const s=af(t,r,n);if(!a.contains(s))throw new Sr(_r.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);hf(e,s)||e.push(s)}u=new ri(e),c=a.fieldTransforms.filter(e=>u.covers(e.field))}else u=null,c=a.fieldTransforms;return new Bd(new Ri(o),u,c)}class zd extends Fd{_toFieldTransform(e){if(2!==e.Yc)throw 1===e.Yc?e.ia(`${this._methodName}() can only appear at the top level of your update data`):e.ia(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof zd}}function Qd(e,t,n){return new Gd({Yc:3,oa:t.settings.oa,methodName:e._methodName,ta:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class Wd extends Fd{_toFieldTransform(e){return new Ha(e.path,new Ua)}isEqual(e){return e instanceof Wd}}class Hd extends Fd{constructor(e,t){super(e),this.ca=t}_toFieldTransform(e){const t=Qd(this,e,!0),n=this.ca.map(e=>tf(e,t)),r=new Ga(n);return new Ha(e.path,r)}isEqual(e){return this===e}}class Yd extends Fd{constructor(e,t){super(e),this.ca=t}_toFieldTransform(e){const t=Qd(this,e,!0),n=this.ca.map(e=>tf(e,t)),r=new Ka(n);return new Ha(e.path,r)}isEqual(e){return this===e}}class Xd extends Fd{constructor(e,t){super(e),this.aa=t}_toFieldTransform(e){var t=new za(e.serializer,Pa(e.serializer,this.aa));return new Ha(e.path,t)}isEqual(e){return this===e}}function Jd(e,s,i,t){const a=e.ua(1,s,i);sf("Data must be an object, but it was:",a,t);const o=[],u=Ri.empty();Hs(t,(e,t)=>{var n=uf(s,e,i);t=g(t);var r=a.na(n);if(t instanceof zd)o.push(n);else{const e=tf(t,r);null!=e&&(o.push(n),u.set(n,e))}});var n=new ri(o);return new qd(u,n,a.fieldTransforms)}function Zd(e,t,n,r,s,i){const a=e.ua(1,t,n),o=[af(t,r,n)],u=[s];if(i.length%2!=0)throw new Sr(_r.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let f=0;f<i.length;f+=2)o.push(af(t,i[f])),u.push(i[f+1]);const c=[],h=Ri.empty();for(let m=o.length-1;0<=m;--m)if(!hf(c,o[m])){const t=o[m];var l=g(l=u[m]);const r=a.na(t);if(l instanceof zd)c.push(t);else{const e=tf(l,r);null!=e&&(c.push(t),h.set(t,e))}}var d=new ri(c);return new qd(h,d,a.fieldTransforms)}function ef(e,t,n,r=!1){return tf(n,e.ua(r?4:3,t))}function tf(i,e){if(rf(i=g(i)))return sf("Unsupported field value:",e,i),nf(i,e);if(i instanceof Fd)return function(e,t){if(!Ud(t.Yc))throw t.ia(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.ia(`${e._methodName}() is not currently supported inside arrays`);var n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(i,e),null;if(void 0===i&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),i instanceof Array){if(e.settings.ta&&4!==e.Yc)throw e.ia("Nested arrays are not supported");return function(t){const n=[];let r=0;for(const s of i){let e=tf(s,t.sa(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e)}return function(e,t){if(null===(e=g(i)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return Pa(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){var n=Br.fromDate(e);return{timestampValue:Lo(t.serializer,n)}}if(e instanceof Br){n=new Br(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:Lo(t.serializer,n)}}if(e instanceof Vd)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof Md)return{bytesValue:Mo(t.serializer,e._byteString)};if(e instanceof dd){const r=t.databaseId,s=e.firestore._databaseId;if(!s.isEqual(r))throw t.ia(`Document reference is for database ${s.projectId}/${s.database} but should be for database ${r.projectId}/${r.database}`);return{referenceValue:Fo(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t.ia(`Unsupported field value: ${ad(e)}`)}(0,e)}function nf(e,r){const s={};return Ys(e)?r.path&&0<r.path.length&&r.fieldMask.push(r.path):Hs(e,(e,t)=>{var n=tf(t,r.Xc(e));null!=n&&(s[e]=n)}),{mapValue:{fields:s}}}function rf(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof Br||e instanceof Vd||e instanceof Md||e instanceof dd||e instanceof Fd)}function sf(e,t,n){if(!rf(n)||("object"!=typeof(s=n)||null===s||Object.getPrototypeOf(s)!==Object.prototype&&null!==Object.getPrototypeOf(s))){var r=ad(n);throw"an object"===r?t.ia(e+" a custom object"):t.ia(e+" "+r)}var s}function af(e,t,n){if((t=g(t))instanceof Od)return t._internalPath;if("string"==typeof t)return uf(e,t);throw cf("Field path arguments must be of type string or ",e,!1,void 0,n)}const of=new RegExp("[~\\*/\\[\\]]");function uf(t,n,r){if(0<=n.search(of))throw cf(`Invalid field path (${n}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,r);try{return new Od(...n.split("."))._internalPath}catch(e){throw cf(`Invalid field path (${n}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,r)}}function cf(e,t,n,r,s){var i=r&&!r.isEmpty(),a=void 0!==s;let o=`Function ${t}() called with invalid data`;n&&(o+=" (via `toFirestore()`)"),o+=". ";let u="";return(i||a)&&(u+=" (found",i&&(u+=` in field ${r}`),a&&(u+=` in document ${s}`),u+=")"),new Sr(_r.INVALID_ARGUMENT,o+e+u)}function hf(e,t){return e.some(e=>e.isEqual(t))}class lf{constructor(e,t,n,r,s){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new dd(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){var e=new df(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){var t=this._document.data.field(ff("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class df extends lf{data(){return super.data()}}function ff(e,t){return"string"==typeof t?uf(e,t):(t instanceof Od?t:t._delegate)._internalPath}function mf(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new Sr(_r.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class gf{}class pf extends gf{}function yf(e,t,...n){let r=[];t instanceof gf&&r.push(t),r=r.concat(n),function(e){var t=e.filter(e=>e instanceof wf).length,n=e.filter(e=>e instanceof vf).length;if(1<t||0<t&&0<n)throw new Sr(_r.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(const t of r)e=t._apply(e);return e}class vf extends pf{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new vf(e,t,n)}_apply(e){var t=this._parse(e);return Df(e._query,t),new fd(e.firestore,e.converter,va(e._query,t))}_parse(e){var t=Kd(e.firestore);return function(e,t,n,r,s,i,a){let o;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new Sr(_r.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){xf(a,i);const t=[];for(const n of a)t.push(Sf(r,e,n));o={arrayValue:{values:t}}}else o=Sf(r,e,a)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||xf(a,i),o=ef(n,t,a,"in"===i||"not-in"===i);return Bi.create(s,i,o)}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value)}}class wf extends gf{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new wf(e,t)}_parse(t){var e=this._queryConstraints.map(e=>e._parse(t)).filter(e=>0<e.getFilters().length);return 1===e.length?e[0]:qi.create(e,this._getOperator())}_apply(e){const n=this._parse(e);return 0===n.getFilters().length?e:(function(e){let t=e;for(const e of n.getFlattenedFilters())Df(t,e),t=va(t,e)}(e._query),new fd(e.firestore,e.converter,va(e._query,n)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class If extends pf{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new If(e,t)}_apply(e){var t=function(e,t,n){if(null!==e.startAt)throw new Sr(_r.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new Sr(_r.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");var r,s=new Vi(t,n);return n=s,null!==fa(e=e)||null!==(r=ma(e))&&Cf(0,r,n.field),s}(e._query,this._field,this._direction);return new fd(e.firestore,e.converter,(e=e._query,t=e.explicitOrderBy.concat([t]),new ca(e.path,e.collectionGroup,t,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)))}}class bf extends pf{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new bf(e,t,n)}_apply(e){return new fd(e.firestore,e.converter,wa(e._query,this._limit,this._limitType))}}class Ef extends pf{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new Ef(e,t,n)}_apply(e){var t,n=_f(e,this.type,this._docOrFields,this._inclusive);return new fd(e.firestore,e.converter,(t=e._query,e=n,new ca(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)))}}class Tf extends pf{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new Tf(e,t,n)}_apply(e){var t,n=_f(e,this.type,this._docOrFields,this._inclusive);return new fd(e.firestore,e.converter,(t=e._query,e=n,new ca(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)))}}function _f(e,t,n,r){if(n[0]=g(n[0]),n[0]instanceof lf)return function(e,t,n,r,s){if(!r)throw new Sr(_r.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of pa(e))if(n.field.isKeyField())i.push(Ei(t,r.key));else{const e=r.data.field(n.field);if(hi(e))throw new Sr(_r.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=n.field.canonicalString();throw new Sr(_r.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}i.push(e)}return new Mi(i,s)}(e._query,e.firestore._databaseId,t,n[0]._document,r);var s=Kd(e.firestore);return function(e,t,n,r,s,i){const a=e.explicitOrderBy;if(s.length>a.length)throw new Sr(_r.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const o=[];for(let u=0;u<s.length;u++){const c=s[u];if(a[u].field.isKeyField()){if("string"!=typeof c)throw new Sr(_r.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof c}`);if(!ga(e)&&-1!==c.indexOf("/"))throw new Sr(_r.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${c}' contains a slash.`);const n=e.path.child(Gr.fromString(c));if(!$r.isDocumentKey(n))throw new Sr(_r.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new $r(n);o.push(Ei(t,s))}else{const e=ef(n,r,c);o.push(e)}}return new Mi(o,i)}(e._query,e.firestore._databaseId,s,t,n,r)}function Sf(e,t,n){if("string"==typeof(n=g(n))){if(""===n)throw new Sr(_r.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!ga(t)&&-1!==n.indexOf("/"))throw new Sr(_r.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);var r=t.path.child(Gr.fromString(n));if(!$r.isDocumentKey(r))throw new Sr(_r.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Ei(e,new $r(r))}if(n instanceof dd)return Ei(e,n._key);throw new Sr(_r.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${ad(n)}.`)}function xf(e,t){if(!Array.isArray(e)||0===e.length)throw new Sr(_r.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function Df(e,t){if(t.isInequality()){const r=ma(e),s=t.field;if(null!==r&&!r.isEqual(s))throw new Sr(_r.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${r.toString()}' and '${s.toString()}'`);var n=fa(e);null!==n&&Cf(0,s,n)}const r=function(e,t){for(const n of e)for(const e of n.getFlattenedFilters())if(0<=t.indexOf(e.op))return e.op;return null}(e.filters,function(){switch(t.op){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}());if(null!==r)throw r===t.op?new Sr(_r.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new Sr(_r.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${r.toString()}' filters.`)}function Cf(e,t,n){if(!n.isEqual(t))throw new Sr(_r.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${t.toString()}' and so you must also use '${t.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class Af{convertValue(e,t="none"){switch(pi(e)){case 0:return null;case 1:return e.booleanValue;case 2:return ui(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(ci(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw Er()}}convertObject(e,n){const r={};return Hs(e.fields,(e,t)=>{r[e]=this.convertValue(t,n)}),r}convertGeoPoint(e){return new Vd(ui(e.latitude),ui(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":var n=function e(t){var n=t.mapValue.fields.__previous_value__;return hi(n)?e(n):n}(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(li(e));default:return null}}convertTimestamp(e){var t=oi(e);return new Br(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=Gr.fromString(e);Tr(tu(n));const r=new fi(n.get(1),n.get(3)),s=new $r(n.popFirst(5));return r.isEqual(t)||wr(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function Nf(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}class kf extends Af{constructor(e){super(),this.firestore=e}convertBytes(e){return new Md(e)}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new dd(this.firestore,null,t)}}class Rf{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Lf extends lf{constructor(e,t,n,r,s,i){super(e,t,n,r,i),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){var t=new Mf(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){var n=this._document.data.field(ff("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class Mf extends Lf{data(e={}){return super.data(e)}}class Of{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new Rf(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,n){this._snapshot.docs.forEach(e=>{t.call(n,new Mf(this._firestore,this._userDataWriter,e.key,e,new Rf(this._snapshot.mutatedKeys.has(e.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){var t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new Sr(_r.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(i,t){if(i._snapshot.oldDocs.isEmpty()){let n=0;return i._snapshot.docChanges.map(e=>{var t=new Mf(i._firestore,i._userDataWriter,e.doc.key,e.doc,new Rf(i._snapshot.mutatedKeys.has(e.doc.key),i._snapshot.fromCache),i.query.converter);return e.doc,{type:"added",doc:t,oldIndex:-1,newIndex:n++}})}{let s=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(e=>t||3!==e.type).map(e=>{var t=new Mf(i._firestore,i._userDataWriter,e.doc.key,e.doc,new Rf(i._snapshot.mutatedKeys.has(e.doc.key),i._snapshot.fromCache),i.query.converter);let n=-1,r=-1;return 0!==e.type&&(n=s.indexOf(e.doc.key),s=s.delete(e.doc.key)),1!==e.type&&(s=s.add(e.doc),r=s.indexOf(e.doc.key)),{type:function(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return Er()}}(e.type),doc:t,oldIndex:n,newIndex:r}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function Ff(e,t){return e instanceof Lf&&t instanceof Lf?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof Of&&t instanceof Of&&e._firestore===t._firestore&&vd(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}class Vf extends Af{constructor(e){super(),this.firestore=e}convertBytes(e){return new Md(e)}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new dd(this.firestore,null,t)}}function Pf(t){t=od(t,dd);const n=od(t.firestore,Sd),e=xd(n),r=new Vf(n);return function(e,t){const n=new xr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const s=await function(t){const n=e;return n.persistence.runTransaction("read document","readonly",e=>n.localDocuments.getDocument(e,t))}(t);s.isFoundDocument()?n.resolve(s):s.isNoDocument()?n.resolve(null):n.reject(new Sr(_r.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){var r=Hh(e,`Failed to get document '${t} from cache`);n.reject(r)}}(await Wl(e),t,n)),n.promise}(e,t._key).then(e=>new Lf(n,r,t._key,e,new Rf(null!==e&&e.hasLocalMutations,!0),t.converter))}function Bf(t){t=od(t,fd);const n=od(t.firestore,Sd),e=xd(n),r=new Vf(n);return function(e,t){const n=new xr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const s=await Xc(e,t,!0),i=new ll(t,s.Wi),a=i.zu(s.documents),o=i.applyChanges(a,!1);n.resolve(o.snapshot)}catch(e){var r=Hh(e,`Failed to execute query '${t} against cache`);n.reject(r)}}(await Wl(e),t,n)),n.promise}(e,t._query).then(e=>new Of(n,r,t,e))}function qf(e,t,n){e=od(e,dd);var r=od(e.firestore,Sd),s=Nf(e.converter,t,n);return Kf(r,[$d(Kd(r),"setDoc",e._key,s,null!==e.converter,n).toMutation(e._key,Xa.none())])}function Uf(e,t,n,...r){e=od(e,dd);var s=od(e.firestore,Sd),i=Kd(s);let a;return a="string"==typeof(t=g(t))||t instanceof Od?Zd(i,"updateDoc",e._key,t,n,r):Jd(i,"updateDoc",e._key,t),Kf(s,[a.toMutation(e._key,Xa.exists(!0))])}function Gf(t,...n){var e;t=g(t);let r={includeMetadataChanges:!1},s=0;"object"!=typeof n[s]||Id(n[s])||(r=n[s],s++);var i={includeMetadataChanges:r.includeMetadataChanges};if(Id(n[s])){const t=n[s];n[s]=null===(e=t.next)||void 0===e?void 0:e.bind(t),n[s+1]=null===(e=t.error)||void 0===e?void 0:e.bind(t),n[s+2]=null===(e=t.complete)||void 0===e?void 0:e.bind(t)}let a,o,u;if(t instanceof dd)o=od(t.firestore,Sd),u=la(t._key.path),a={next:e=>{n[s]&&n[s]($f(o,t,e))},error:n[s+1],complete:n[s+2]};else{const c=od(t,fd);o=od(c.firestore,Sd),u=c._query;const h=new Vf(o);a={next:e=>{n[s]&&n[s](new Of(o,h,c,e))},error:n[s+1],complete:n[s+2]},mf(t._query)}return function(e,t,n,r){const s=new Vl(r),i=new sl(t,s,n);return e.asyncQueue.enqueueAndForget(async()=>tl(await Xl(e),i)),()=>{s.yc(),e.asyncQueue.enqueueAndForget(async()=>nl(await Xl(e),i))}}(xd(o),u,i,a)}function jf(e,t){return function(e,t){const n=new Vl(t);return e.asyncQueue.enqueueAndForget(async()=>function(e,t){e.Au.add(t),t.next()}(await Xl(e),n)),()=>{n.yc(),e.asyncQueue.enqueueAndForget(async()=>function(e,t){e.Au.delete(t)}(await Xl(e),n))}}(xd(e=od(e,Sd)),Id(t)?t:{next:t})}function Kf(e,t){return function(e,t){const n=new xr;return e.asyncQueue.enqueueAndForget(async()=>pl(await Yl(e),t,n)),n.promise}(xd(e),t)}function $f(e,t,n){var r=n.docs.get(t._key),s=new Vf(e);return new Lf(e,s,t._key,r,new Rf(n.hasPendingWrites,n.fromCache),t.converter)}const zf={maxAttempts:5};class Qf{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=Kd(e)}set(e,t,n){this._verifyNotCommitted();const r=Wf(e,this._firestore),s=Nf(r.converter,t,n),i=$d(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,Xa.none())),this}update(e,t,n,...r){this._verifyNotCommitted();var s=Wf(e,this._firestore);let i;return i="string"==typeof(t=g(t))||t instanceof Od?Zd(this._dataReader,"WriteBatch.update",s._key,t,n,r):Jd(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(i.toMutation(s._key,Xa.exists(!0))),this}delete(e){this._verifyNotCommitted();var t=Wf(e,this._firestore);return this._mutations=this._mutations.concat(new co(t._key,Xa.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,0<this._mutations.length?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new Sr(_r.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function Wf(e,t){if((e=g(e)).firestore!==t)throw new Sr(_r.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class Hf extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=Kd(e)}get(e){const n=Wf(e,this._firestore),r=new kf(this._firestore);return this._transaction.lookup([n._key]).then(e=>{if(!e||1!==e.length)return Er();const t=e[0];if(t.isFoundDocument())return new lf(this._firestore,r,t.key,t,n.converter);if(t.isNoDocument())return new lf(this._firestore,r,n._key,null,n.converter);throw Er()})}set(e,t,n){var r=Wf(e,this._firestore),s=Nf(r.converter,t,n),s=$d(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,s),this}update(e,t,n,...r){var s=Wf(e,this._firestore),i="string"==typeof(t=g(t))||t instanceof Od?Zd(this._dataReader,"Transaction.update",s._key,t,n,r):Jd(this._dataReader,"Transaction.update",s._key,t);return this._transaction.update(s._key,i),this}delete(e){var t=Wf(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=Wf(e,this._firestore),n=new Vf(this._firestore);return super.get(e).then(e=>new Lf(this._firestore,n,t._key,e._document,new Rf(!1,!1),t.converter))}}function Yf(t,n,e){t=od(t,Sd);var r=Object.assign(Object.assign({},zf),e);return function(){if(r.maxAttempts<1)throw new Sr(_r.INVALID_ARGUMENT,"Max attempts must be at least 1")}(),function(t,n,r){const s=new xr;return t.asyncQueue.enqueueAndForget(async()=>{var e=await zl(t).then(e=>e.datastore);new ql(t.asyncQueue,e,r,n,s).run()}),s.promise}(xd(t),e=>n(new Hf(t,e)),r)}Ed=Tm.SDK_VERSION,gr=Ed,Tm._registerComponent(new p("firestore",(e,{instanceIdentifier:t,options:n})=>{const r=e.getProvider("app").getImmediate(),s=new Sd(new Nr(e.getProvider("auth-internal")),new Mr(e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new Sr(_r.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new fi(e.options.projectId,t)}(r,t),r);return n=Object.assign({useFetchStreams:!0},n),s._setSettings(n),s},"PUBLIC").setMultipleInstances(!0)),Tm.registerVersion(fr,"3.10.1",void 0),Tm.registerVersion(fr,"3.10.1","esm2017");function Xf(e,t){if(void 0===t)return{merge:!1};if(void 0!==t.mergeFields&&void 0!==t.merge)throw new Sr("invalid-argument",`Invalid options passed to function ${e}(): You cannot `+'specify both "merge" and "mergeFields".');return t}function Jf(){if("undefined"==typeof Uint8Array)throw new Sr("unimplemented","Uint8Arrays are not available in this environment.")}function Zf(){if("undefined"==typeof atob)throw new Sr("unimplemented","Blobs are unavailable in Firestore in this environment.")}class em{constructor(e){this._delegate=e}static fromBase64String(e){return Zf(),new em(Md.fromBase64String(e))}static fromUint8Array(e){return Jf(),new em(Md.fromUint8Array(e))}toBase64(){return Zf(),this._delegate.toBase64()}toUint8Array(){return Jf(),this._delegate.toUint8Array()}isEqual(e){return this._delegate.isEqual(e._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}}function tm(e){return function(e,t){if("object"!=typeof e||null===e)return;var n=e;for(const r of t)if(r in n&&"function"==typeof n[r])return 1;return}(e,["next","error","complete"])}class nm{enableIndexedDbPersistence(e,t){return function(e,t){Ld(e=od(e,Sd));var n=xd(e);if(n._uninitializedComponentsProvider)throw new Sr(_r.FAILED_PRECONDITION,"SDK cache is already specified.");Ir("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");var r=e._freezeSettings(),s=new Ol;return Cd(n,s,new Ll(s,r.cacheSizeBytes,null==t?void 0:t.forceOwnership))}(e._delegate,{forceOwnership:t})}enableMultiTabIndexedDbPersistence(e){return function(e){Ld(e=od(e,Sd));var t=xd(e);if(t._uninitializedComponentsProvider)throw new Sr(_r.FAILED_PRECONDITION,"SDK cache is already specified.");Ir("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");var n=e._freezeSettings(),r=new Ol;return Cd(t,r,new Ml(r,n.cacheSizeBytes))}(e._delegate)}clearIndexedDbPersistence(e){return function(e){if(e._initialized&&!e._terminated)throw new Sr(_r.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new xr;return e._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{await async function(e){if(!as.D())return Promise.resolve();var t=e+"main";await as.delete(t)}(qc(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}}),t.promise}(e._delegate)}}class rm{constructor(e,t,n){this._delegate=t,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},e instanceof fi||(this._appCompat=e)}get _databaseId(){return this._delegate._databaseId}settings(e){var t=this._delegate._getSettings();e.merge||t.host===e.host||Ir("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),e.merge&&delete(e=Object.assign(Object.assign({},t),e)).merge,this._delegate._setSettings(e)}useEmulator(e,t,n={}){ld(this._delegate,e,t,n)}enableNetwork(){return Nd(this._delegate)}disableNetwork(){return kd(this._delegate)}enablePersistence(e){let t=!1,n=!1;return e&&(t=!!e.synchronizeTabs,n=!!e.experimentalForceOwningTab,rd("synchronizeTabs",t,"experimentalForceOwningTab",n)),t?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return Ad(this._delegate)}onSnapshotsInSync(e){return jf(this._delegate,e)}get app(){if(!this._appCompat)throw new Sr("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(e){try{return new ym(this,gd(this._delegate,e))}catch(e){throw cm(e,"collection()","Firestore.collection()")}}doc(e){try{return new um(this,pd(this._delegate,e))}catch(e){throw cm(e,"doc()","Firestore.doc()")}}collectionGroup(e){try{return new mm(this,function(e,t){if(e=od(e,hd),nd("collectionGroup","collection id",t),0<=t.indexOf("/"))throw new Sr(_r.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new fd(e,null,(t=t,new ca(Gr.emptyPath(),t)))}(this._delegate,e))}catch(e){throw cm(e,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(t){return Yf(this._delegate,e=>t(new im(this,e)))}batch(){return xd(this._delegate),new am(new Qf(this._delegate,e=>Kf(this._delegate,e)))}loadBundle(e){return t=this._delegate,e=e,n=xd(t=od(t,Sd)),r=new bd,ed(n,t._databaseId,e,r),r;var t,n,r}namedQuery(e){return Rd(this._delegate,e).then(e=>e?new mm(this,e):null)}}class sm extends Af{constructor(e){super(),this.firestore=e}convertBytes(e){return new em(new Md(e))}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return um.forKey(t,this.firestore,null)}}class im{constructor(e,t){this._firestore=e,this._delegate=t,this._userDataWriter=new sm(e)}get(e){const t=vm(e);return this._delegate.get(t).then(e=>new dm(this._firestore,new Lf(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,t.converter)))}set(e,t,n){var r=vm(e);return n?(Xf("Transaction.set",n),this._delegate.set(r,t,n)):this._delegate.set(r,t),this}update(e,t,n,...r){var s=vm(e);return 2===arguments.length?this._delegate.update(s,t):this._delegate.update(s,t,n,...r),this}delete(e){var t=vm(e);return this._delegate.delete(t),this}}class am{constructor(e){this._delegate=e}set(e,t,n){var r=vm(e);return n?(Xf("WriteBatch.set",n),this._delegate.set(r,t,n)):this._delegate.set(r,t),this}update(e,t,n,...r){var s=vm(e);return 2===arguments.length?this._delegate.update(s,t):this._delegate.update(s,t,n,...r),this}delete(e){var t=vm(e);return this._delegate.delete(t),this}commit(){return this._delegate.commit()}}class om{constructor(e,t,n){this._firestore=e,this._userDataWriter=t,this._delegate=n}fromFirestore(e,t){var n=new Mf(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,null);return this._delegate.fromFirestore(new fm(this._firestore,n),null!=t?t:{})}toFirestore(e,t){return t?this._delegate.toFirestore(e,t):this._delegate.toFirestore(e)}static getInstance(e,t){const n=om.INSTANCES;let r=n.get(e);r||(r=new WeakMap,n.set(e,r));let s=r.get(t);return s||(s=new om(e,new sm(e),t),r.set(t,s)),s}}om.INSTANCES=new WeakMap;class um{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new sm(e)}static forPath(e,t,n){if(e.length%2!=0)throw new Sr("invalid-argument","Invalid document reference. Document references must have an even number of segments, but "+`${e.canonicalString()} has ${e.length}`);return new um(t,new dd(t._delegate,n,new $r(e)))}static forKey(e,t,n){return new um(t,new dd(t._delegate,n,e))}get id(){return this._delegate.id}get parent(){return new ym(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(e){try{return new ym(this.firestore,gd(this._delegate,e))}catch(e){throw cm(e,"collection()","DocumentReference.collection()")}}isEqual(e){return(e=g(e))instanceof dd&&yd(this._delegate,e)}set(e,t){t=Xf("DocumentReference.set",t);try{return t?qf(this._delegate,e,t):qf(this._delegate,e)}catch(e){throw cm(e,"setDoc()","DocumentReference.set()")}}update(e,t,...n){try{return 1===arguments.length?Uf(this._delegate,e):Uf(this._delegate,e,t,...n)}catch(e){throw cm(e,"updateDoc()","DocumentReference.update()")}}delete(){return Kf(od((e=this._delegate).firestore,Sd),[new co(e._key,Xa.none())]);var e}onSnapshot(...e){var t=hm(e),n=lm(e,e=>new dm(this.firestore,new Lf(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)));return Gf(this._delegate,t,n)}get(e){let t;return t=("cache"===(null==e?void 0:e.source)?Pf:"server"===(null==e?void 0:e.source)?function(t){t=od(t,dd);const n=od(t.firestore,Sd);return Jl(xd(n),t._key,{source:"server"}).then(e=>$f(n,t,e))}:function(t){t=od(t,dd);const n=od(t.firestore,Sd);return Jl(xd(n),t._key).then(e=>$f(n,t,e))})(this._delegate),t.then(e=>new dm(this.firestore,new Lf(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)))}withConverter(e){return new um(this.firestore,e?this._delegate.withConverter(om.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function cm(e,t,n){return e.message=e.message.replace(t,n),e}function hm(e){for(const t of e)if("object"==typeof t&&!tm(t))return t;return{}}function lm(e,t){var n;let r;return r=tm(e[0])?e[0]:tm(e[1])?e[1]:"function"==typeof e[0]?{next:e[0],error:e[1],complete:e[2]}:{next:e[1],error:e[2],complete:e[3]},{next:e=>{r.next&&r.next(t(e))},error:null===(n=r.error)||void 0===n?void 0:n.bind(r),complete:null===(n=r.complete)||void 0===n?void 0:n.bind(r)}}class dm{constructor(e,t){this._firestore=e,this._delegate=t}get ref(){return new um(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(e){return this._delegate.data(e)}get(e,t){return this._delegate.get(e,t)}isEqual(e){return Ff(this._delegate,e._delegate)}}class fm extends dm{data(e){var t=this._delegate.data(e);return void 0!==t||Er(),t}}class mm{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new sm(e)}where(e,t,n){try{return new mm(this.firestore,yf(this._delegate,(r=n,s=t,i=ff("where",e),vf._create(i,s,r))))}catch(e){throw cm(e,/(orderBy|where)\(\)/,"Query.$1()")}var r,s,i}orderBy(e,t){try{return new mm(this.firestore,yf(this._delegate,([n,r="asc"]=[e,t],s=r,i=ff("orderBy",n),If._create(i,s))))}catch(e){throw cm(e,/(orderBy|where)\(\)/,"Query.$1()")}var n,r,s,i}limit(e){try{return new mm(this.firestore,yf(this._delegate,(ud("limit",t=e),bf._create("limit",t,"F"))))}catch(e){throw cm(e,"limit()","Query.limit()")}var t}limitToLast(e){try{return new mm(this.firestore,yf(this._delegate,(ud("limitToLast",t=e),bf._create("limitToLast",t,"L"))))}catch(e){throw cm(e,"limitToLast()","Query.limitToLast()")}var t}startAt(...e){try{return new mm(this.firestore,yf(this._delegate,function(...e){return Ef._create("startAt",e,!0)}(...e)))}catch(e){throw cm(e,"startAt()","Query.startAt()")}}startAfter(...e){try{return new mm(this.firestore,yf(this._delegate,function(...e){return Ef._create("startAfter",e,!1)}(...e)))}catch(e){throw cm(e,"startAfter()","Query.startAfter()")}}endBefore(...e){try{return new mm(this.firestore,yf(this._delegate,function(...e){return Tf._create("endBefore",e,!1)}(...e)))}catch(e){throw cm(e,"endBefore()","Query.endBefore()")}}endAt(...e){try{return new mm(this.firestore,yf(this._delegate,function(...e){return Tf._create("endAt",e,!0)}(...e)))}catch(e){throw cm(e,"endAt()","Query.endAt()")}}isEqual(e){return vd(this._delegate,e._delegate)}get(e){let t;return t=("cache"===(null==e?void 0:e.source)?Bf:"server"===(null==e?void 0:e.source)?function(t){t=od(t,fd);const n=od(t.firestore,Sd),e=xd(n),r=new Vf(n);return Zl(e,t._query,{source:"server"}).then(e=>new Of(n,r,t,e))}:function(t){t=od(t,fd);const n=od(t.firestore,Sd),e=xd(n),r=new Vf(n);return mf(t._query),Zl(e,t._query).then(e=>new Of(n,r,t,e))})(this._delegate),t.then(e=>new pm(this.firestore,new Of(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)))}onSnapshot(...e){var t=hm(e),n=lm(e,e=>new pm(this.firestore,new Of(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)));return Gf(this._delegate,t,n)}withConverter(e){return new mm(this.firestore,e?this._delegate.withConverter(om.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}class gm{constructor(e,t){this._firestore=e,this._delegate=t}get type(){return this._delegate.type}get doc(){return new fm(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}}class pm{constructor(e,t){this._firestore=e,this._delegate=t}get query(){return new mm(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(e=>new fm(this._firestore,e))}docChanges(e){return this._delegate.docChanges(e).map(e=>new gm(this._firestore,e))}forEach(t,n){this._delegate.forEach(e=>{t.call(n,new fm(this._firestore,e))})}isEqual(e){return Ff(this._delegate,e._delegate)}}class ym extends mm{constructor(e,t){super(e,t),this.firestore=e,this._delegate=t}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){var e=this._delegate.parent;return e?new um(this.firestore,e):null}doc(e){try{return void 0===e?new um(this.firestore,pd(this._delegate)):new um(this.firestore,pd(this._delegate,e))}catch(e){throw cm(e,"doc()","CollectionReference.doc()")}}add(e){return function(e,t){const n=od(e.firestore,Sd),r=pd(e),s=Nf(e.converter,t);return Kf(n,[$d(Kd(e.firestore),"addDoc",r._key,s,null!==e.converter,{}).toMutation(r._key,Xa.exists(!1))]).then(()=>r)}(this._delegate,e).then(e=>new um(this.firestore,e))}isEqual(e){return yd(this._delegate,e._delegate)}withConverter(e){return new ym(this.firestore,e?this._delegate.withConverter(om.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function vm(e){return od(e,dd)}const wm={Firestore:rm,GeoPoint:Vd,Timestamp:Br,Blob:em,Transaction:im,WriteBatch:am,DocumentReference:um,DocumentSnapshot:dm,Query:mm,QueryDocumentSnapshot:fm,QuerySnapshot:pm,CollectionReference:ym,FieldPath:class Im{constructor(...e){this._delegate=new Od(...e)}static documentId(){return new Im(Kr.keyField().canonicalString())}isEqual(e){return(e=g(e))instanceof Od&&this._delegate._internalPath.isEqual(e._internalPath)}},FieldValue:class bm{constructor(e){this._delegate=e}static serverTimestamp(){const e=new Wd("serverTimestamp");return e._methodName="FieldValue.serverTimestamp",new bm(e)}static delete(){const e=new zd("deleteField");return e._methodName="FieldValue.delete",new bm(e)}static arrayUnion(...e){const t=function(...e){return new Hd("arrayUnion",e)}(...e);return t._methodName="FieldValue.arrayUnion",new bm(t)}static arrayRemove(...e){const t=function(...e){return new Yd("arrayRemove",e)}(...e);return t._methodName="FieldValue.arrayRemove",new bm(t)}static increment(e){const t=new Xd("increment",e);return t._methodName="FieldValue.increment",new bm(t)}isEqual(e){return this._delegate.isEqual(e._delegate)}},setLogLevel:function(e){e=e,pr.setLogLevel(e)},CACHE_SIZE_UNLIMITED:-1};Td=t.default,_d=(e,t)=>new rm(e,t,new nm),Td.INTERNAL.registerComponent(new p("firestore-compat",e=>{var t=e.getProvider("app-compat").getImmediate(),n=e.getProvider("firestore").getImmediate();return _d(t,n)},"PUBLIC").setServiceProps(Object.assign({},wm))),Td.registerVersion("@firebase/firestore-compat","0.3.7")}).apply(this,arguments)}catch(e){throw console.error(e),new Error("Cannot instantiate firebase-firestore-compat.js - be sure to load firebase-app.js first.")}});
//# sourceMappingURL=firebase-firestore-compat.js.map
